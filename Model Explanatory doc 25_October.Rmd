---
title: "Climate financial bubbles: How market sentiments shape the transition to low-carbon capital"
author: "Emanuele Campiglio, Elena Dawkins, Antoine Godin, Eric Kemp-Benedict"
date: '`r format(Sys.time(), "%d %B %Y")`'
output:
  pdf_document:
    number_sections: yes
    toc: yes
  html_document:
    toc: yes
    toc_depth: 3
subtitle: "Detailed documentation and model code"
pandoc_args: ["inline_notes"]
documentclass: report
---

```{r setup, include=FALSE, purl=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval=FALSE, tidy=TRUE, tidy.opts=list(width.cutoff=75))
```

########################################################### 
# Terminology and notation
########################################################### 

This document provides a detailed description of the model used to generate the results in the paper 'Climate financial bubbles: How market sentiments shape the transition to low-carbon capital'. The report is implemented as an R markdown file, and can be used both as model source code and as the source for a PDF or HTML formatted report. Running the model requires an installation of R, as well as the R package PK-SFC (downloadle here: https://github.com/S120/PKSFC).

The formal mathematical model is referred to as 'the model', while its implementation using the R package PK-SFC is referred to as 'the code'. Within the code, a standard set of notational conventions are followed:

* Uppercase: nominal values; lowercase: real values
* `varname` + `e`: either an expected future value or the price of an equity
* `varname` + `mean`: a four-period average of historical values
* `varname` + `gr`: the prior (or lagged) one-period growth rate
* `varname` + `w` or `f`: household-specific variables:
    + `w`: wage-earners
    + `f`: financial investors
* `varname` + `c`, `h`, `l` or `b`: sector-specific variables:
    + `c`: consumption goods
	  + `h`: high-carbon capital
	  + `l`: low-carbon capital
	  + `b`: banks

We often present a formal analytical version of expressions. In order to do so, we indicate a generic productive sector by $x\in{c,h,l}$, and a generic capital sector with $y\in{h,l}$.

The use of `mean` in the code is indicated in the model by an overbar, where the average is taken over the previous four periods. For an arbitrary variable $x$,
$$\bar{x} \equiv \frac{1}{4}\sum_{t=-4}^{-1} x_t$$
Growth rates are estimated as a one-period rate of change relative to the value at the start of the period. Growth rates appear in the code with a suffix `gr`, and are indicated in the model by a 'hat'. Depending on the variable, growth rates may be calculated either over the previous time step or lagged by one time step. For an abitrary variable $x$,
$$\hat{x} \equiv \frac{x - x_{-1}}{x_{-1}}\quad\mathrm{or}\quad\frac{x_{-1} - x_{-2}}{x_{-2}}$$

########################################################### 
# Time and transition
########################################################### 

Time is tracked by a variable $t$, which increments by one in each time step,
```{r}
#START MODEL
t=t(-1)+1
```

The model starts from a stationary state with only the consumption and the high-carbon capital sectors. At time `n+1`, defined as `initLowCarb`, the low-carbon capital sector comes into existence. This is the period where the low-carbon sector buys high-carbon capital goods but does not produce anything yet. The next period, ending at period `n+2`, called `firstPeriodLowcarb`, is the first period where low-carbon capital goods are produced. We define `lowcarbExisting` as the time range in which the low-carbon sector exists (i.e. produces capital goods).

```{r}
initLowCarb=(t==(n+1))
firstPeriodLowcarb=(t==(n+2))
lowcarbExisting=(t>(n+1))
```

After a period of time denoted as `entry` (treated as a parameter), the low-carbon sector enters the financial market via an Initial Public Offering (IPO). The delay is necessary because the low-carbon sector is assumed to be too small to attract finance in its first periods of existence. Model experiments have shown that if the low-carbon sector tries to enter the financial market too soon it hurts them because they can't raise enough money via the IPO and thus are over-indebted. We define `beforeIPO` as the time range between the birth of the low-carbon sector and its entrance into financial markets.

```{r}
beforeIPO=(t<=(n+entry)&(t>(n+1)))
```

Investors exit the high-carbon capital goods sector as soon as either: a) production of high-carbon capital stock goes to zero; b) profits generated by the sector go to zero; c) the price of its equities go to zero. These conditions are defined as `exith`. We define `hasExited` as the time range after the high-carbon sector has defaulted. 

```{r}
exith=ifelse(exith(-1)==1,1,ifelse(yh==0|Fh<0|phe<=0,1,0))
hasExited=(exith(-1)==1)
```


For several variables, expectations are formed through an adaptive process. A common term in each of these expressions takes historical growth into account when anticipating future growth. The historical average growth rate is multiplied by a parameter $\eta$ (`eta`), which is zero if historical growth is ignored when forming expectations and one if anticipated future growth is equal to historical average growth.


########################################################### 
# Production{#production}
########################################################### 


## Output
Total real output in sector $x$, $y_x$, is given by aggregate demand. This is equal to consumption demand from both workers ($c_w$) and financial investors ($c_f$) in the case of consumption good $y_c$, and to investment demand (`invltot`and `invhtot`) in the case of investment.

```{r}
yc=cf+cw
yl=invltot
yh=invhtot
```

It should be noted that, despite being demand-led, the model also takes supply constraints into considerations: 

* Constraints in the supply of labour are completely absorbed by the consumption sector  (see [Section \ref{employment}](#employment)); 
* Supply constraints in capital are also absorbed by the consumption sector as capital stocks are available for sale after the production sector has kept what is needed for their investment decisions (see [Section \ref{conssectorinvestment}](#conssectorinvestment));
* Constraints in the supply of consumption good are distributed proportionally to each consumption decision by the two types of households (see [Section \ref{consumption}](#consumption)).

Nominal output $Y_x$ is given by real output multiplied by the current price,
```{r}
Yc=yc*pc
Yl=yl*pkl
Yh=yh*pkh
```


Expected real output is given by an adaptive expectations model of the form
$$y_x^e = \left(1 + \eta\widehat{y}_x\right)\overline{y}_x + \epsilon \left(y_{x,-1}-y_{x,-1}^e\right)$$
```{r}
yce = ycmean + ycmean*ycgr*eta+epsilon * (yc(-1) - yce(-1))
yle = ifelse(lowcarbExisting, ylmean + ylmean*ylgr*eta + epsilon * (yl(-1) - yle(-1)), 0)
yhe = ifelse(hasExited, 0, yhmean + yhmean*yhgr*eta + epsilon * (yh(-1) - yhe(-1)))
```

Output growth rates and four-period averages are computed as:
```{r}
ycgr = ifelse(yc(-2) == 0, 0, (yc(-1) - yc(-2))/yc(-2))
ylgr = ifelse(yl(-2) == 0, 0, (yl(-1) - yl(-2))/yl(-2))
yhgr = ifelse(yh(-2) == 0, 0, (yh(-1) - yh(-2))/yh(-2))
ycmean = mean(c(yc(-4), yc(-3), yc(-2), yc(-1)))
ylmean = mean(c(yl(-4), yl(-3), yl(-2), yl(-1)))
yhmean = mean(c(yh(-4), yh(-3), yh(-2), yh(-1)))
```


## Capital stocks
Two types of (real) capital stocks exist: high-carbon capital ($k_{h}$) and low-carbon capital ($k_{l}$). The consumption good sector typically employs both ($k_{hc}$ and $k_{lc}$). The high-carbon capital sector only employs high-carbon capital ($k_{hh}$). The low-carbon capital sector would only employ low-carbon capital ($k_{ll}$) but in its first period of operation needs to employ high-carbon capital because it is the only one available ($k_{hl}$). The change in stocks is given by new real investment $i_{xh}$ and $i_{xl}$, net of depreciation. For capital of type $y\in\lbrace h,l\rbrace$,
$$k_{yx} = k_{yx,-1} + i_{xy} - d(k_{yx})$$
Taking into account the fact that low-carbon capital is not used by the high-carbon capital goods sector, and ensuring that the sector is active, in the model code the corresponding equations are
```{r}
khc=khc(-1)+invch-depkhc
khl=khl(-1)+invlh-depkhl
khh=ifelse(hasExited,0,khh(-1)+invhh-depkhh)
klc=klc(-1)+invcl-depklc
kll=kll(-1)+invll-depkll
```

The growth rate of each type of capital in each sector is calculated as follows, 
```{r}
khcgr=ifelse(khc(-1)==0,0,(khc-khc(-1))/khc(-1))
khhgr=ifelse(khh(-1)==0,0,(khh-khh(-1))/khh(-1))
khlgr=ifelse(khl(-1)==0,0,(khl-khl(-1))/khl(-1))
klcgr=ifelse(klc(-1)==0,0,(klc-klc(-1))/klc(-1))
kllgr=ifelse(kll(-1)==0,0,(kll-kll(-1))/kll(-1))
```

We also calculate  aggregate capital stock growth rates for total capital present in the consumption sector (`totkcgr`), total capital present in the high-carbon capital good sector (`totkhgr`), total capital present in the low-carbon capital good sector (`totklgr`), total capital in the entire capital good sector (high-carbon + low-carbon) (`totkgr`), and the sum of high-carbon capital in the high-carbon sector and low-carbon-capital in the low-carbon sector (`totkhhllgr`), 

```{r}
totkcgr=ifelse(khc(-1)+klc(-1)==0,0,(khc+klc-khc(-1)-klc(-1))/(khc(-1)+klc(-1)))
totkhgr=khhgr
totklgr=ifelse(khl(-1)+kll(-1)==0,0,(khl+kll-khl(-1)-kll(-1))/(khl(-1)+kll(-1)))
totkgr=ifelse(khh(-1)+khl(-1)+kll(-1)==0,0,(khh+khl+kll-khh(-1)-khl(-1)-kll(-1))/(khh(-1)+khl(-1)+kll(-1)))
totkhhllgr = ifelse(khh(-1) + kll(-1) == 0, 0, (khh + kll - khh(-1) - kll(-1))/(khh(-1) + kll(-1)))
```


## Capacity utilisation

Utilization $u_x$ in sector $x$ is the ratio between actual real output and  potential real output using previous period capital stock and their productivities ($\xi_h$ and $\xi_l$ in the model and `prkh` and `prkl` in the code),
$$u_x = \frac{y_x}{\xi_h k_{hx,-1} + \xi_l k_{lx,-1}}$$
```{r}
uc=yc/(khc(-1)*prkh +klc(-1)*prkl)
ul=ifelse(lowcarbExisting,yl/(khl(-1)*prkh+kll(-1)*prkl),0)
uh=ifelse(hasExited,0,yh/(khh(-1)*prkh))
```

Expected utilization is given by an equivalent expression, but in terms of potential output,
```{r}
uce=yce/(khc(-1)*prkh+klc(-1)*prkl)
ule=ifelse(lowcarbExisting,(yle/(kll(-1)*prkl+khl(-1)*prkh)),0)
uhe=ifelse(hasExited,0,yhe/(khh(-1)*prkh))
```

Within each sector there are also utilization rates for each type of capital in each sector. As a first step, utilization of low-carbon capital is computed. We assume that those sectors using low-carbon capital (i.e. the consumption and low-carbon capital sectors) will employ it fully if possible, so the core expression is

$$u_{l,x} = \frac{y_x}{\xi_l k_{lx,-1}}$$

Making sure that the capacity utilisation rates are in the range between 0 and 1, and that low-carbon capital is already being produced, the expressions are
```{r}
ulc=ifelse(klc(-1)==0, 0, max(0,min(1,yc/(prkl*klc(-1)))))
ull=ifelse(lowcarbExisting&kll(-1)!=0, max(0,min(1,yl/(prkl*kll(-1)))),0)
```

Expected values are computed using similar equations, but using expected output instead of actual output,
```{r}
ulce=ifelse(klc(-1)==0, 0,min(yce/(prkl*klc(-1)),1))
ulle=ifelse(lowcarbExisting&kll(-1)!=0,min(yle/(prkl*kll(-1)),1),0)
```

Next, utilization of high-carbon capital is computed as a residual. Generically, it is given by
$$u_{h,x} = \frac{y_x - u_{l,x}\xi_l k_{lx,-1}}{\xi_h k_{hx,-1}}$$

With checks to ensure that the capital utilisation rate is at leat 0 and that high-carbon capital is actually in use, and keeping in mind that the high-carbon capital goods sector only uses high-carbon capital, the expressions are
```{r}
uhc=ifelse(khc(-1)>0,max(0,(yc-ulc*prkl*klc(-1))/(prkh*khc(-1))),0)
uhl=ifelse(lowcarbExisting&khl(-1)!=0,max(0,(yl-ull*prkl*kll(-1))/(prkh*khl(-1))),0)
uhh=ifelse(hasExited,0,yh/(prkh*khh(-1)))
```

Expectations are given by similar expressions, using expected output instead of actual one and adding the fact that expected capital utilisation rate are at most 100%
```{r}
uhce=ifelse(khc(-1)>0,min((yce-ulce*prkl*klc(-1))/(prkh*khc(-1)),1),0)
uhle=ifelse(lowcarbExisting&khl(-1)!=0,max(0,min((yle-ulle*prkl*kll(-1))/(prkh*khl(-1)),1),0),0)
uhhe=ifelse(hasExited,0,yhe/(prkh*khh(-1)))
```


## Employment{#employment}

Labor is employed in all three productive sectors. The capital-to-labor ratio for high-carbon and low-carbon capital in sector $x$ are denoted $\ell_{hx}$ and $\ell_{lx}$ (`caplabratiohx` and `caplabratiolx` in the code). The general expression for employment $N_x$ in sector $x$ is the sum of utilization times capital stock divided by the capital-to-labor ratio for both high-carbon and low-carbon capital,
$$N_x = u_{l,x}\frac{k_{lx,-1}}{\ell_{lx}} + u_{h,x}\frac{k_{hx,-1}}{\ell_{hx}}$$

Additional conditions ensure that employment is zero in the low-carbon sector before it starts producing, while employment is zero in the high-carbon capital goods sector once it has stopped operations. Also, only high-carbon capital is ever used in the high-carbon capital goods sector,
```{r}
Nc=ulc*klc(-1)/caplabratiolc + uhc*khc(-1)/caplabratiohc
Nl=ifelse(lowcarbExisting,ull*kll(-1)/caplabratioll+uhl*khl(-1)/caplabratiohl,0)
Nh=ifelse(hasExited,0,uhh*khh(-1)/caplabratiohh)
```

The maximum level of employment is given by a similar expression, but with utilization set equal to one,
$$N_{x,\mathrm{max}} = \frac{k_{lx,-1}}{\ell_{lx}} + \frac{k_{hx,-1}}{\ell_{hx}}$$
In the code, the maximum level of employment is computed only for the consumption goods sector, because we assume that it's the only sector which will absorb the supply constraints on the labor market
```{r}
Ncmax=klc(-1)/caplabratiolc + khc(-1)/caplabratiohc
```


Total employment is the sum of employment in each sector,
$$N_\text{tot} = N_c + N_h + N_l$$
```{r}
Ntot=Nc+Nh+Nl
```

The size of the labor force is set as an exogenous parameter, $LF$. The employment rate is then total employment divided by the labor force, $N_\text{tot}/LF$.

Average labor productivity in sector $x$, $\overline{A}^N_x$ (denoted `Aprc`, `Aprh` and `Aprl` in the code) is given by real output from the sector, $y_x$, divided by sector employment,
$$\overline{A}^N_x = \frac{y_x}{N_x}$$
After first ensuring that low-carbon and high-carbon capital are in use, this is represented in code by
```{r}
Aprc=yc/Nc
Aprl=ifelse(Nl>0,yl/Nl,0.001)
Aprh=ifelse(!hasExited&Nh>0,yh/Nh,0)
```

## Pricing of goods{#pricing}

### Pricing dynamics

Prices are set via a target-return markup. The calculation of the markup $\upsilon_x$ in sector $x$ given the target return is described below (see [Section \ref{markups}](#markups)). Once it is computed, it is combined with smoothed expected unit costs $\text{NUC}_x$ to calculate the price as
$$p_x = p_{x,-1} + \zeta\left[\left(1 + \upsilon_x\right)\text{NUC}_x - p_{x,-1}\right]$$
With checks that the sector is active, this is given in code by
```{r}
pc=pc(-1)+zeta*((1+upsilonc)*NUCc-pc(-1))
pkl=ifelse(initLowCarb,(1+upsilonl)*NUCl,pkl(-1)+zeta*((1+upsilonl)*NUCl-pkl(-1)))
pkh=ifelse(hasExited,pkh(-1),pkh(-1)+zeta*((1+upsilonh)*NUCh-pkh(-1)))
```

### Unit costs
In this economy, unit costs are labor costs. Current-period unit costs are computed as the ratio of the nominal wage bill to realized output, taking capital utilization into account. The nominal wage bill is given by the unit wage $W_x$ multiplied by labor employed to operate both high-carbon or low-carbon capital, $u_{hx}k_{hx,-1}/\ell_{hx} + u_{lx}k_{lx}/\ell_{lx}$. Total output is given by utilization multiplied by capital productivity multiplied by the capital stock for each type of capital, and then summed. So, unit costs are
$$\text{UC}_x = \frac{W_x}{u_{hx}\xi_{hx}k_{hx,-1}+u_{lx}\xi_l k_{lx,-1}}\left(\frac{u_{hx}k_{hx,-1}}{\ell_{hx}} + \frac{u_{lx}k_{lx,-1}}{\ell_{lx}}\right)$$
Note that as the high-capital sector uses only high-carbon capital, this collapses to $UC_h = W_h/\ell_{hh}$.

In the code, terms are rearranged to form the equivalent expression
$$\text{UC}_x = W_x\frac{u_{hx}k_{hx,-1}\ell_{lx} + u_{lx}k_{lx,-1}\ell_{hx}}{\left(u_{hx}\xi_{hx}k_{hx,-1} + u_{lx}\xi_l k_{lx,-1}\right) \ell_{hx}\ell_{lx}}$$
With checks for whether the sector is operating, the expressions are
```{r}
UCc=Wc*(ulc*klc(-1)*caplabratiohc+uhc*khc(-1)*caplabratiolc)/((uhc*prkh*khc(-1) +ulc*prkl*klc(-1))*caplabratiolc*caplabratiohc)
UCl=ifelse(lowcarbExisting,Wl*(ull*kll(-1)*caplabratiohl+uhl*khl(-1)*caplabratioll)/((uhl*prkh*khl(-1)+ull*prkl*kll(-1))*caplabratioll*caplabratiohl),0)
UCh=ifelse(!hasExited&invhtot>0,Wh/(prkh*caplabratiohh),0)
```

Expected unit costs in the next period $\text{UC}^e_x$ are given by an equivalent expression but using expected utilization.
```{r}
UChe=ifelse(hasExited,0,Wh(-1)/(prkh*caplabratiohh))
UCle=ifelse(initLowCarb|firstPeriodLowcarb,Wl/(prkh*caplabratiohl),ifelse(khl(-1)==0&kll(-1)==0,0,Wl(-1)*(ulle*kll(-1)*caplabratiohl+uhle*khl(-1)*caplabratioll)/((uhle*prkh*khl(-1)+ulle*prkl*kll(-1))*caplabratioll*caplabratiohl)))
UCce=Wc(-1)*(ulce*klc(-1)*caplabratiohc+uhce*khc(-1)*caplabratiolc)/((uhce*prkh*khc(-1)+ulce*prkl*klc(-1))*caplabratiolc*caplabratiohc)
```
Finally, normal unit costs, which firms use for pricing, are given by smoothed expected unit costs, through an adaptive expectations model
$$\text{NUC}_x = \text{NUC}_{x,-1} + \zeta\left(\text{UC}^e_x - \text{NUC}_{x,-1}\right)$$
```{r}
NUCh=ifelse(hasExited,0,NUCh(-1)+zeta*(UChe-NUCh(-1)))
NUCl=ifelse(initLowCarb|firstPeriodLowcarb,UCle,NUCl(-1)+zeta*(UCle-NUCl(-1)))
NUCc=NUCc(-1)+zeta*(UCce-NUCc(-1))
```


### Markups{#markups}
Markups $\upsilon_x$ are set to achieve a target return on capital, where capital is valued at replacement cost. For sector $x$ this is denoted $r_x^T$ (or `rxT` in the code). The generic expression is
$$\upsilon_x = r_x^T \frac{p_{kh}k_{h,-1} + p_{kl}k_{l,-1}}{\text{NUC}_x y_x^e}$$
If actual output meets expectations, and unit costs match smoothed expectations, then when this markup is applied to total unit costs it will give a return $r_x^T$ when divided by the value of the capital stock from the previous period. Checking for the special conditions in the first period of operation of the low-carbon capital goods sector, ensuring the sector is operating, and noting that only high-carbon capital is used in the high-carbon capital goods sector, the equations are
```{r}
upsilonl=ifelse(firstPeriodLowcarb,rlT*pkh/(NUCl*prkh),ifelse(NUCl==0|yle==0,0,rlT*(pkh(-1)*khl(-1)+pkl(-1)*kll(-1))/(NUCl*yle)))
upsilonc=rcT*(pkh(-1)*khc(-1) +pkl(-1)*klc(-1))/(NUCc*yce)
upsilonh=ifelse(hasExited,0,rhT*(pkh(-1)*khh(-1))/(UChe*yhe))
```

### Inflation rate
Price inflation is given by the growth rate relative to the previous period,
$$\pi = \frac{p - p_{-1}}{p_{-1}}$$
After checking that the price is defined, the equations in the model code are
```{r}
pic=(pc-pc(-1))/pc(-1)
pikl=ifelse(pkl(-1)==0,0,(pkl-pkl(-1))/pkl(-1))
pikh=ifelse(hasExited,0,(pkh-pkh(-1))/pkh(-1))
```
The consumption goods sector uses both low-carbon and high-carbon capital in multiple periods, so inflation in the cost of capital  is calculated using a Laspeyers index, or the weighted average of the inflation rates for each type of capital,
```{r}
pickhl=(khc(-1)*pikh + klc(-1)*pikl)/(khc(-1)+ klc(-1))
```





########################################################### 
# Financial wealth{#financial-wealth}
########################################################### 


## Financial assets

Two main types of financial assets exist in the model: money and equities. 

Since no physical cash exists in the model, money supply is entirely made of bank deposits. Total money in the system is $M_s$, the sum of the bank deposits of wage-earners, $M_w$, financial investors, $M_f$, and productive sectors $M_c$, $M_h$ and $M_l$.
```{r}
Ms=Mw+Mf+Mc+Mh+Ml
```

Equities are issued by firms in all the three productive sectors ($e_c$, $e_h$ and $e_l$). Each sector has a fixed number of shares. For the low-carbon sector there are no shares prior to the IPO; at time n+entry 100 shares are issued,
```{r}
el=ifelse(t<(n+entry), 0, 100)
```


## Households' wealth{#hh-wealth}

There are two types of households in the model, wage and profit earners. For each, we use the Haig-Simons definition of income, $Y_\mathrm{hs}$, which is the sum of consumption, $C$, and the change in wealth, $\Delta V$,
$$Y_\mathrm{hs} = C + \Delta V$$

In the code we reverse this definition to solve for wealth, $V$, as
$$V = V_{-1} + (Y_\mathrm{hs} - C) + \text{change in value of assets}$$

Both wage-earning households and financial investors hold financial wealth, denoted as $V_w$ and $V_f$. For each, financial wealth includes previous period wealth plus disposable income net of consumption. For financial investors, capital gains $CG$ are also considered(see [Section \ref{capgains}](#capgains)), as well as a `bailout' term linked to the loss of value when stranded assets are marked down (presented in [Section \ref{dividends}](#dividends)),
```{r}
Vw=Vw(-1)+(YDw-Cw)
Vf=Vf(-1)+(YDf-Cf)+CG-bailout
```

Real wealth is nominal wealth deflated by the cost of consumption goods,
```{r}
vf=Vf/pc
vw=Vw/pc
```


Wage earners hold their entire financial wealth in the form of bank deposits. Banks do not pay interest on the deposits of wage-earners and do not issue them loans, so wage-earners' money holdings are passive.
```{r}
Mw=Vw
```

Financial investors can allocate their wealth across money holdings ($M_f$), as well as the equities available on financial markets. Wealth allocation by financial investors is dealt with in Section \ref{financial-investments}.

Expected wealth of financial investors in the next period is calculated with expected disposable income and no anticipated capital gains or losses from writing off stranded assets,
```{r}
Vfe=Vf(-1) + YDfe - Cf
```


## Money holdings by firms{#money-firms}

Firms's bank balances $M_x$ increase when they receive profits ($F_x$), and decrease when dividends ($FD_x$) are distributed or when retained earnings are used to finance investments. The total money available is thus
$$M_{x} = M_{x,-1} + F_{x}-RE_{x}-FD_{x}$$

In code, these are:
```{r}
Mh=ifelse(exith(-1)!=1&invhtot>0,Mh(-1)+Fh-REh-FDh,0)
Ml=Ml(-1)+Fl-REl-FDl
Mc=Mc(-1)+Fc-REc-FDc
```



## Capital gains{#capgains}

Capital gains are determined by the change in the share price of equities^[Note that equity prices have a subscript _e_. In other parts of the code an _e_ indicates an expected value, but here it stands for "equity".] in different sectors multiplied by the number of shares $e_j$ held in the previous period,
$$\text{CG} = \sum_{x\in \{c,h,l\}} e_{x,-1}\Delta p_{x,e}$$

In terms of individual sectors, capital gains are given by the terms in the sum above, but with some conditions. For the high-carbon capital sector, capital gains are zero if real output has gone to zero, while for the low-carbon sector it is necessary to catch discontinuities when the sector first issues equities,
```{r}
CGc=ec*(pce-pce(-1))
CGh=ifelse(yh!=0,eh*(phe-phe(-1)),0)
CGl=ifelse(el(-1)!=0&ple(-1)!=0,el(-1)*(ple-ple(-1)),0)
CG = ifelse(el(-1)==0&el>0,CGc+CGh,CGc+CGh+CGl)
```

Real capital gains $cg$ are equal to nominal capital gains adjusted by the price of the consumption good,
```{r}
cg=CG/pc
```

Capital gains per share, $\text{cg}_x$, is calculated in the code as nominal gains divided by the value of shares. With some checks for the low-carbon sector IPO,
```{r}
cgc=CGc/(pce(-1)*ec)
cgh=ifelse(yh!=0&Fh>=0,CGh/(phe(-1)*eh),0)
cgl=ifelse(el(-1)!=0&ple(-1)!=0,CGl/(ple(-1)*el(-1)),0)
```


Expected capital gains are given by an adaptive expectations model as used elsewhere. For sector $x$,
$$\text{CG}_x^e = \left(1 + \eta\widehat{\text{CG}}_x\right)\overline{\text{CG}}_x + \iota \left(\text{CG}_{x,-1}-\text{CG}_{x,-1}^e\right)$$
```{r}
CGce= CGcmean+CGcmean*CGcgr*eta+iota*(CGc(-1)-CGce(-1))
CGhe=ifelse(hasExited,0,CGhmean+CGhmean*CGhgr*eta+iota*(CGh(-1)-CGhe(-1)))
CGle =CGlmean+CGlmean*CGlgr*eta+iota*(CGl(-1)-CGle(-1))
```
Expected real capital gains per share are given by deflated expected nominal capital gains,
```{r}
cgce = CGce/(ec*pce(-1))
cghe=ifelse(hasExited,0,CGhe/(eh*phe(-1)))
cgle=ifelse(el(-1)==0|ple(-1)==0,0,(CGle/(el(-1)*ple(-1))))
```
Finally, the expressions for growth rates and four-period mean values are given by
```{r}
CGcgr=ifelse(CGc(-2)==0,0,(CGc(-1)-CGc(-2))/CGc(-2))
CGlgr=ifelse(CGl(-2)==0,0,(CGl(-1)-CGl(-2))/CGl(-2))
CGhgr=ifelse(CGh(-2)==0,0,(CGh(-1)-CGh(-2))/CGh(-2))
CGcmean=mean(c(CGc(-4),CGc(-3),CGc(-2),CGc(-1)))
CGlmean=mean(c(CGl(-4),CGl(-3),CGl(-2),CGl(-1)))
CGhmean=mean(c(CGh(-4),CGh(-3),CGh(-2),CGh(-1)))
```


## Tobin's _q_
Tobin's _q_ is computed as the market value of equity divided by net worth, which is computed as the value of the capital stock at replacement cost less outstanding loans. With checks to ensure that the sector is operating, and setting $q_i = 1$ before the low-carbon sector's IPO, the expressions are
```{r}
qc= (ec*pce)/(pkh*khc +pkl*klc-Loansc)
qh=ifelse(yh!=0&Fh>=0,(eh*phe)/(pkh*khh-Loansh),0)
ql=ifelse((khl==0&kll==0)|el==0,1,(el*ple)/(pkh*khl +pkl*kll-Loansl))
```
The four-period average is given by
```{r}
qcprev=(qc(-4)+qc(-3)+qc(-2)+qc(-1))/4
qhprev=(qh(-4)+qh(-3)+qh(-2)+qh(-1))/4
qlprev=(ql(-4)+ql(-3)+ql(-2)+ql(-1))/4
```


########################################################### 
# Income
########################################################### 


## Wage earners' disposable income
Nominal disposable income for wage earners is given by the sum of wages from all three sectors:
$$\text{YD}_w = W_cN_c + W_hN_h + W_lN_l$$
To maintain consistency with the Haig-Simons definition of income (see [Section \ref{hh-wealth}](#hh-wealth)), real disposable income is given by two terms, one a deflated version of nominal income, the second the change in the value of the purchasing power of previous-period nominal wealth (for wage earners, this is bank deposits),
$$yd_w = \frac{1}{p_c}\left(\text{YD}_w - \pi_c V_{w,-1}\right)$$
```{r}
YDw=Wc*Nc+Wh*Nh+Wl*Nl
ydw=YDw/pc-pic*Vw(-1)/pc
```

Expected nominal income in the next period is given by an adaptive expectations model in which wage-earners' base expectation incorporates some proportion of growth during the previous period, adjusted by a term proportional to the previous-period deviation from expectations. Using a bar for an average, and a hat to indicate to a growth rate,
$$\text{YD}_w^e = \left(1 + \eta\widehat{\text{YD}}_w\right)\overline{\text{YD}}_w + \epsilon \left(\text{YD}_{w,-1}-\text{YD}_{w,-1}^e\right)$$
Expected real disposable income is then given by a similar expression to current disposable income, but in terms of expected nominal income,
```{r}
YDwe= YDwmean+YDwmean*YDwgr*eta+epsilon*(YDw(-1)-YDwe(-1))
ydwe= YDwe/pc-(pic*Vw(-1))/pc
```
The growth rate and four-period averages of nominal disposable income are given by
```{r}
YDwgr=ifelse(YDw(-2)==0,0,(YDw(-1)-YDw(-2))/YDw(-2))
YDwmean=mean(c(YDw(-4),YDw(-3),YDw(-2),YDw(-1)))
```

## Financial investors' disposable income{#finincome}
Disposable income for financial investors is given by dividends $\text{FD}_x$ from the three productive sectors and the  banking sector, $x\in\{c,h,b,l\}$,
$$\text{YD}_f = \text{FD}_c + \text{FD}_h + \text{FD}_b + \text{FD}_l$$

An equivalent sum applies to expected values of these variables, with a check to ensure that expected income is positive,
```{r}
YDf=FDc+FDh+FDb+FDl
YDfe1=FDce+FDhe+FDle+FDbe
YDfe=(YDfe1+abs(YDfe1))/2
```
As with wage-earning households, when computing real disposable income, wealth is adjusted for consumer price inflation,
```{r}
ydf=YDf/pc - pic*Vf(-1)/pc
```
Expected real income is calculated similar to that for wage-earners, aside from the different source of their income,
```{r}
ydfe=YDfe/pc-(pic*Vf(-1))/pc
```



## Wages

In each time period, firms set a target real wage, possibly after negotiations with labor. For sector $x$, this is denoted $\omega^T_x$ (`omegaTx` in the code). The target real wage is an increasing function of both average labor productivity and the employment rate. The general equation is
$$\omega^T_x=\omega_0 + \omega_1 \log \overline{A}^N_x + \omega_2 \log \frac{N_\text{tot}}{LF}$$

With a check to ensure that the high-carbon capital goods sector is still in operation, this is represented in code as
```{r}
omegaTc=Omega0+Omega1*log(Aprc)+ Omega2*log(Ntot/LF)
omegaTh=ifelse(!hasExited&Nh>0,Omega0+Omega1*log(Aprh)+Omega2*log(Ntot/LF),0)
omegaTl=Omega0+Omega1*log(Aprl)+Omega2*log(Ntot/LF)
```

The nominal wage is then equal to previous-period nominal wage plus a correction based on the gap between the target and the realized real wage. For a general sector $x$, the equation for the real wage $W_x$ is
$$W_x = W_{x,-1} + \omega_3\left(\omega^T_{x,-1} - \frac{W_{x,-1}}{p_{c,-1}}\right) $$
With conditional statements taking into account whether the low-carbon and high-carbon capital goods sectors are producing, this is represented in code as
```{r}
Wc=Wc(-1) + Omega3*(omegaTc(-1) - Wc(-1)/pc(-1))
Wh=ifelse(hasExited,0,Wh(-1) + Omega3*(omegaTh(-1) - Wh(-1)/pc(-1)))
Wl=ifelse(lowcarbExisting,Wl(-1) + Omega3*(omegaTl(-1) - Wl(-1)/pc(-1)),Wh(-1))
```

## Profits{#profits}
Profits are computed as the value of output, less the wage bill, less payments on loans held in the previous period. For a sector $x$,
$$F_x = Y_x - W_xN_x - r^L_{x}L_{x,-1}$$
In this expression, $r^L_x$ is the sector-specific interest rate, denoted `intrc`, `intrh` and `intrl` in the code. As discussed in [Section \ref{interest-rates}](#interest-rates), banks ration credit by differentiating interest rates between sectors.

In the capital goods sectors, profits are zero when the sector is inactive. In the high-carbon capital goods sector, this happens when the sector has defaulted; for the low-carbon capital goods sector, it means firms have not yet begun operation, before time $t = n+1$,

```{r}
Fc=Yc-Wc*Nc-intrc(-1)*Loansc(-1)
Fl=ifelse(lowcarbExisting,Yl-Wl*Nl-intrl(-1)*Loansl(-1),0)
Fh=ifelse(hasExited,0,Yh-Wh*Nh-intrh(-1)*Loansh(-1))
```
The basic equation for expected profits in sector $x$ is given by an adaptive expectations model in which both historical growth and the accuracy of past forecasts influence the result,
$$F_x^e = \left(1 + \eta\hat{F}_x\right)\bar{F}_x + \nu\left(F_{x,-1} - F^e_{x,-1}\right)$$
The exception is for the high-carbon capital goods sector, where dividends go to zero after exit
```{r}
Fce=Fcmean+Fcmean*Fcgr*eta+nu*(Fc(-1)-Fce(-1))
Fle=Flmean+Flmean*Flgr*eta+nu*(Fl(-1)- Fle(-1))
Fhe=ifelse(hasExited,0,Fhmean+Fhmean*Fhgr*eta+nu*(Fh(-1)-Fhe(-1)))
```
The expressions for four-period means and growth rates are given by
```{r}
Fcgr=ifelse(Fc(-2)==0,0,(Fc(-1)-Fc(-2))/Fc(-2))
Flgr=ifelse(Fl(-2)==0,0,(Fl(-1)-Fl(-2))/Fl(-2))
Fhgr=ifelse(Fh(-2)==0,0,(Fh(-1)-Fh(-2))/Fh(-2))
Fcmean=mean(c(Fc(-4),Fc(-3),Fc(-2),Fc(-1)))
Flmean=mean(c(Fl(-4),Fl(-3),Fl(-2),Fl(-1)))
Fhmean=mean(c(Fh(-4),Fh(-3),Fh(-2),Fh(-1)))
```

Sector profit rates $r_x$ are given by profits over the value of capital,
$$r_x = \frac{F_x}{p_{k,-1}k_{x,-1} + p_{i,-1}i_{x,-1}}$$
With checks to ensure the sector is operating, and recalling that low-carbon capital is never used in the high-carbon capital goods sector, these are implemented in code as
```{r}
profratec=Fc/(khc(-1)*pkh(-1)+klc(-1)*pkl(-1))
profratel=ifelse(lowcarbExisting,Fl/(khl(-1)*pkh(-1)+kll(-1)*pkl(-1)),0)
profrateh=ifelse(hasExited,0,Fh/(khh(-1)*pkh(-1)))
```

Expected profit rates are given by similar expressions to the profit rate, but with expected profits ($F_x^e$ rather than $F_x$),
```{r}
expprofratec=Fce/(ec*pce(-1))
expprofratel=ifelse(t>=(n+entry),ifelse(ple(-1)==0,Fle/(khl(-1)*pkh(-1)+kll(-1)*pkl(-1)),Fle/(el(-1)*ple(-1))),0)
expprofrateh=ifelse(hasExited,0,Fhe/(eh*phe(-1)))
```

We also calculate average profit rates over the previous five periods $\bar{r}_x$, which are are used to calculate bank lending rates (see [Section \ref{interest-rates}](#interest-rates)). These are calculated the same way as instantaneous rates but with sums over the previous five periods,

$$\bar{r}_x = \frac{\sum_{t=-5}^{-1}F_{x,t}}{\sum_{s=-5}^{-1}\left(p_{k,s}k_{x,s} + p_{i,s}i_{x,s}\right)}$$

```{r}
profrhistc=ifelse(sumkc>0,(Fc(-5)+Fc(-4)+Fc(-3)+Fc(-2)+Fc(-1))/sumkc,0)
sumkc=pkh(-5)*khc(-5)+pkl(-5)*klc(-5)+pkh(-4)*khc(-4)+pkl(-4)*klc(-4)+pkh(-3)*khc(-3)+pkl(-3)*klc(-3)+pkh(-2)*khc(-2)+pkl(-2)*klc(-2)+pkh(-1)*khc(-1)+pkl(-1)*klc(-1)
profrhistl=ifelse(sumkl>0,(Fl(-5)+Fl(-4)+Fl(-3)+Fl(-2)+Fl(-1))/sumkl,0)
sumkl=pkh(-5)*khl(-5)+pkl(-5)*kll(-5)+pkh(-4)*khl(-4)+pkl(-4)*kll(-4)+pkh(-3)*khl(-3)+pkl(-3)*kll(-3)+pkh(-2)*khl(-2)+pkl(-2)*kll(-2)+pkh(-1)*khl(-1)+pkl(-1)*kll(-1)
profrhisth=ifelse(sumkh>0,(Fh(-5)+Fh(-4)+Fh(-3)+Fh(-2)+Fh(-1))/sumkh,0)
sumkh=pkh(-5)*khh(-5)+pkh(-4)*khh(-4)+pkh(-3)*khh(-3)+pkh(-2)*khh(-2)+pkh(-1)*khh(-1)
```



## Allocation of profits

Firms distribute their profits between dividends ($FD_x$) and retained earnings ($RE_x$). Dividends are a source of income for the financial investors' households (see [Section \ref{finincome}](#finincome)). Retained earnings are typically used, together with bank loans, to finance investments. However, we also allow retained earnings to be negative: in this case, firms borrow from banks in order to pay dividends to their shareholders. 

We assume firms to identify target levels for both dividends ($FD_x^T$) and ($RE_x^T$). These, in turn, are a function of calibrated target levels for the leverage ratio ($\lambda_x^T$) and the return rate offered to shareholders ($RR_x^T$).  

Firms use their money holdings ($M_x$) as a buffer for instances in which profits $F_x$ are not enough to satisfy their targeted levels of dividends and retained earnings. In case money holdings are also insufficient, we assume that both dividends $FD_x$ and retained earnings $RE_x$ are constrained (assuming $RE_x>0$).

\textcolor{red}{The causality of what happens with RET<0 is actually different from what we explain. RET is lower than zero when the desired level of loans (given by lambdaT) is higher than the actual level of loans ($L_(-1)+I$). But this depends on the calibrated lambdaT and not on FDT. Rather, we allow for FD to go above FDT when this happens; i.e. an unexplained desired for larger loans is put to use by expanding dividends. Just checking whether this is correct; I wouldn't change the story, despite its flaws.}

\textcolor{green}{No, if RET depends on lambdaT and expected level of loans (L(-1)+I). FDT depends on RRT. If there is enough cash holdings + profits to pay both RET (irrespecive of wether RET is positive or not) and FDT, then do it. If there is too much cash (i.e. M+F>RET+FDT), it is saved for future use. If there is not enough cash and RET is positive, then both are constrained. If there is not enough cash and RET is negative, then have RE=RET and constrain FDT to the value available: F+M-RET(which is negative).}

### Retained earnings 

Firms determine their desired retained earnings as a function of their desired leverage ratio $\lambda_x^T$ (see [Section \ref{leverage}](#leverage)). $\lambda_x^T$ is a calibrated parameter. When multiplied by the value of capital, $\lambda_x^T$  gives the target level of loans in the next period,
$$L_{x,-1} + \Delta L_x^T = \lambda_x^T\left(k_{h,x}p_{kh} + k_{l,x}p_{kl}\right) $$

Planned nominal investment $I_x$ (`Invc`, `Invh` and `Invl` in the code) is funded through new loans and retained earnings, so
$$I_x = \Delta L_x^T + \text{RE}_x^T $$
As the borrowing target depends on the target leverage ratio, while investment is determined by an investment function, this expression determines target retained earnings,
$$RE_x^T = L_{x,-1} + I_x - \lambda_x^T\left(k_{h,x}p_{kh} + k_{l,x}p_{kl}\right) $$

Checking that the sector is active,
```{r}
REhT=ifelse(hasExited,0,Loansh(-1)+Invh-lambdahT*khh*pkh)
RElT=ifelse(lowcarbExisting,Loansl(-1)+Invl-lambdalT*(khl*pkh+kll*pkl),0)
REcT=Loansc(-1)+Invc-lambdacT*(khc*pkh+klc*pkl)
```

When $RE_x^T>0$, we need to make sure that enough funds are available to reach the desired level of retained earnings and dividends (i.e. $M_{x,-1}+F_x>FD_x^T+RE_x^T$). If so, $RE_x=RE_x^T$; if not and if $RE_x^T>0$ actual retained earnings are constrained ($RE_x<RE_x^T$). When $RE_x^T<0$, on the other hand, the target level is always reached (i.e. firms borrow to distribute as much dividends as possible). 

$$RE_x = \left\lbrace\begin{array}{cl} RE_x^T, & RE_{x}^T < 0 \, \| \, M_{x,-1}+F_x \geq RE^T_x+FD^T_x, \\ RE_x^T\left( \dfrac{M_{x,-1}+F_x}{FD_x^T + RE_x^T}\right), & \text{otherwise.} \end{array}\right. $$
```{r}
REh=ifelse(hasExited,0,ifelse((Mh(-1)+Fh>FDhT+REhT)|(REhT<0),REhT,REhT*(Mh(-1)+Fh)/(FDhT+REhT)))
REl=ifelse(lowcarbExisting,ifelse((Ml(-1)+Fl>FDcT+REcT)|(RElT<0),RElT,RElT*(Ml(-1)+Fl)/(FDlT+RElT)),0)
REc=ifelse((Mc(-1)+Fc>FDcT+REcT)|(REcT<0),REcT,REcT*(Mc(-1)+Fc)/(FDcT+REcT))
```


### Dividends{#dividends}

Dividends are distributed to financial investors from productive sectors and the banking sector. Each productive sector $x$ targets a specific yield ratio $\text{RR}_x^T$; these values are calibrated parameters. The total yield is the sum of capital gains and dividends, so the target level of dividends is the target total yield less expected capital gains,
$$\text{FD}_x^T = \text{RR}_x^T e_x p_{x,e} - \text{CG}_x^e$$
With conditions to ensure the sector is active, the expressions are
```{r}
FDhT=max(0,ifelse(hasExited,0,RRhT*eh*phe(-1)-CGhe))
FDlT=max(0,ifelse(lowcarbExisting,RRlT*el*ple(-1)-CGle,0))
FDcT=max(0,RRcT*ec*pce(-1)-CGce)
```

Actual dividends $FD_x$ will be equal to their target levels $FD_x^T$ if targeted retained earnings $RE_x^T$ are positive and there is enough finance available to satisfy both $FD_x^T$ and $RE_x^T$. If $RE_x<0$, $FD_x$ will exceed their target level. Finally, in case the available funds are not enough to cover for both $RE_x^T$ and $FD_x^T$, dividends $FD_x$ are constrained

$$FD_x = \left\lbrace\begin{array}{cl}FD^T_x, & M_x(-1)+F_x\geq RE^T_x+FD^T_x \\ M_{x,-1}+F_x-RE^T_x, & M_x(-1)+F_x < RE^T_x+FD^T_x \text{ } \& \text{} RE_x^T < 0, \\  \dfrac{FD^T_x(M_x(-1)+F_x)}{FD^T_x+RE^T_x}, & \text{otherwise.} \end{array}\right. $$

In code,
```{r}
FDl=ifelse(t>(n+entry),ifelse(Ml(-1)+Fl>FDlT+RElT,FDlT,ifelse(RElT<0,Ml(-1)+Fl-RElT,FDlT*(Ml(-1)+Fl)/(FDlT+RElT))),0)
FDc=ifelse(Mc(-1)+Fc>FDcT+REcT,FDcT,ifelse(REcT<0,Mc(-1)+Fc-REcT,FDcT*(Mc(-1)+Fc)/(FDcT+REcT)))
FDh=ifelse(!hasExited&invhtot>0,ifelse(Mh(-1)+Fh>FDhT+REhT,FDhT,ifelse(REhT<0,Mh(-1)+Fh-REhT,FDhT*(Mh(-1)+Fh)/(FDhT+REhT))),0)
```

Banks have zero net worth, so they pay out their income from loan repayments ($r_xL_x$) as dividends. However, if the high-carbon capital goods sector goes bankrupt then banks must write off the loans. This is reflected in a negative value for `FDbraw`, which is passed along to financial investors through the `bailout` variable,
```{r}
FDb=max(0,FDbraw)
FDbraw= intrc(-1)*Loansc(-1) +ifelse(yh!=0&Fh>=0&phe>0,intrh(-1)*Loansh(-1),-(Loansh(-1)-Mh(-1))) + intrl(-1)*Loansl(-1)
bailout=FDb-FDbraw
```

Expectations are set, as for other variables, by an adaptive expectations model,
$$\text{FD}_x^e = \left(1 + \eta\widehat{\text{FD}}_x\right)\overline{\text{FD}}_x + \chi\left(\text{FD}_{x,-1} - \text{FD}^e_{x,-1}\right)$$
Expected dividends for the high-carbon capital goods sector are zero after exit,
```{r}
FDbe= FDbmean+FDbmean*FDbgr*eta+chi*(FDb(-1)- FDbe(-1))
FDle= FDlmean+FDlmean*FDlgr*eta+chi*(FDl(-1)-FDle(-1))
FDce=FDcmean+FDcmean*FDcgr*eta+chi*(FDc(-1)-FDce(-1))
FDhe=ifelse(hasExited,0,FDhmean+FDhmean*FDhgr*eta+chi*(FDh(-1)-FDhe(-1)))
```
Four-period averages and growth rates are given by
```{r}
FDbgr=ifelse(FDb(-2)==0,0,(FDb(-1)-FDb(-2))/FDb(-2))
FDcgr=ifelse(FDc(-2)==0,0,(FDc(-1)-FDc(-2))/FDc(-2))
FDlgr=ifelse(FDl(-2)==0,0,(FDl(-1)-FDl(-2))/FDl(-2))
FDhgr=ifelse(FDh(-2)==0,0,(FDh(-1)-FDh(-2))/FDh(-2))
FDbmean=mean(c(FDb(-4),FDb(-3),FDb(-2),FDb(-1)))
FDcmean=mean(c(FDc(-4),FDc(-3),FDc(-2),FDc(-1)))
FDlmean=mean(c(FDl(-4),FDl(-3),FDl(-2),FDl(-1)))
FDhmean=mean(c(FDh(-4),FDh(-3),FDh(-2),FDh(-1)))
```

The expected dividend rate is given by a similar expression to expected profit rate but with dividends rather than profits ($\text{FD}_x^e$ rather than $F_x^e$),
```{r}
expdivratec=FDce/(ec*pce(-1))
expdivrateh=ifelse(hasExited,0,FDhe/(eh*phe(-1)))
expdivratel=ifelse(t>=(n+entry),ifelse(ple(-1)==0,FDle/(khl(-1)*pkh(-1)+kll(-1)*pkl(-1)),FDle/(el(-1)*ple(-1))),0)
```

########################################################### 
# Aggregate demand
########################################################### 

## Consumption{#consumption}

Real consumption by wage earners is $c_w$ and by financial investors is $c_f$. These are calculated in stages. First, desired consumption is calculated for both groups as a function of disposable income and previous-period wealth,
$$c_{w1} = \xi_{w1}y_{dw}^e + \xi_{w2}v_{w,-1}$$
$$c_{f1} = \xi_{f1}y_{df}^e + \xi_{f2}v_{f,-1}$$

Since investors' income can be negative, we set the minimum boundary of desired consumption to zero. 
```{r}
cw1= xiw1*ydwe + xiw2*vw(-1)
cf1=max(0,xif1*ydfe+xif2*vf(-1)+xif3*cg(-1))
```

It is possible that desired consumption exceeds the capacity of the economy to produce consumption goods, due to labor supply or full capacity utilisation constraints. The potential supply of consumption goods $c_s$ from the previous period is
$$c_s = \min\left(1,\frac{LF-N_l-N_h}{N_{c,\mathrm{max}}}\right)\left(k_{hc,-1}\xi_h + k_{lc,-1}\xi_l\right)$$
The ratio $(LF - N_l - N_h)/N_{c,\mathrm{max}}$ captures the case in which production in the consumption sector is constrained by labor supply.

```{r}
cs=ifelse(LF-Nl-Nh<Ncmax,(LF-Nl-Nh)/Ncmax,1)*(khc(-1)*prkh+klc(-1)*prkl)
```

Excess production of consumption goods over desired consumption is $x_1$ (`exc` in the code). 
$$x_1 = c_s - c_{w1} - c_{f1}$$

Avoiding the case $x_1<0$, in which there is no excess demand and thus no constraints, 
```{r}
exc=min(0,cs-cw1-cf1)
```

The deficit is then shared by wage earners and investors in proportion to their planned expenditure,
$$c_w = c_{w1}+\frac{c_{w1}}{c_{w1} + c_{f1}}x_1$$
$$c_f = c_{f1}+\frac{c_{f1}}{c_{w1} + c_{f1}}x_1$$
```{r}
cw=cw1+cw1/(cw1+cf1)*exc
cf=cf1+cf1/(cw1+cf1)*exc
```
Once real consumption has been calculated, it is converted to nominal values using the price of consumption goods:
```{r}
Cw=cw*pc
Cf=cf*pc
```

## Investments{#investment}

### Desired investments

For a sector that is fully established, desired investment is the sum of desired capacity expansion plus depreciation. The desired capacity growth rate in sector $x$ depends on expected capacity utilization $u_x^e$, the real interest rate $rr_x$ (deflated by the price of capital goods), average leverage $\bar{\lambda}_x$, and Tobin's _q_, $q_x$,
$$g_x = \eta_{0x} + \eta_1 u_x^e - \eta_2 rr_x\bar{\lambda}_x + \eta_3 q_{x,-1}$$
Most of the coefficients are the same across sectors, but the intercept $\eta_{0x}$ differs between consumption goods ($\eta_{0c}$) and capital goods ($\eta_{0k}$), with $\eta_{0h} = \eta_{0l} = \eta_{0k}$.

When the low-carbon capital goods sector first starts, it has no historical record of production as a reference, and must set a target capacity expansion rate $\tau$. With checks to make sure the sector is active, the model equations are
```{r}
gkh=min(gkmax,ifelse(hasExited,0,eta0k+eta1*uhe-eta2*rintrh*lambdahprev+eta3*qhprev))
gkl=min(gkmax,ifelse(beforeIPO,tau,eta0k+eta1*ule-eta2*rintrl*lambdalprev+eta3*qlprev))
gc=min(gkmax,eta0c+eta1*uce-eta2*rintrc*lambdacprev+eta3*qcprev)
```

### Depreciation
In general, depreciation in sector $x$ of capital type $y$, with a lifetime $n$, can be written
$$d(k_{yx}) = \sum_{\tau = -1}^{-n} \alpha_\tau i_{xy,\tau},\>\text{where}\>\sum_{\tau = -1}^{-n} \alpha_\tau = 1$$
Accounting depreciation is an artificial representation of the declining value of capital. In reality, capital can continue to be productive until it is scrapped, albeit at moderately lower levels of productivity as it ages. Productivity then drops off rapidly toward the end of its lifetime. We represent this dynamic of physical depreciation through the following expressions, where $n=19$,
$$\alpha_{-1} = e^{-(n-1)},$$
$$\alpha_\tau =  e^{-(n+\tau)}\left(1 - \frac{1}{e}\right),\>\tau\in\{-2,\ldots,-n\}$$
The behavior of the depreciation coefficients is shown in the following graph,


An additional term, `depkhcT` in the code, keeps track of the disappearing high-carbon capital in the consumption goods sector after the high-carbon sector fails. If it reaches zero while there is still some high-carbon capital in the sector, it maintains the previous (very small) value until the capital has fully depreciated.

The code for the depreciation calculation is lengthy, so we leave it to the end of this section.

### Consumption goods sector{#conssectorinvestment}
Investment in the consumption goods sector can come from either low-carbon or high-carbon capital, but investments are made with an eye to production. Because capital productivity can differ between types of capital, we distinguish in this section between "production-equivalent" and "physical" investment. Total possible real gross investment in production-equivalent terms (`invyc` in the model code) is denoted $i^y_c$. It is given as a multiple of prior period real output plus depreciation of the two types of capital (or zero, if that value is negative), subject availability constraints for both types of capital,
$$i^y_c = \min(\max\left(g_c y_{c,-1} + \xi_h d(k_{hc}) + \xi_l d(k_{lc}),0\right),k^{sold}_l\xi_{l}+k^{sold}_h\xi_h)$$
```{r}
invyc=min(max(gc*yc(-1)+depkhc*prkh+depklc*prkl,0),khsold*prkh+klsold*prkl)
```


The demand for low-carbon and high-carbon capital goods by the consumption sector in physical terms is given by $i_{cl}^d$, $i_{ch}^d$ (`invcld` and `invchd` in the code), where
$$i_{cl}^d = \beta_\text{inv}^d \frac{i_c^y}{\xi_l}$$
$$i_{ch}^d = \left(1 - \beta_\text{inv}^d\right) \frac{i_c^y}{\xi_h}$$

```{r}
invcld = beta_invd * invyc/prkl
invchd = (1 - beta_invd) * invyc/prkh
```

The coefficient $\beta_\text{inv}^d$ represents the desired proportion of investments in low-carbon capital, and is a decreasing function of relative cost of operating low-carbon capital,
$$\beta_\text{inv}^d = \dfrac{1}{\beta_0 + e^{\beta_1(c_{lc} - c_{hc})/c_{hc}}}$$

```{r}
beta_invd = 1/(beta0 + exp(beta1 * (tuclc - tuchc)/tuchc))
```

where the total unit costs of operating high- or low-carbon capital ($c_{hc}$ and $c_{lc}$) are equal to the sum of wage costs and annualized capital costs,
$$c_{yc} = \frac{W_c}{\xi_y \ell_{yc}} + \frac{p_{ky}}{\delta_y \xi_y}$$
```{r}
tuclc = Wc/(prkl * caplabratiolc) + pkl/(deltal * prkl)
tuchc = Wc/(prkh * caplabratiohc) + pkh/(deltah * prkh)
```


Realized investment in low- and high-carbon capital in the consumption goods sector ($i_{cl}$ and $i_{ch}$) may be different from desired levels due to supply constraints. They will be equal to: 
	* The desired level, if it is available on the market;
	* The desired level plus a certain amount to substitute for the other type of capital, if production of the other type is insufficient;
	* The amount produced, if the supply of capital goods is insufficient to meet requirements.


$$i_{cl} = \left\lbrace\begin{array}{cl} i_{cl}^d, & i_{cl}^d<k_l^{\text{sold}} \text{ } \& \text{ } i_{ch}^d<k_h^{\text{sold}} ,\\ i_{cl}^d + \left(i_{ch}^d-k_h^{\text{sold}}\right)\dfrac{\xi_h}{\xi_l}, & i_{cl}^d<k_l^{\text{sold}} \text{ } \& \text{ } i_{ch}^d>k_h^{\text{sold}}, \\ k_l^{\text{sold}}, &  i_{cl}^d>k_l^{\text{sold}} \end{array}\right. $$

$$i_{ch} = \left\lbrace\begin{array}{cl} i_{ch}^d, & i_{ch}^d<k_h^{\text{sold}} \text{ } \& \text{ } i_{cl}^d<k_l^{\text{sold}} ,\\ i_{ch}^d + \left(i_{cl}^d-k_l^{\text{sold}}\right)\dfrac{\xi_l}{\xi_h}, & i_{ch}^d<k_h^{\text{sold}} \text{ } \& \text{ } i_{cl}^d>k_l^{\text{sold}}, \\ k_h^{\text{sold}}, &  i_{ch}^d>k_h^{\text{sold}} \end{array}\right. $$

We can then derive the actual level of $\beta_\text{inv}$ using the realised investments. 

```{r}
invcl = min(invcld+max(0,invchd-khsold)*prkh/prkl,klsold)
invch = min(invchd+max(0,invcld-klsold)*prkl/prkh,khsold)
beta_inv = ifelse(invyc==0,0,invcl*prkl/(invcl*prkl+invch*prkh))
```

Total nominal investment in the consumption good sector $I_c$ (`Invc` in the code) is equal to real investment in each type of capital ($i_{ch}$ or $i_{cl}$ in the model and `invch` or `invcl` in the code), multiplied by the corresponding prices, and summed,
$$I_c = p_{kh} i_{ch} + p_{kl} i_{cl}$$

```{r}
Invc=invch*pkh+invcl*pkl
```



### High-carbon capital sector
Output from the high-carbon capital goods sector is limited by its existing stock of capital. So, $\xi_h k_{hh,-1}$ sets a floor on its own purchases of high-carbon capital goods. But it will also not invest more than planned (and will not disinvest), so investment in high-carbon capital in the high-carbon capital goods sector is given by
$$i_{hh} = \min\left[k_{hh,-1}\xi_h, \max\left(0, \frac{g_{kh}}{\xi_h}k_{hh,-1} + d(k_{hh})\right)\right] $$
```{r}
invhh=ifelse(hasExited,0,min(khh(-1)*prkh,max(0,khh(-1)*gkh/prkh + depkhh)))
```

An amount of high-carbon capital $k_h^\text{sold}$ is sold, given by total production, net of its own investment needs,
```{r}
khsold=ifelse(hasExited,0,khh(-1)*prkh-invhh)
```

Total investment demand for high-carbon capital goods is given by the sum across sectors,
```{r}
invhtot=invhh+invch+invlh
```



Total nominal investment in the high-carbon capital sector $I_h$ (`Invh` in the code) is equal to real investment in high-carbon capital ($i_{hh}$ in the model and `invhh` in the code), multiplied by the price of high-carbon capital $p_{kh}$,
$$I_h = p_{kh} i_{hh}$$
Ensuring the sector is active,
```{r}
Invh=ifelse(hasExited,0, invhh*pkh)
```

### Low-carbon capital sector
There are constraints on the total available low-carbon capital during and immediately after the first period in which the low-carbon capital goods sector enters the market, because it must produce for its own needs as well as for the market. To determine how much of its own ouptut to use for next-period investment ($i_{ll}$) and how much to sell ($k_l^\text{sold}$), the low-carbon sector identifies a desired market share, $\rho$, and a productive capacity growth rate $\tau$.

#### First-period investment
Production in the first period is determined by the productivity of high-carbon capital, and is split between the amount needed for investment goods in the sector and the amount sold. Because the amount of high-carbon capital in the sector in the first period is the first-period investment, $i_{lh} = k_{hl}$, this is
$$y_l = \xi_h i_{lh} = i_{ll,+1} + k_l^\text{sold}$$

#### Second-period investment
Second-period demand for low-carbon capital in the low-carbon capital goods sector is given by depreciation of first-period high-carbon capital (which is equal to first-period investment) plus the amount needed for desired expansion. Using the notation above for the general expression for depreciation,
$$i_{ll,+1} = \alpha_{-1}i_{lh}\frac{\xi_h}{\xi_l} + \frac{\tau y_l}{\xi_l}$$
Substituting from the expressions above, we can transform both the left- and right-hand sides of this equation to give
$$\xi_h i_{lh} - k_l^\text{sold} = \left(\alpha_{-1} + \tau\right)\frac{\xi_h}{\xi_l}i_{lh}$$
Solving for first-period investment in high-carbon capital gives
$$i_{lh} = \frac{\xi_l}{\xi_h}\frac{1}{\xi_l  - \alpha_{-1} - \tau}k_l^\text{sold}$$
The nominal value of the amount sold is equal to the desired market share multiplied by the expected size of the market, which is calculated as the previous-period value of production of high-carbon capital goods plus the amount the low-carbon sector expects to sell, or
$$p_{kl} k_l^\text{sold} = \rho\left(p_{kl} k_l^\text{sold} + Y_{h,-1}\right)\implies k_l^\text{sold} = \frac{1}{p_{kl}}\frac{\rho Y_{h,-1}}{1-\rho}$$
The expression for the price is discussed elsewhere (see [Section \ref{pricing}](#pricing)). Substituting this expression, we find

$$i_{lh} = \frac{\xi_l}{\xi_h}\frac{1}{\xi_l  - \alpha_{-1} - \tau}\frac{1}{p_{kl}}\frac{\rho Y_{h,-1}}{1-\rho}$$
Because $\alpha_{-1} = e^{1-n}$, the expression in the code is implemented as
$$i_{lli} = 0,\>i_{lh} = \frac{\rho \xi_l Y_{h,-1}}{(1-\rho)p_{kl}\xi_h(\xi_l - e^{1-n} - \tau)},\text{ first period}$$

#### Third and later period investment
After the initial period, all investment in the sector is in low-carbon capital. The investment function is similar to that for the consumption goods sector, but investment is constrained by the sector's own production in the previous period, which is $\xi_l k_{ll,-1} + \xi_h k_{hl,-1}$,
$$i_{ll} = \min\left[\xi_l k_{ll,-1} + \xi_h k_{hl,-1},\frac{1}{\xi_l}\max\left(g_l y_{l,-1} + \xi_h d(k_{hl}) + \xi_l d(k_{ll}),0\right)\right],\>i_{lh} = 0,\text{ after first period}$$
The sector produces capital goods for itself as well as for sale. The sold component is $k_l^\text{sold}$, which is calculated as the difference between total production and the amount needed for own investment.
```{r}
invll=min(kll(-1)*prkl+khl(-1)*prkh,max(((gkl*(kll(-1)*prkl+khl(-1)*prkh)+depkll*prkl+depkhl*prkh)/prkl),0))
invlh=ifelse(initLowCarb,rho*Yh(-1)*prkl/((1-rho)*pkl*prkh*(prkl-exp(1-n)-tau)),0)
klsold=kll(-1)*prkl+khl(-1)*prkh-invll
```


Total investment demand for low-carbon capital goods is given by the sum across sectors,
```{r}
invltot=invcl+invll
```

Total nominal investment in the low-carbon capital sector $I_l$ (`Invl` in the code) is equal to real investment in low-carbon capital ($i_{ll}$ in the model and `invll` in the code), multiplied by the price of high-carbon capital $p_{kl}$, with the exception of its first period of existence, during which it invests in high-carbon capital a nominal amount equal to real investments $i_{lh} times the price of high-carbon capital  p_{kh}

Ensuring the sector is active,
```{r}
Invl=ifelse(initLowCarb,invlh*pkh,invll*pkl)
```

### Depreciation calculations in the code
In code, the depreciation calculations described above are given by
```{r}
depkhh=invhh(-1)*(-5.602796e-09+1.522998e-08)+invhh(-2)*(-1.522998e-08+4.139938e-08)+invhh(-3)*(-4.139938e-08+1.125352e-07)+invhh(-4)*(-1.125352e-07+3.059023e-07)+invhh(-5)*(-3.059023e-07+8.315287e-07)+invhh(-6)*(-8.315287e-07+2.260329e-06)+invhh(-7)*(-2.260329e-06+6.144212e-06)+invhh(-8)*(-6.144212e-06+1.67017e-05)+invhh(-9)*(-1.67017e-05+4.539993e-05)+invhh(-10)*(-4.539993e-05+0.0001234098)+invhh(-11)*(-0.0001234098+0.0003354626)+invhh(-12)*(-0.0003354626+0.000911882)+invhh(-13)*(-0.000911882+0.002478752)+invhh(-14)*(-0.002478752+0.006737947)+invhh(-15)*(-0.006737947+0.01831564)+invhh(-16)*(-0.01831564+0.04978707)+invhh(-17)*(-0.04978707+0.1353353)+invhh(-18)*(-0.1353353+0.3678794)+invhh(-19)*(1-0.3678794)+invhh(-1)*5.602796e-09
depkhl=invlh(-1)*(-5.602796e-09+1.522998e-08)+invlh(-2)*(-1.522998e-08+4.139938e-08)+invlh(-3)*(-4.139938e-08+1.125352e-07)+invlh(-4)*(-1.125352e-07+3.059023e-07)+invlh(-5)*(-3.059023e-07+8.315287e-07)+invlh(-6)*(-8.315287e-07+2.260329e-06)+invlh(-7)*(-2.260329e-06+6.144212e-06)+invlh(-8)*(-6.144212e-06+1.67017e-05)+invlh(-9)*(-1.67017e-05+4.539993e-05)+invlh(-10)*(-4.539993e-05+0.0001234098)+invlh(-11)*(-0.0001234098+0.0003354626)+invlh(-12)*(-0.0003354626+0.000911882)+invlh(-13)*(-0.000911882+0.002478752)+invlh(-14)*(-0.002478752+0.006737947)+invlh(-15)*(-0.006737947+0.01831564)+invlh(-16)*(-0.01831564+0.04978707)+invlh(-17)*(-0.04978707+0.1353353)+invlh(-18)*(-0.1353353+0.3678794)+invlh(-19)*(1-0.3678794)+invlh(-1)*5.602796e-09
depkll=invll(-1)*(-5.602796e-09+1.522998e-08)+invll(-2)*(-1.522998e-08+4.139938e-08)+invll(-3)*(-4.139938e-08+1.125352e-07)+invll(-4)*(-1.125352e-07+3.059023e-07)+invll(-5)*(-3.059023e-07+8.315287e-07)+invll(-6)*(-8.315287e-07+2.260329e-06)+invll(-7)*(-2.260329e-06+6.144212e-06)+invll(-8)*(-6.144212e-06+1.67017e-05)+invll(-9)*(-1.67017e-05+4.539993e-05)+invll(-10)*(-4.539993e-05+0.0001234098)+invll(-11)*(-0.0001234098+0.0003354626)+invll(-12)*(-0.0003354626+0.000911882)+invll(-13)*(-0.000911882+0.002478752)+invll(-14)*(-0.002478752+0.006737947)+invll(-15)*(-0.006737947+0.01831564)+invll(-16)*(-0.01831564+0.04978707)+invll(-17)*(-0.04978707+0.1353353)+invll(-18)*(-0.1353353+0.3678794)+invll(-19)*(1-0.3678794)+invll(-1)*5.602796e-09
depkhcT=invch(-1)*(-5.602796e-09+1.522998e-08)+invch(-2)*(-1.522998e-08+4.139938e-08)+invch(-3)*(-4.139938e-08+1.125352e-07)+invch(-4)*(-1.125352e-07+3.059023e-07)+invch(-5)*(-3.059023e-07+8.315287e-07)+invch(-6)*(-8.315287e-07+2.260329e-06)+invch(-7)*(-2.260329e-06+6.144212e-06)+invch(-8)*(-6.144212e-06+1.67017e-05)+invch(-9)*(-1.67017e-05+4.539993e-05)+invch(-10)*(-4.539993e-05+0.0001234098)+invch(-11)*(-0.0001234098+0.0003354626)+invch(-12)*(-0.0003354626+0.000911882)+invch(-13)*(-0.000911882+0.002478752)+invch(-14)*(-0.002478752+0.006737947)+invch(-15)*(-0.006737947+0.01831564)+invch(-16)*(-0.01831564+0.04978707)+invch(-17)*(-0.04978707+0.1353353)+invch(-18)*(-0.1353353+0.3678794)+invch(-19)*(1-0.3678794)+invch(-1)*5.602796e-09
depkhc=ifelse(depkhcT==0&khc(-1)>0,depkhc(-1),depkhcT)
depklc=invcl(-1)*(-5.602796e-09+1.522998e-08)+invcl(-2)*(-1.522998e-08+4.139938e-08)+invcl(-3)*(-4.139938e-08+1.125352e-07)+invcl(-4)*(-1.125352e-07+3.059023e-07)+invcl(-5)*(-3.059023e-07+8.315287e-07)+invcl(-6)*(-8.315287e-07+2.260329e-06)+invcl(-7)*(-2.260329e-06+6.144212e-06)+invcl(-8)*(-6.144212e-06+1.67017e-05)+invcl(-9)*(-1.67017e-05+4.539993e-05)+invcl(-10)*(-4.539993e-05+0.0001234098)+invcl(-11)*(-0.0001234098+0.0003354626)+invcl(-12)*(-0.0003354626+0.000911882)+invcl(-13)*(-0.000911882+0.002478752)+invcl(-14)*(-0.002478752+0.006737947)+invcl(-15)*(-0.006737947+0.01831564)+invcl(-16)*(-0.01831564+0.04978707)+invcl(-17)*(-0.04978707+0.1353353)+invcl(-18)*(-0.1353353+0.3678794)+invcl(-19)*(1-0.3678794)+invcl(-1)*5.602796e-09
```

########################################################### 
# Banking
########################################################### 

## Loans
Firms finance part of their investments through new bank lending, with loans effectively acting as a buffer stock. Loans to sector $x$ are given by previous-period loans plus total investment net of retained earnings,
$$L_x = L_{x,-1} + I_x - \text{RE}_x $$

This is reflected in the following expressions,
```{r}
Loansl=Loansl(-1)+Invl-REl
Loansc=Loansc(-1)+Invc-REc
Loansh=ifelse(yh!=0&Fh>=0,Loansh(-1)+Invh-REh,0)
```

Total outstanding loans are computed as the sum of loans to each productive sector. (While not used in the model, it is a useful variable to report for constructing aggregate balance sheets.)
$$L_d = \sum_{x\in\{c,h,l\}} L_x$$
```{r}
LoansDem=Loansc+Loansh+Loansl
```


## Interest rates{#interest-rates}
Interest rates on loans are set at different levels for different sectors depending on their historical average profit rates $\bar{r}^L_x$ compared to the benchmark profit rate $r^L_b$ (`profrbench` in the code). Sector interest rates for sector $x$ (`intrhistx` in the code) are calculated as a multiple of a base, or reference interest rate $r^L_r$ (`intrbase` in the code):
$$r^L_x = r^L_r\left\lbrace 1 + \frac{1}{1 + \exp\left[\kappa\left(\bar{r}^L_x - r^L_b\right)\right]} \right\rbrace$$

```{r}
intrc=intrbase*(1+1/(1 +exp(kappa*(profrhistc-profrbench))))
intrh=ifelse(hasExited,0,intrbase*(1+1/(1+exp(kappa*(profrhisth-profrbench)))))
intrl=intrbase*(1+1/(1 +exp(kappa*(profrhistl-profrbench))))
```
If the average historical return is equal the benchmark, then the rate is equal to $(3/2)r^L_r$. If realized profit rates are higher than the benchmark rate, then the interest rate is lower, and vice versa.

Real interest rates are deflated by the cost of capital. For the low-carbon and high-carbon capital goods sectors that is given by the inflation rate of low-carbon and high-carbon capital prices, respectively. For the consumption goods sector it is given by the average inflation rate of capital used in the sector,
```{r}
rintrc=(1+intrc)/(1+pickhl)-1
rintrl=ifelse(lowcarbExisting,0,ifelse(pikl==0,0,(1+intrl)/(1+pikl)-1))
rintrh=ifelse(hasExited,0,(1+intrh)/(1+pikh)-1)
```

## Leverage{#leverage}
Loan leverage in sector $x$, $\lambda_x$, is calculated in each period as the ratio of outstanding loans to the replacement value of the capital stock at current prices,
$$\lambda_x = \frac{L_x}{p_{kh} k_{hx} + p_{kl} k_{lx}}$$
After checking that the sector is operating, in model code this becomes
```{r}
lambdac=Loansc/(khc*pkh + klc*pkl)
lambdal=ifelse(khl!=0|kll!=0,Loansl/(khl*pkh + kll*pkl),0)
lambdah=ifelse(hasExited,0,Loansh/(khh*pkh))
```
The average leverage is given by the average over the prior four periods,
```{r}
lambdacprev=(lambdac(-4)+lambdac(-3)+lambdac(-2)+lambdac(-1))/4
lambdalprev=(lambdal(-4)+lambdal(-3)+lambdal(-2)+lambdal(-1))/4
lambdahprev=(lambdah(-4)+lambdah(-3)+lambdah(-2)+lambdah(-1))/4
```



########################################################### 
# Expectations, apathy and blindness
###########################################################

In this section we introduce the mechanisms through which we determine long-term expectations of financial investors, which in turn will contribute to determining how they allocate their financial wealth. The aim of the process is to determine values for expected 'unleveraged' potential output $\bar{y}^e_x$, which will then enter into the equation determining $\lambda_{m0}$ variables in [Section \ref{financial-investments}](#financial-investments).

Since the bias in expectations will involve the stock of high-carbon capital in the high-carbon sector ($k_{hh}$) and the stock of low-carbon capital in the low-carbon sector ($k_{ll}$), we start by calculating the shares of both of them over their entire amount. We abstract from introducing capital productivities because we assume $\xi_h=\xi_l$.

$$\sigma_h = \frac{k_{hh}}{k_{hh}+k_{ll}}$$
$$\sigma_l = \frac{k_{ll}}{k_{hh}+k_{ll}}$$

```{r}
sharekh=round(khh(-1)/(khh(-1)+kll(-1)),digit=10)
sharekl=round(kll(-1)/(khh(-1)+kll(-1)),digit=10)
```


## Climate apathy{#climate-apathy}
We introduce 'climate apathetic' expectations via the parameter $\theta\in[0,1]$. We divert a proportion $\theta$ of growth expectations away from the expected growth rate of low-carbon capital in the low-carbon capital sector (`kllgre` in the code), and reallocate these growth expectations towards the high-carbon capital in the high-carbon capital sector (`khhgre` in the code):
```{r}
kllgre = ifelse(sharekh == 1, 0, ifelse(kll(-1) == 0, 0, (1 - theta) * kllgr))
khhgre = ifelse(sharekh == 0, 0, (totkhhllgr - (1 - sharekh) * kllgre)/sharekh)
```

We smooth formation expectations by calculating the mean of expected capital growth rates over the previous four periods ($\bar{\hat{k}}^e_{xy}$),
```{r}
khhgrmeane=mean(c(khhgre(-4),khhgre(-3),khhgre(-2),khhgre(-1)))
kllgrmeane=mean(c(kllgre(-4),kllgre(-3),kllgre(-2),kllgre(-1)))
khlgrmeane=mean(c(khlgr(-4),khlgr(-3),khlgr(-2),khlgr(-1)))
khcgrmeane=mean(c(khcgr(-4),khcgr(-3),khcgr(-2),khcgr(-1)))
klcgrmeane=mean(c(klcgr(-4),klcgr(-3),klcgr(-2),klcgr(-1)))
```

## Climate blindness
We assume investors to adjust their previous expectations regarding capital growth towards the actual capital stock values only to some degree, represented by the 'climate blindness' parameter $\phi$. In each period, investors. For a certain stock $y$ and a certain sector $x$,perceived capital stocks $k_{xy}^{Perc}$ are

$$k_{xy}^{Perc} = (1-\phi)k_{xy}+\phi k_{xy,-1}\bar{\hat{k}}^e_{xy}$$

For simplicity, we assume this does not apply to the stocks of capital in the consumption sector, nor to the stock of high-carbon capital in the low-carbon sector. 


```{r}
khcperc=khc
klcperc=klc
khlperc=khl
kllperc=ifelse(kll==0,0,(1-phi)*kll + phi*kll(-1)*(1+kllgrmeane))
khhperc=ifelse(khh==0,0,(1-phi)*khh + phi*khh(-1)*(1+khhgrmeane))
```

## Expected potential output

We then proceed to calculate the expected present value of future capital stocks, using `intrbase` as our discount rate. In order to make the code more readable, we first calculate $\zeta_{yx}$ as 
$$\zeta_{yx}=\frac{1+\bar{\hat{k}}^e_{xy}}{1+r^L_r}$$

```{r}
xkhc=(1+khcgrmeane)/(1+intrbase)
xklc=(1+klcgrmeane)/(1+intrbase)
xkhh=(1+khhgrmeane)/(1+intrbase)
xkhl=(1+khlgrmeane)/(1+intrbase)
xkll=(1+kllgrmeane)/(1+intrbase)
```

We need an expression for a geometric sum. For an arbitrary variable $x$,
$$S_T\equiv \sum_{t = 0}^{T - 1}x^t $$
Multiplying this sum by $x$ gives the same sum, less the first term ($x^0 = 1$) and with an additional term ($x^T$), so
$$S_T = xS_T + 1 - x^T$$
Solving for $S_T$,
$$S_T = \frac{1 - x^T}{1 - x}$$

With this expression, and keeping in mind that we abstract from productivities because of our $\xi_h=\xi_l$ assumption, we can write the present value of future cumulative sectoral capital stocks as
```{r}
PVyc=ifelse(khcperc>0,khcperc*(1-xkhc^deltah)/(1-xkhc)+klcperc*(1-xklc^deltah)/(1-xklc),klcperc*(1-xklc^deltah)/(1-xklc))
PVyh=khhperc*(1-xkhh^deltah)/(1-xkhh)
PVyl=ifelse(khlperc>0,khlperc*(1-xkhl^deltah)/(1-xkhl)+kllperc*(1-xkll^deltah)/(1-xkll),kllperc*(1-xkll^deltah)/(1-xkll))
```

Finally, we calculate expected 'unleveraged' potential output $\bar{y}^e_x$ by factoring in the target leverage ratio $\lambda^T_x$,
```{r}
ypotce=PVyc*(1-lambdacT)
ypothe=PVyh*(1-lambdahT)
ypotle=PVyl*(1-lambdalT)
```

These expected unleveraged potential output values will then be used to determine the allocation of financial wealth by investors. 

########################################################### 
# Financial investments{#financial-investments}
########################################################### 

Financial investors allocate all of their expected financial wealth, $V^e_{fc}$ among the equities in the three sectors and money held for financial purposes. The equation can be written in matrix form as
$$\left(
\begin{matrix} M_f \\ p_{c,e}e_c \\ p_{l,e}e_k \\ p_{h,e}e_i \end{matrix}
\right)
=\left(
\begin{matrix}
	\lambda^a_{10} && \lambda^a_{11} && \lambda^a_{12} && \lambda^a_{13} && \lambda^a_{14} \\
	\lambda^a_{20} && \lambda^a_{21} && \lambda^a_{22} && \lambda^a_{23} && \lambda^a_{24} \\
	\lambda^a_{30} && \lambda^a_{31} && \lambda^a_{32} && \lambda^a_{33} && \lambda^a_{34} \\
	\lambda^a_{40} && \lambda^a_{41} && \lambda^a_{42} && \lambda^a_{43} && \lambda^a_{44}
\end{matrix}
\right)
\left(
\begin{matrix} 1 \\ \text{RR}_m \\ \text{RR}_c \\ \text{RR}_h \\ \text{RR}_l \end{matrix}
\right) V^e_{f}$$

Here, $M_f$ is money held by financial investorst, $p_{x,e}$ is the price of equities of sector $x$, and $e_x$ is the number of equities in circulation. The expressions $\text{RR}_x$ are expected real returns in sector $x$ (discussed below), and the $\lambda^a_{mn}$ are coefficients. The indices $1\ldots 4$ correspond to the sectors $m$, $c$, $h$, and $l$.

## Conditions on allocation coefficients
Following Godley and Lavoie (and Caiani et al.), we impose some conditions on the $\lambda^a_{mn}$ coefficients. The equality between expected wealth and allocation is ensured by requiring
$$\sum_{m=1}^4 \lambda^a_{m0} = 1,\qquad\sum_{m=1}^4 \lambda^a_{mn} = 0,\> n\in\{1,\ldots,4\}$$
We also impose the symmetry constraint, that
$$\lambda^a_{mn} = \lambda^a_{nm},\> m,n\in\{1,\ldots,4\}$$
Because
$$\lambda^a_{mn} = \frac{\partial p_{m,e}e_m}{\partial \text{RR}_n},$$
the symmetry condition means that the effect on holdings of asset $n$ due to a change in the real rate of return of asset $m$ is equal to the effect on holdings of asset $m$ due to a change in the real rate of return of asset $n$.

Two special conditions must be taken into account. First, if there are no equities issued for the low-carbon capital goods sector ($e_i = 0$) or the high-carbon capital goods sector has ceased operation (`exith(-1)==1`), then the equations reduce by one dimension, and also, because of the summing-up conditions, have different coefficients $\lambda_{mn}$,
$$\left(
\begin{matrix} M_f \\ p_{c,e}e_c \\ p_{h,e}e_h \end{matrix}
\right)
=\left(
\begin{matrix}
	\lambda_{10} && \lambda_{11} && \lambda_{12} && \lambda_{13} \\
	\lambda_{20} && \lambda_{21} && \lambda_{22} && \lambda_{23} \\
	\lambda_{30} && \lambda_{31} && \lambda_{32} && \lambda_{33}
\end{matrix}
\right)
\left(
\begin{matrix} 1 \\ \text{RR}_m \\ \text{RR}_c \\ \text{RR}_h \end{matrix}
\right) V^e_f$$
Second, if the high-carbon capital goods sector is no longer producing, its share price is zero (that is, $p_{k,e} = 0$ after exit).

Taking these two special conditions into account, equity prices and money holdings are computed in a straightforward way from the foregoing equations,
```{r}
pce=ifelse(hasExited,lambda20*Vfe/ec +(lambda21*RRm+lambda22*RRc+lambda23*RRl)*Vfe/ec,ifelse(el==0,lambda20*Vfe/ec +(lambda21*RRm+lambda22*RRc+lambda23*RRh)*Vfe/ec,lambda20a*Vfe/ec+(lambda21a*RRm+lambda22a*RRc+lambda23a*RRh+lambda24a*RRl)*Vfe/ec))
ple=ifelse(hasExited,lambda30*Vfe/el+(lambda31*RRm+lambda32*RRc+lambda33*RRl)*Vfe/el,ifelse(el>0,lambda40a*Vfe/el+(lambda41a*RRm+lambda42a*RRc+lambda43a*RRh+lambda44a*RRl)*Vfe/el,0))
phe=max(0,ifelse(hasExited,0,ifelse(el==0,lambda30*Vfe/eh +(lambda31*RRm+lambda32*RRc+lambda33*RRh)*Vfe/eh,lambda30a*Vfe/eh+(lambda31a*RRm+lambda32a*RRc+lambda33a*RRh+lambda34a*RRl)*Vfe/eh)))
Mf=ifelse(hasExited,lambda10*Vfe +(lambda11*RRm+lambda12*RRc+lambda13*RRl)*Vfe,ifelse(el==0,lambda10*Vfe +(lambda11*RRm+lambda12*RRc+lambda13*RRh)*Vfe,lambda10a*Vfe +(lambda11a*RRm+lambda12a*RRc+lambda13a*RRh+lambda14a*RRl)*Vfe))
```

## Setting the base shares

Most of the values for the coefficients are set in a calibration run using a simplified version of the model. However, the base shares $\lambda^a_{m0}$ and $\lambda_{m0}$ for $m>1$ are set when running the full model.

The base share going to the consumption goods sector, $\lambda_{20}$, is set proportional to its share of total expected potential output. Until the low-carbon sector makes its IPO (that is, while $e_l = 0$), we expect the high-carbon goods sector to be operating ($y_h > 0$) and profitable ($F_h > 0$). As $\lambda_{10}$ (the base share for money) is fixed exogenously, $\lambda_{20}$ is given by

$$\lambda_{20} = \left(1-\lambda_{10}\right)\frac{\bar{y}^e_c}{\bar{y}^e_c + \bar{y}^e_h}$$
If the low-carbon sector is in the market, while the high-carbon capital goods sector has ceased operation, then
$$\lambda_{20} = \left(1-\lambda_{10}\right)\frac{\bar{y}^e_c}{\bar{y}^e_c + \bar{y}^e_l}$$
If both sectors are on the market, then the three-sector version must be used (that is, $\lambda^a_{20}$ is set), and $\lambda_{20} = 0$. In the code, this is implemented with a series of `ifelse` function. Once $\lambda_{10}$ and $\lambda_{20}$ are determined, the condition that the base shares sum to one means that $\lambda_{30}$ is given by
$$\lambda_{30} = 1-\left(\lambda_{20} + \lambda_{10}\right)$$
```{r}
lambda20=ifelse(yh==0|Fh<0,ypotce/(ypotce+ypotle),ifelse(el==0,ypotce/(ypotce+ypothe),0))*(1-lambda10)
lambda30=1-lambda20-lambda10
```

When all sectors offer shares (`exith(-1)==0` and $e_l > 0$), the coefficients are given by

$$\lambda^a_{20} = \left(1-\lambda^a_{10}\right)\frac{\bar{y}^e_c}{\bar{y}^e_c + \bar{y}^e_h + \bar{y}^e_l}$$
$$\lambda^a_{30} = \left(1-\lambda^a_{10}\right)\frac{\bar{y}^e_h}{\bar{y}^e_c + \bar{y}^e_h + \bar{y}^e_l}$$
$$\lambda^a_{40} = 1-\left(\lambda^a_{30} + \lambda^a_{20} + \lambda^a_{10}\right)$$
```{r}
lambda20a= ifelse(hasExited,0,ifelse(el==0,0,ypotce*(1-lambda10a)/(ypotce+ypothe+ypotle)))
lambda30a= ifelse(hasExited,0,ifelse(el==0,0,ypothe*(1-lambda10a)/(ypotce+ypothe+ypotle)))
lambda40a=1-(lambda20a+lambda30a+lambda10a)
```


## Expected real returns
Expected real returns on money are denoted by $\text{RR}_m$ and on investment in sector $x$ by $\text{RR}_x$. Deposits do not yield any return, so for initial holdings $M$, the real return is
$$\text{RR}_m = \frac{1}{M}\left(\frac{M}{1+\pi_c} - M\right) = \frac{-\pi_c}{1 + \pi_c}$$
In this expression, $\pi_c$ is the inflation rate for consumption goods. In the model,
```{r}
RRm=-pic/(1+pic)
```

Expected real return rate on equity holdings in sector $x$ is calculated as a weighted sum of expectations on real capital gains per share $cg_x^e$, real dividends $rd_x^e$ and real profit rate $r^e_x$, computed relative to the sector previous period market capitalization. This is done to capture the fact that there are two ways for which holding a specific assets yields a return: either dividends ($rd_x^e$) or capital gain ($cg_x^e$). We add a third term (the real profit rate $r_x^e$) to capture the fact that total profits are going to boost the hindering firm's capacity to accumulate capital and hence should be an indicator for potential capital gain. Each element is weighthed accordingly.


\textcolor{red}{Antoine to add justification for this way of determining return rates}


$$\text{RR}_x = \chi_\text{div}\left(\frac{1 + rd_x^e}{1 + \pi_c} - 1\right)
			 + \chi_\text{prof}\left(\frac{1 + r_x^e}{1 + \pi_c} - 1\right)
			 + \chi_\text{gains}\left(\frac{1 + cg_x^e}{1 + \pi_c} - 1\right)$$
The coefficients take the following values
$$(\chi_\text{div},\chi_\text{prof},\chi_\text{gains}) = \left\{\begin{array}{cc}
(\chi_1,\chi_1,\chi_{1b}), & cg_x^e \neq 0 \\
(\chi_{1a},\chi_{1a},0), & cg_x^e = 0
\end{array}\right.$$


```{r}
RRc=ifelse(round(cgce,digit=6)==0,chidiv*((expdivratec+1)/(1+pic)-1)+chiprof*((1+expprofratec)/(1+pic)-1),(chicg*((1+cgce)/(1+pic)-1)+chi1div*((1+expdivratec)/(1+pic)-1)+chi1prof*((1+expprofratec)/(1+pic)-1)))
RRh=ifelse(yh!=0&Fh>=0,ifelse(round(cghe,digit=6)==0,chidiv*((expdivrateh+1)/(1+pic)-1)+chiprof*((1+expprofrateh)/(1+pic)-1),(chicg*((1+cghe)/(1+pic)-1)+chi1div*((1+expdivrateh)/(1+pic)-1)+chi1prof*((1+expprofrateh)/(1+pic)-1))),0)
RRl=ifelse(el>0,ifelse(round(cgle,digit=6)==0,chidiv*((expdivratel+1)/(1+pic)-1)+chiprof*((1+expprofratel)/(1+pic)-1),(chicg*((1+cgle)/(1+pic)-1)+chi1div*((1+expdivratel)/(1+pic)-1)+chi1prof*((1+expprofratel)/(1+pic)-1))),0)
```



# Calibration and timeline

Finally, there is a space to insert the calibrated parameters and a declaration of the time sequence.
```{r}
#Calib
#CALIBRATION
#END OF MODEL
timeline 1 200
```
The calibrated parameters are generated from a small steady-state model that runs for a few periods to work out the transients. Most of the relationships in the steady-state model are similar to the ones in the full model. However, the relationships for the asset allocation coefficents $\lambda^a_{mn}$ and $\lambda_{mn}$ are fully specified in the steady-state model, and it is where the symmetry and summing-up relationships are enforced. The equations used to determine the coefficients in the steady-state model are reproduced here.

The coefficients in the steady-state model are denoted $\lambda^s_{mn}$, and are specified for the two-sector model with consumption and high-carbon capital goods. The base share for money holdings is set at 10%, while the base shares of consumption and capital goods are set in proportion to the capital stock in each sector,
$$\lambda^s_{10} = 0.1\qquad\lambda^s_{30}=\left(1 - \lambda^s_{10}\right)\frac{k_k}{k_c + k_k}\qquad
\lambda^s_{20} = 1 - \left(\lambda^s_{10} + \lambda^s_{30}\right)$$
In the steady-state model there is no inflation, so $\text{RR}_m = 0$. The coefficients $\lambda^s_{12}$ and $\lambda^s_{13}$ are set to the same value (which turns out to be essential for ensuring the symmetry conditions under later assumptions), so from the summing-up and symmetry constraints they are both equal to
$$\lambda^s_{13} = \lambda^s_{12} = -\frac{1}{V^e_c}\frac{\lambda^s_{10}V^e_c - M_c^{D,f}}{\text{RR}_c + \text{RR}_k}$$
The coefficient $\lambda^s_{11}$ is then determined from the adding-up constraint
$$\lambda^s_{11} = -\left(\lambda^s_{12} + \lambda^s_{13}\right)$$

> **Note:** There seems to be an error in `SSTotal.R`, where the equation is `lambda11s=-lambda13s-lambda12s-lambda13s`. One of the `lambda13s`'s should be struck, I think.


\textcolor{red}{Antoine to check the note above}
\textcolor{green}{There's something wrong in the calibration code indeed. Can someone check this out?}

We now have the response to money holdings from a change in the rate of return to either consumption or high-carbon capital goods, $\lambda^s_{12}$, $\lambda^s_{13}$. Next, we assume that the response to holdings of the other type of equity from a change in the rate of return to a given equity is one-half the money response,
$$\lambda^s_{32} = \frac{1}{2}\lambda^s_{12} \qquad \lambda^s_{23} = \frac{1}{2}\lambda^s_{13}$$
Note that the specification that $\lambda^s_{12} = \lambda^s_{13}$ ensures that with these definitions the parameters satisfy the symmetry condition that $\lambda^s_{23} = \lambda^s_{32}$. From the adding-up constraint, they then determine the own-response to a change in the rate of return, which is
$$\lambda^s_{22} = -\frac{3}{2}\lambda^s_{12} \qquad \lambda^s_{33} = -\frac{3}{2}\lambda^s_{13}$$

> **Note:** I think the equations in `SSTotal.R` are unnecessarily convoluted. They boil down to what I've written above.

\textcolor{red}{Antoine to check the note above}


The coefficients in the model are then set in the following way:
$$\lambda_{m0} = \lambda^s_{m0},\> m\in\{1,2,3\}$$
$$\lambda_{nm} = \lambda_{mn} = \lambda^s_{mn},\>m,n\in\{1,2,3\},\>n\ge m$$
For the three-sector model, the base share for the low-carbon capital sector is set to zero, so that any investment comes solely through rates of return,
$$\lambda^a_{m0} = \lambda^s_{m0},\> m\in\{1,2,3\},\quad\lambda^a_{40} = 0$$

The change in money holdings with a change in rates of return on either money or equity holdings are kept at their two-sector levels, while the response to the rate of return in the low-carbon sector is set equal to the value for the high-carbon capital goods sector,
$$\lambda^a_{1m} = \lambda^s_{1m},\>m\in\{1,2,3\},\quad \lambda^a_{14} = \lambda^s_{13}$$
The symmetry condition then requires
$$\lambda^a_{m1} = \lambda^a_{1m},\>m\in\{2,3,4\}$$
The own-response for the consumption goods sector is unchanged from the two-sector model,
$$\lambda^a_{22} = \lambda^s_{22}$$
The responses of holdings in the high-carbon capital goods sector to changes in rates of return in either the high-carbon or low-carbon capital goods sectors are one-half the response for the high-carbon capital goods sector alone,
$$\lambda^a_{24} = \lambda^a_{23} = \frac{1}{2}\lambda^s_{23}$$
From the symmetry conditions we also have
$$\lambda^a_{42} = \lambda^a_{24},\quad\lambda^a_{32} = \lambda^a_{23}$$
The response of holdings in the high-carbon capital goods sector to a change in the real rate of return in the low-carbon capital goods sector is set to one-half the response to a change in the rate of return of the consumption goods sector. Also imposing the symmetry condition, this gives
$$\lambda^a_{43} = \lambda^a_{34} = \frac{1}{2}\lambda^s_{23}$$

The own-responses in both the high-carbon and low-carbon capital goods sectors are set to the own-response for the high-carbon capital goods sector in the two-sector model,
$$\lambda^a_{44} = \lambda^a_{33} = \lambda^s_{33}$$

