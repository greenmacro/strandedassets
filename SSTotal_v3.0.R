#This is the steady state file for the new version of the model
#First step, v2.0 includes new investment function as described in the InvestmentDecision document + new depreciation based on lifetime
#Second step, v2.1 includes new portfolio equation based on expected market share.
#Third step, v2.2 includes price/productivity story
#Fourth step, v2.3 includes the usage of NPV over the capital lifetime for the portfolio equation
#Fifth step, v2.4 includes the usage of NPV over the capital lifetime for the portfolio equation, second specification
uh=uTh
khh=kstock
khc=depkhc*deltah
yh=prkh*(khh*uh)
invch=yh-invhh
invhh=depkhh
depkhc=invch
depkhh=khh/deltah
Nh=Ntot-Nc
uc=uTc
Nc=uc*khc/caplabratiohc
Ntot=LF*(1-u)
Aprh=yh/Nh
Aprc=yc/Nc
yc=khc*uc*prkh
caplabratiohh=(uc*khc+uh*khh)/Ntot
caplabratiolc=caplabratiohh
caplabratiohc=caplabratiohh
caplabratioll=gain*caplabratiohh
caplabratiohl=gain*caplabratiohh
#Calib
uTh=0.8
uTc=0.8
uTl=0.8
prkh=0.3
LF=1000
u=0.20
n=20
kstock=100
deltah=20
#1
Wc=wage
Wh=wage
pc=(1+upsilonc)*UCc
pkh=UCh/(1-(rhT*khh)/yh)
UCc=Wc/(prkh*caplabratiohc)
UCh=Wh/(prkh*caplabratiohh)
upsilonc=(rcT*pkh*khc)/(UCc*yc)
upsilonh=(rhT*pkh*khh)/(UCh*yh)
omegaTc=Wc/pc
omegaTh=Wh/pc
YDw=Wc*Nc+Wh*Nh
Invh=invhh*pkh
Invc=invch*pkh
Yh=yh*pkh 
ydw=YDw/pc
cw=Cw/pc
Cw=YDw
Vw=vw*pc
vw=(cw-xiw1*ydw)/xiw2
Mw=Vw
cf=yc-cw
Cf=cf*pc
Yc=Cf+Cw
YDf=Cf
ydf=YDf/pc
vf=(cf-xif1*ydf)/xif2
Vf=vf*pc
YPf=YDf
ws=(Wc*Nc+Wh*Nh)/(Yc+Yh) 
rcT=rhT
#CALIB
#ws=0.6
xif1=0.7
xif2=0.05
xif3=0.02
xiw1=0.9
xiw2=0.02
wage=10
rhT=0.096
#1
Mf=MfDfss
Vff=Vf
Ms=Mf+Mw
intrc=intrbasecss
intrh=intrhss
Fc=Yc-Wc*Nc-intrc*Loansc
Fh=rck*(pkh*khh)
FDh=Fh-Invh
FDc=Fc-Invc
Loansc=LoansDem-Loansh
Loansh=(Yh-Wh*Nh-Fh)/intrh
FDb=intrc*Loansc+intrh*Loansh
ec=ecss
eh=ekss
LoansDem=Ms
rck=log(intrbase/(intrh-intrbase)-1)/kappa+profrbench
rcc=(-khh*pkh*profrbench*intrc^2+khh*pkh*profrbench*intrc*intrh-LoansDem*intrbase*intrc*intrh+LoansDem*intrc*intrh^2-Nc*intrbase*intrh*Wc+Nc*intrh^2*Wc-Nh*intrbase*intrc*Wh+Nh*intrc*intrh*Wh+intrbase*intrh*Yc-intrh^2*Yc+intrbase*intrc*Yh-intrc*intrh*Yh)/(pkh*(khh*intrbase*intrc-khh*intrc^2+khc*intrbase*intrh-khc*intrh^2))
rccb=Fc/(pkh*khc)
lambda20s=1-(lambda10s+lambda30s)
#No change in these equations because xkc=xkk
lambda30s=(1-lambda10s)*khh/(khc+khh)
kappa=log(intrbase/(intrc-intrbase)-1)/(rcc-profrbench)
#Calib
lambda10s=0.18
MfDfss=1400
ecss=100
ekss=50
intrbasecss=0.04
intrhss=0.04
intrbase=0.03
beta=0.3
profrbench=0.073
x3 = (lambda10s*Vff-MfDfss)
x4 = (chidiv*FDc+chiprof*Fc)
x5 = (chidiv*FDh+chiprof*Fh)
# Ec1=(1/(2*(x4-x5)))*(2*lambda20s*Vff*x4+lambda30s*Vff*x4+4*x3*x4-lambda20s*Vff*x5+2*x3*x5-sqrt(-4*(lambda20s^2*Vff^2*x4+lambda20s*lambda30s*Vff^2*x4+4*lambda20s*Vff*x3*x4+3*lambda30s*Vff*x3*x4+3*x3^2*x4)*(x4-x5)+(-2*lambda20s*Vff*x4-lambda30s*Vff*x4-4*x3*x4+lambda20s*Vff*x5-2*x3*x5)^2))
# Ek1=lambda20s*Vff+lambda30s*Vff+x3-(lambda20s*Vff*x4)/(x4-x5)-(lambda30s*Vff*x4)/(2*(x4-x5))-(2*x3*x4)/(x4-x5)+(lambda20s*Vff*x5)/(2*(x4-x5))-(x3*x5)/(x4-x5)+(1/(2*(x4-x5)))*(sqrt(-4*(lambda20s^2*Vff^2*x4+lambda20s*lambda30s*Vff^2*x4+4*lambda20s*Vff*x3*x4+3*lambda30s*Vff*x3*x4+3*x3^2*x4)*(x4-x5)+(-2*lambda20s*Vff*x4-lambda30s*Vff*x4-4*x3*x4+lambda20s*Vff*x5-2*x3*x5)^2))
# Ec2=(1/(2*(x4-x5)))*(2*lambda20s*Vff*x4+lambda30s*Vff*x4+4*x3*x4-lambda20s*Vff*x5+2*x3*x5+sqrt(-4*(lambda20s^2*Vff^2*x4+lambda20s*lambda30s*Vff^2*x4+4*lambda20s*Vff*x3*x4+3*lambda30s*Vff*x3*x4+3*x3^2*x4)*(x4-x5)+(-2*lambda20s*Vff*x4-lambda30s*Vff*x4-4*x3*x4+lambda20s*Vff*x5-2*x3*x5)^2))
# Ek2=lambda20s*Vff+lambda30s*Vff+x3-(lambda20s*Vff*x4)/(x4-x5)-(lambda30s*Vff*x4)/(2*(x4-x5))-(2*x3*x4)/(x4-x5)+(lambda20s*Vff*x5)/(2*(x4-x5))-(x3*x5)/(x4-x5)-(1/(2*(x4-x5)))*(sqrt(-4*(lambda20s^2*Vff^2*x4+lambda20s*lambda30s*Vff^2*x4+4*lambda20s*Vff*x3*x4+3*lambda30s*Vff*x3*x4+3*x3^2*x4)*(x4-x5)+(-2*lambda20s*Vff*x4-lambda30s*Vff*x4-4*x3*x4+lambda20s*Vff*x5-2*x3*x5)^2))
Ec1=1/(2*(2*x4-2*x5))*(4*lambda20s*Vff*x4+2*lambda30s*Vff*x4+5*x3*x4-2*lambda20s*Vff*x5+x3*x5-sqrt(-4*(2*lambda20s^2*Vff^2*x4+2*lambda20s*lambda30s*Vff^2*x4+5*lambda20s*Vff*x3*x4+3*lambda30s*Vff*x3*x4+3*x3^2*x4)*(2*x4-2*x5)+(-4*lambda20s*Vff*x4-2*lambda30s*Vff*x4-5*x3*x4+2*lambda20s*Vff*x5-x3*x5)^2))
Ek1=lambda20s*Vff+lambda30s*Vff+x3-(2*lambda20s*Vff*x4)/(2*x4-2*x5)-(lambda30s*Vff*x4)/(2*x4-2*x5)-(5*x3*x4)/(2*(2*x4-2*x5))+(lambda20s*Vff*x5)/(2*x4-2*x5)-(x3*x5)/(2*(2*x4-2*x5))+(1/(2*(2*x4-2*x5)))*(sqrt(-4*(2*lambda20s^2*Vff^2*x4+2*lambda20s*lambda30s*Vff^2*x4+5*lambda20s*Vff*x3*x4+3*lambda30s*Vff*x3*x4+3*x3^2*x4)*(2*x4-2*x5)+(-4*lambda20s*Vff*x4-2*lambda30s*Vff*x4-5*x3*x4+2*lambda20s*Vff*x5-x3*x5)^2))
Ec2=(1/(2*(2*x4-2*x5)))*(4*lambda20s*Vff*x4+2*lambda30s*Vff*x4+5*x3*x4-2*lambda20s*Vff*x5+x3*x5+sqrt(-4*(2*lambda20s^2*Vff^2*x4+2*lambda20s*lambda30s*Vff^2*x4+5*lambda20s*Vff*x3*x4+3*lambda30s*Vff*x3*x4+3*x3^2*x4)*(2*x4-2*x5)+(-4*lambda20s*Vff*x4-2*lambda30s*Vff*x4-5*x3*x4+2*lambda20s*Vff*x5-x3*x5)^2))
Ek2=lambda20s*Vff+lambda30s*Vff+x3-(2*lambda20s*Vff*x4)/(2*x4-2*x5)-(lambda30s*Vff*x4)/(2*x4-2*x5)-(5*x3*x4)/(2*(2*x4-2*x5))+(lambda20s*Vff*x5)/(2*x4-2*x5)-(x3*x5)/(2*(2*x4-2*x5))-1/(2*(2*x4-2*x5))*(sqrt(-4*(2*lambda20s^2*Vff^2*x4+2*lambda20s*lambda30s*Vff^2*x4+5*lambda20s*Vff*x3*x4+3*lambda30s*Vff*x3*x4+3*x3^2*x4)*(2*x4-2*x5)+(-4*lambda20s*Vff*x4-2*lambda30s*Vff*x4-5*x3*x4+2*lambda20s*Vff*x5-x3*x5)^2))
pce=Ec1/ec
phe=Ek1/eh
RRc=x4/(ec*pce)
RRcT=FDc/(ec*pce)
RRh=x5/(eh*phe)
RRhT=FDh/(eh*phe)
RRlT=RRhT
lambda12s=-x3/(Vff*(RRc+RRh))
lambda33s=-3*lambda12s/2
lambda22s=lambda33s
lambda13s=lambda12s
lambda32s=lambda12s/2
lambda42a=lambda32s
lambda43a=lambda23s
lambda11a=lambda11s-lambda14a
lambda14a=lambda13s
lambda22a=-2*lambda12s
lambda33a=-2*lambda13s
lambda44a=-2*lambda14a
lambda41a=lambda14a
lambda24a=lambda42a
lambda34a=lambda43a
profratec=FDc/(ec*pce)
profrateh=FDh/(eh*phe)
lambda23s=lambda32s
eta0c=(-eta3*qc-eta1*uTc+eta2*rintrc*lambdac)
lambdac=Loansc/(pkh*khc)
lambdacT=Loansc/(pkh*khc)
qc=ec*pce/(pkh*khc-Loansc)
eta0k=(-eta3*qh-eta1*uTh+eta2*rintrh*lambdah)
lambdah=Loansh/(pkh*khh)
lambdahT=Loansh/(pkh*khh)
lambdalT=lambdahT
qh=eh*phe/(pkh*khh-Loansh)
rintrc=intrc
rintrh=intrh
Omega2=(omegaTh-Omega0-Omega1*log(Aprc))/log(Ntot/LF)
lambda11s=-lambda13s-lambda12s
#Calibration
Omega3=0
eta1=0.05
eta2=0.30
eta3=0.05
Omega0=0.3
Omega1=0.1
#Shock and free parameters
prkl=prkh
gain=1.1
epsilon=0.1
iota=0.25
chi=0.25
nu=0.25
psih=10
psic=10
psil=10
chi1div=0.375
chi1prof=0.375
chicg=0.25
rho=0.03
tau=0.03
nLoans=5
eta0i=0.06
eta3i=0.01
entry=20
back=4
zeta=0.1
eta=0
deltal=20
#TODO: deal with a proper calibration of beta
pkl= 75
tuclc = Wc/(prkl * caplabratiolc) + pkl/(deltal * prkl)
tuchc = Wc/(prkh * caplabratiohc) + pkh/(deltah * prkh)
beta1 = 150
#beta_inv=0.9
beta0 = 1
#CALIB
# #RealSS
# chi=0.25
# nu=0.25
# Psik=10
# Psic=10
# Psii=10
# xi1a=1/3
# xi1=0.375
# xi1b=0.25
# lambda10s=0.1
# McDfss=500
# nLoans=5
# lk=0.400888
# li=0.400888
# rcT=0.096
# rhT=0.096
# intrbaseT=0.096
chiprof=1/3
chidiv=1/3
exith=0
irrational=0
irrational2=0
irrational3=0.04
initlambda=0
irrational4=0
theta=0
phi=0
t=0
timeline 1 3