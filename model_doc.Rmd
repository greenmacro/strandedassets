---
title: "Stranded Assets Model Documentation"
author: "Green Macro Team"
date: "PUT DATE HERE"
output:
  pdf_document:
    toc: yes
    toc_depth: '2'
  html_document:
    toc: yes
    toc_depth: 2
---

```{r setup, include=FALSE, purl=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval=FALSE)
```

# Introduction
This is a working document that relates the stranded assets formal model ("the model") with its implementation using the R package PK-SFC ("the code"). Note the following generic notation and standards used in the code:

* Uppercase: nominal values; lowercase: real values
* `varname` + `e`: an expected future value (except for prices of equities)
* `varname` + `mean`: a running average of historical values
* `varname` + `gr`: the prior one-period growth rate
* `varname` + `k`, `i`, `c` or `b`: sector-specific variables:
	+ `k`: conventional capital
	+ `i`: innovative capital
	+ `c`: consumption goods
	+ `b`: banks

In the equations below, the `mean` is indicated by an overbar, where the average is taken over the previous four periods. For an arbitrary variable $x$,
$$\bar{x} \equiv \frac{1}{4}\sum_{t=-4}^{-1} x_t$$
The growth rate from the previous period, `gr`, is indicated a "hat". For an abitrary variable $x$,
$$\hat{x} \equiv \frac{x - x_{-1}}{x_{-1}}$$

# Time and transition
Time is tracked by a variable $t$, which increments by one in each time step, for a timeline that extends from 1 to 500 steps,
```{r}
t=t(-1)+1
timeline 1 500
```

The innovative sector enters after time step $n$, with transitional dynamics in the first period after entry
```{r}
n = 20
firstPeriodInov=(t==(n+1))
```
Moreover, after starting, the innovative sector delays entry into markets (that is, issues an IPO) for a period ``entry`` because it is assumed to be too small initially to attract financial flows. Once it has grown enough, firms producing innovative capital goods try to rise funds via an IPO. Model experiments have shown that if the innovators try to enter the financial market too soon it hurts them because they can't raise enough money via the IPO and thus are over indebted.
```{r}
entry = 20
```

Investors exit the conventional capital goods sector as soon as either: a) production goes to zero or b) dividends paid by the sector go to zero,
```{r}
exitk=ifelse(exitk(-1)==1,1,ifelse(yk==0|Fk<0,1,0))
```

The loan period is given by `nLoans`, referred to in equations below by $n_\text{loans}$,
```{r}
nLoans = 5
```

For several variables, expectations are formed through an adaptive process. A common term in each of these expressions takes historical growth into account when anticipating future growth. The historical average growth rate is multiplied by a parameter $\eta$, which is zero if historical growth is ignored when forming expectations and one if future growth is expected to match historical average growth.
```{r}
eta = 0
```

# Wealth and Income 

## Wealth
For either capitalists or workers (denoted generically by subscript $i$), nominal wealth is given by previous period wealth plus disposable income net of consumption,
$$V_i = V_{i,-1} + \left(YD_i - C_i\right)$$
```{r}
Vc=Vc(-1) + (YDc-Cc)
Vw=Vw(-1)+(YDw-Cw)
```
Expected wealth in the next period is calculated using the same formula, but with expected disposal income,
$$V_c^e = V_{i,-1} + \left(YD_i^e - C_i\right)$$
```{r}
Vce=Vc(-1) + YDce - Cc
```
We further distinguish capitalists' financial wealth $V_{ec}$, equal to the value of equity shares plus money held for financial reasons (as opposed to being held for transactions). Denoting the number of shares in sector $x$ by $e_x$, the equity price by $p_{x,e}$, and money that capitalists wish to hold for financial reasons by $M_c^{D,f}$,
$$V_{ec} = p_{c,e} e_c + p_{k,e} e_k + p_{i,e} e_i + M_c^{D,f}$$
```{r}
Vec=pce*ec+pke*ek +pie*ei +McDf
```
The expected value of financial wealth in the next period is given by the expected value of total wealth less capitalists' desired money holdings for transactions purposes $M_c^D$,
$$V_{ec}^e = V_c^e - M_c^D$$
```{r}
Vece=Vce-McD
```

## Labor and wages
Labor is employed in all three productive sectors. The capital-to-labor ratio for conventional and innovative capital $\ell_k$ and $\ell_l$ (`lk` and `li` in the code) can, in principle, be different, but they are set to the same value in current runs of the model,
```{r}
lk= 0.400888222893241 
li= 0.400888222893241 
```
The general expression for employment $N_y$ in sector $y$ is the sum of utilization times capital stock divided by the capital per labor ratio for both conventional and innovative capital,
$$N_y = u_{iy}\frac{i_{y,-1}}{\ell_i} + u_{ky}\frac{k_{y,-1}}{\ell_k}$$
Additional conditions ensure that employment is zero in the innovative sector before it starts producing, while employment is zero in the conventional capital goods sector once it has stopped operations. Also, only conventional capital is ever used in the conventional capital goods sector,
```{r}
Nc=uic*ic(-1)/li + ukc*kc(-1)/lk
Ni=ifelse(t<=(n+entry)&t>(n+1),ifelse((inii+inci)!=0,uii*ii(-1)/li + uki*ki(-1)/lk,0),0)+ifelse(t>(n+entry),ifelse((inii+inci)!=0,uii*ii(-1)/li+uki*ki(-1)/lk,0),0)
Nk=ifelse(exitk(-1)!=1&inktot>0,ukk*kk(-1)/lk,0)
```
Total employment is the sum of sectoral employment,
$$N_\text{tot} = N_c + N_i + N_k$$
```{r}
Ntot=Nc+Nk+Ni
```

The size of the labor force is set as an exogenous parameter, $LF$,
```{r}
LF = 1000
```
The employment rate is then total employment divided by the labor force, $N_\text{tot}/LF$.

Average labor productivity in sector $x$, $\overline{\lambda}^N_x$ (denoted `Aprx` in the code) is then given by real output from the sector, $y_x$, divided by sector employment,
$$\overline{\lambda}^N_x = \frac{y_x}{N_x}$$
After first ensuring that innovative and conventional capital are in use, this is represented in code by
```{r}
Aprc=yc/Nc
Apri=ifelse(Ni>0,yi/Ni,0.001)
Aprk=ifelse(exitk(-1)!=1&Nk>0,yk/Nk,0)
```
*NB: Are these initial values?*
```{r}
Aprc= 0.120266466867972 
Apri=0 
Aprk= 0.120266466867972 
```

In each time period, firms set a target real wage, possibly after negotiations with labor. For sector $x$, this is denoted $\omega^T_x$ (`omegaTx` in the code). The target real wage increases with average labor productivity and the employment ratio. The general equation is
$$\omega^T_x=\Omega_0 + \Omega_1 \log \overline{\lambda}^N_x + \Omega_2 \log \frac{N_\text{tot}}{LF}$$
With a check to ensure that the conventional capital goods sector is still operation, this is represented in code as
```{r}
omegaTc=Omega0+Omega1*log(Aprc)+ Omega2*log(Ntot/LF)
omegaTk=ifelse(exitk(-1)!=1&Nk>0,Omega0+Omega1*log(Aprk)+Omega2*log(Ntot/LF),0)
omegaTi=Omega0+Omega1*log(Apri)+Omega2*log(Ntot/LF)
Omega0= 0.3 
Omega1= 0.1 
Omega2= 0.220964898869873 
```

The nominal wage is then equal to the nominal wage from the previous period plus a correction based on the gap between the target and the realized real wage. For a general sector $x$, the equation for the real wage $W_x$ is
$$W_x = W_{x,-1} + \Omega_3\left(\omega^T_{x,-1} - \frac{W_{x,-1}}{p_{x,-1}}\right) $$
With conditional statements taking into account whether the innovative and conventional capital goods sectors are producing, this is represented in code as
```{r}
Wc=Wc(-1) + Omega3*(omegaTc(-1) - Wc(-1)/pc(-1))
Wk=ifelse(exitk(-1)==0,Wk(-1) + Omega3*(omegaTk(-1) - Wk(-1)/pc(-1)),0)
Wi=ifelse(t<=(n+1),Wk(-1),Wi(-1) + Omega3*(omegaTi(-1) - Wi(-1)/pc(-1)))
Omega3= 0.5 
```
[*NB:* I would feel more comfortable with a more behaviorally-grounded expression. Yes, what workers want is a real wage, and they notice prices But the negotiation is in terms of the nominal wage. Realness enters in two ways -- who shares in any efficiency gains? And is there an adjustment for expected inflation?]

## Profits and dividends
The basic profit equation is the value of output, less the wage bill, less payments on loans held in the previous period. For a sector $x$,
$$F_x = Y_x - W_xN_x - r_{lx}L_{x,-1}$$
In the capital goods sectors this expression is modified in the following ways:

* In the conventional capital goods sectors, if there is investment in the sector and firms have not exited the sector then it pays dividends, else dividends are zero;
* In the innovative sector, there are two conditions (but at present they contain the same equations, so effectively after innovative capital is introduced the sector begins to pay dividends)

```{r}
Fc=Yc-Wc*Nc-rlc*Lc(-1)
Fi=ifelse(t<=(n+entry)&t>(n+1),Yi-Wi*Ni-rli*Li(-1),0)+ifelse(t>(n+entry),Yi-Wi*Ni-rli*Li(-1),0)
Fk=ifelse(exitk(-1)!=1&inktot>0,Yk-Wk*Nk-rlk*Lk(-1),0)
```

The basic equation for expected profits in sector $x$ is given by an adaptive expectations model in which both historical growth and the accuracy of past forecasts influence the result,
$$F_x^e = \left(1 + \eta\hat{F}_x\right)\bar{F}_x + \nu\left(F_{x,-1} - F^e_{x,-1}\right),\>\nu=0.25$$
The exception is for the conventional capital goods sector, where dividends go to zero after "exit"
```{r}
Fce=Fcmean+Fcmean*Fcgr*eta+nu*(Fc(-1)-Fce(-1))
Fie=Fimean+Fimean*Figr*eta+nu*(Fi(-1)- Fie(-1))
Fke=ifelse(exitk(-1)!=1,Fkmean+Fkmean*Fkgr*eta+nu*(Fk(-1)-Fke(-1)),0)
nu = 0.25 
```

Dividends are distributed to capitalists from productive sectors and the banking sector. For a productive sector $x$, the basic expression for dividends is profits $F_x$ less autonomous investment $I_x$, as long as the result is positive,
$$FD_x = \max\left(F_x - I_x\right)$$
This is then modified to take into account the introduction of innovative capital, as well as a correction for money holdings after "entry". For that last consideration, if previous period money held by the innovative sector, $M_{i,-1}$, plus profits is more than sufficient to pay dividends then they will be paid, otherwise they won't. 
```{r}
FDi=ifelse(t<=(n+entry)&t>(n+1),max(Fi-Ii,0),0)+ifelse(t>(n+entry),ifelse(Ii-Fi-Mi(-1)<=0,max(Fi-Ii,0),0),0)
FDc=max(Fc-Ic,0)
FDk=ifelse(exitk(-1)!=1&inktot>0,max(Fk-Ik,0),0)
```
[*NB:* Alter this for dividend policy.]

Banks have zero net worth, so they pay out their income from loan repayments as dividends. However, if the conventional capital goods sector goes bankrupt then banks must write off the loans, which is a loss that offsets income from loan payments,
```{r}
FDb= rlc*Lc(-1) +ifelse(yk!=0&Fk>=0,rlk*Lk(-1),-Lk(-1)) + rli*Li(-1)
```

Expectations are set, as for other variables, by an adaptive expectations model,
$$FD_s^e = \left(1 + \eta\widehat{FD}_s\right)\overline{FD}_s + \chi\left(FD_{s,-1} - FD^e_{s,-1}\right),\>\chi=0.25$$
Expected dividends for the conventional capital goods sector are zero after "exit",
```{r}
FDbe= FDbmean+FDbmean*FDbgr*eta+chi*(FDb(-1)- FDbe(-1))
FDie= FDimean+FDimean*FDigr*eta+chi*(FDi(-1)-FDie(-1))
FDce=FDcmean+FDcmean*FDcgr*eta+chi*(FDc(-1)-FDce(-1))
FDke=ifelse(exitk(-1)!=1,FDkmean+FDkmean*FDkgr*eta+chi*(FDk(-1)-FDke(-1)),0)
chi = 0.25 
```


# Consumption
There are two consumer classes in the model, wage and profit earners. Real consumption by wage earners is $c_w$ and by capitalists is $c_c$. These are calculated in stages. First, planned consumption is calculated for both classes as a function of disposable income and previous-period wealth,
$$c_{w1} = \xi_{w1}y_{dw}^e + \xi_{w2}v_{w,-1}$$
$$c_{c0} = \xi_{c1}y_{dc}^e + \xi_{c2}v_{c,-1}$$
```{r}
cw1= xiw1*ydwe + xiw2*vw(-1)
cc0=xic1*ydce+xic2*vc(-1)
xic1 = 0.6
xic2 = 0.1
```
Next, because capitalists' income can be negative, planned consumption is set to zero in case the calculation above gives a negative result,
$$c_{c1} = \frac{1}{2}\left(c_{c0} + |c_{c0}|\right) = \max\left(0,c_{c0}\right)$$
```{r}
cc1=(cc0+abs(cc0))/2
```

It is possible that planned consumption exceeds the capacity of the economy to produce consumption goods. Denote capital productivity of conventional capital goods by $\kappa_k$ (in the code it is `prk`) and innovative capital goods by $\kappa_i$ (`pri` in the code). Then, denoting real capital stocks $k_c$ and $i_c$ in the consumption goods sector, real output of consumption goods $c_s$ from the previous period is
$$c_s = k_{c,-1}\kappa_k + i_{c,-1}\kappa_i$$
Excess production of consumption goods over planned consumption is $x_1$ (`exc1` in the code),
$$x_1 = c_s - c_{w1} - c_{c1}$$
This might be negative, in which case actual consumption must be less than planned. The deficit (a negative number, if it is exists) is given by a variable $x_2$ (`exc2` in the code),
$$x_2 = \frac{1}{2}\left(x_1 - |x_1|\right)$$
```{r}
cs=kc(-1)*prk+ic(-1)*pri
exc1=cs-cw1-cc1
exc2=(exc1-abs(exc1))/2
pri = 0.33
prk = 0.3
```

The deficit is then shared by wage earners and capitalists in proportion to their planned expenditure,
$$c_w = c_{w1}+\frac{c_{w1}}{c_{w1} + c_{c1}}x_2$$
$$c_c = c_{c1}+\frac{c_{c1}}{c_{w1} + c_{c1}}x_2$$
```{r}
cw=cw1+cw1/(cw1+cc1)*exc2
cc=cc1+cc1/(cw1+cc1)*exc2
```

Once real consumption has been calculated, it is converted to nominal values using the price of consumption goods:
```{r}
Cw=cw*pc
Cc=cc*pc
```

## Purchasing power of wealth
Real purchasing power out of wealth is nominal wealth deflated by the cost of consumption goods,
$$v_i = \frac{V_i}{p_c}$$
```{r}
vc=Vc/pc
vw=Vw/pc
```

## Wage earners' disposable income
Nominal disposable income for wage earners is given by the sum of wages from all three sectors:
$$YD_w = W_cN_c + W_kN_k + W_iN_i$$
```{r}
YDw=Wc*Nc+Wk*Nk+Wi*Ni
```
Expected nominal income in the next period is given by an adaptive expectations model in which wage-earners' base expectation incorporates some proportion of growth during the previous period, adjusted by a term proportional to the previous-period error. Using a bar for an average, and a hat to indicate to a growth rate,
$$YD_w^e = \left(1 + \eta\widehat{YD}_w\right)\overline{YD}_w + \epsilon \left(YD_{w,-1}-YD_{w,-1}^e\right),\>\epsilon=0.25$$
Then the expected change in real income is given by two terms, one a deflated version of their nominal income expectations, the second a correction of nominal wealth for price inflation of consumption goods,
$$yd_w^e = \frac{1}{p_c}\left(YD_w^e - \pi_c V_{w,-1}\right)$$
```{r}
YDwe= YDwmean+YDwmean*YDwgr*eta+epsilon*(YDw(-1)-YDwe(-1))
ydwe= YDwe/pc-(pic*Vw(-1))/pc
epsilon = 0.25
```

### Capitalists' disposable income
Disposable income for capitalists is given by the sum of profit income and capital gains,
$$YD_c = YP_c + CG$$
```{r}
YDc=YPc + CG
```
As for wage income, the purchasing power of capitalists' nominal wealth is corrected for inflation in the price of consumption goods,
```{r}
ydc=YDc/pc - pic*Vc(-1)/pc
```

Also, expected real and nominal income is calculated similar to that for wage-earners, except that expectations are in terms of dividends and capital gains,
```{r}
YDce1=YPce + CGce+CGke+CGie
YDce=(YDce1+abs(YDce1))/2
ydce=YDce/pc-(pic*Vc(-1))/pc
```

Profit income is given by dividends $FD_s$ from different sectors $s=\{c,k,b,i\}$,
$$YP_c = FD_c + FD_k + FD_b + FD_i$$
An equivalent sum applies to expected values of these variables,
```{r}
YPc=FDc+FDk+FDb+FDi
YPce=FDce+FDke+FDie+FDbe
```

Capital gains are determined by the expected change in the price per share in different sectors multiplied by the number of shares $e_j$ held in the previous period,
$$CG = \sum_{j\in \{c,k,i\}} e_{j,-1}\Delta p_j^e$$
There is a special consideration in the first period in which shares are held in the innovative sector,
```{r}
CG = ifelse(ei(-1)==0&ei>0,ec(-1)*(pce-pce(-1))+ek(-1)*(pke-pke(-1)),ec(-1)*(pce-pce(-1))+ek(-1)*(pke-pke(-1))+ ei(-1)*(pie-pie(-1)))
```
In terms of individual sectors, capital gains are given by the terms in the sum above, but with some conditions. For the conventional capital sector, capital gains are zero if real output has gone to zero, while for the innovative sector it is necessary to catch discontinuities when it is first introduced.

[*NB:* This could be modified in future, because I think that, as calculated, CG can differ from the sum of CGc, CGk and CGi.]


```{r}
CGc=ec(-1)*(pce-pce(-1))
CGk=ifelse(yk!=0,ek(-1)*(pke-pke(-1)),0)
CGi=ifelse(ei(-1)!=0&pie(-1)!=0,ei(-1)*(pie-pie(-1)),0)
```
Real capital gains are calculated as nominal gains divided by the price of holdings, which is the product of price per share and the number of shares held, with some checks for whether innovative capital has been introduced or not,
```{r}
cgc=CGc/(pce(-1)*ec(-1))
cgk=ifelse(yk!=0&Fk>=0,CGk/(pke(-1)*ek(-1)),0)
cgi=ifelse(ei(-1)!=0&pie(-1)!=0,CGi/(pie(-1)*ei(-1)),0)
```

Nominal expected capital gains are given by an adaptive expectations model as used elsewhere. For sector $x$,
$$CG_x^e = \left(1 + \eta\widehat{CG}_x\right)\overline{CG}_x + \theta \left(CG_{x,-1}-CG_{x,-1}^e\right),\>\theta=0.25$$
```{r}
CGce= CGcmean+CGcmean*CGcgr*eta+theta*(CGc(-1)-CGce(-1))
CGke=ifelse(exitk(-1)!=1,CGkmean+CGkmean*CGkgr*eta+theta*(CGk(-1)-CGke(-1)),0)
CGie =CGimean+CGimean*CGigr*eta+theta*(CGi(-1)-CGie(-1))
theta = 0.25
```

Real expected capital gains are deflated by the same price as for observed capital gains,
```{r}
cgce = CGce/(ec(-1)*pce(-1))
cgke=ifelse(exitk(-1)!=1,CGke/(ek(-1)*pke(-1)),0)
cgie=ifelse(t<(n+1),ifelse(ei(-1)==0|pie(-1)==0,0,(CGie/(ei(-1)*pie(-1)))),0)
```

# Money and banking
Total money in the system is $M_s$, the sum of money held by wage-earners, $M_w$, capitalists, $M_c$, and innovators. Innovators hold a stock $M_i$ of cash after their IPO, which is used to reduce the quantity of loans or pay dividends.
```{r}
Ms=Mw+Mc+Mi
```

## Money held by wage earners
For wage earners, their money holdings constitute their wealth,
```{r}
Mw=Vw
```
While this may be "money in the bank", banks do not pay interest on the money holdings of wage-earners and do not issue them loans, so wage-earners' money holdings are passive.

## Money held by capitalists
Capitalists wish to hold money both for transactions (money for consumption, $M_c^D$) and as a store of wealth (money for finance, $M_c^{D,f}$). For transactions purposes, capitalists' desired money holdings are given as a fraction $\beta$ of nominal consumption,
$$M_c^D = \beta C_c,\>\beta=0.3$$
```{r}
McD=beta*Cc
beta = 0.3
```
Actual holdings of cash are given by the difference between nominal wealth $V_c$ and wealth held as non-money equities,
$$M_c = V_c - \left(V_{ec} - M_c^{D,f}\right) = M_c^{D,f} + V_c - V_{ec}$$
```{r}
Mc=McDf+Vc -Vec
```
Money held for financial purposes is discussed later in the context of portfolio allocation.

## Money held by innovators
After innovative firms go public, they have a store of cash. Initially they have no cash on hand, and they operate with loans, so just before the IPO the value of their money holdings is zero. When they go public, they issue 100 shares of new equity, $e_i^s = 100$ at the market's expected price, $p_i^e$. This gives a one-time cash injection, while after the IPO they add to cash holdings from their profits, $F_i$, net of new investment $I_i$ and dividends $FD_i$. The innovative firms put a priority on growth and paying dividends to investors, so from the time they go public onwards, they use their money for those purposes first,
$$M_{i,\text{left}} = M_{i,-1} + F_i + e_i^s p_i^e - I_i - FD_i$$
```{r}
Mileft=Mi(-1)+Fi+esi*pie-Ii-FDi
```
They then pay down their loans if they can, by making a regular payment calculated as total outstanding loans $L_i$ from the previous period divided by the loan term $n_\text{loans}$. After that payment, money holdings are
$$M_i = \max\left(M_{i,\text{left}} - \frac{L_{i,-1}}{n_\text{loans}},0\right)$$
$$L_i = L_{i-1} - \min\left(\frac{L_{i,-1}}{n_\text{loans}}, M_{i,\text{left}}\right)$$
```{r}
Mi=max(Mileft-Li(-1)/nLoans,0)
Li=Li(-1)-min(Li(-1)/nLoans,Mileft)
```
Note that $M_{i,\text{left}}$ can be negative, or is insufficient to make a full payment, in which case innovative firms take on new loans.

## Loans
Loans to the innovative sector are discussed above. For the consumer and conventional capital goods sectors, the basic formula is that current outstanding loans equal previous period loans, plus investment net of profits (or zero, if profits exceed investment), less the value of new equity issues. For an arbitrary sector $x\in\{c,k\}$,
$$L_x = L_{x,-1} + \max\left(I_x-F_x,0\right) - e_x^s * p_x^e$$
Note that the net effect may be either an addition of new loans or a paying down of prior loans. Also, for the conventional capital goods sector, if output or profits are zero because the innovative sector has superseded it, then there is no demand for loans. These are captured in the following equations:
```{r}
Lc=Lc(-1)+Ifc-esc*pce
Lk=ifelse(yk!=0&Fk>=0,Lk(-1)+Ifk-esk*pke,0)
```
[*NB:* This is one place to alter the behavior towards dividends. Firms should strive to meet dividend payments.]

The total demand for loans is the sum of loans to each productive sector,
$$L_d = \sum_{x\in\{c,k,i\}} L_x$$
```{r}
Ld=Lc+Lk+Li
```
Banks follow an accomodationist policy in which the demand for loans is automatically supplied (albeit at different rates of interest),
$$L_s = L_d$$

# Firm investment plans and capital stock
Total nominal investment in sector $x$ is denoted $I_x$. It is equal to real investment in each type of capital ($i_{xk}$ or $i_{xi}$), multiplied by the price,
$$I_x = p_k i_{xk} + p_i i_{xi}$$
In the code, $i_{xk}$ is `inxk`, so, ensuring the sector is active, the model equations are
```{r}
Ic=inck*pk+inci*pi
Ik=ifelse(exitk(-1)==0, ink*pk,0)
Ii=ifelse(firstPeriodInov,inik*pk,inii*pi)
```
Note that innovative capital is never used by the conventional capital goods sector.

Of the total investment required, some must be financed if profits are insufficient. The excess of investment over profits in sector $x$, if it is positive, is given by $I_{fx}$.
```{r}
Ifk=ifelse(exitk(-1)!=1&inktot>0,max(Ik-Fk,0),0)
Ifi=ifelse(t<=(n+entry)&t>(n+1),max(Ii-Fi,0),0)+ifelse(t>(n+entry),max(Ii-Fi-Mi(-1),0),0)+ifelse(t==(n+1),Ii,0)
Ifc=max(Ic-Fc,0)
```
[*NB:* Have to modify here also to get a fixed dividend, because the amount available for needed investment should be after dividends.]

The share of investment funded by equity emissions in sector $x$ is denoted by $\Psi_x$, where
$$\Psi_x = \frac{1}{1 + e^{\psi_x\left(r_x^T - cg_{x,-1} - r_{lx}\right)}} $$
In this expression, $r_x^T$ is the target return on capital, $cg_{x,-1}$ are real capital gains from the previous period, $r_{lx}$ is the interest rate on loans, and $\psi_x$ is a calibration parameter. With some conditionals to ensure the sector is active, the model expressions are
```{r}
Psik=ifelse(exitk(-1)!=1&inktot>0,1/(1+exp(psik*(rkT-cgk(-1)-rlk))),0)
Psii=0+(t>(n+entry))*(1/(1+exp(psii*(riT-cgi(-1)-rli))))
Psic=1/(1+exp(psic*(rcT-cgc(-1)-rlc)))
```

New equity issue in sector $x$ is $e^s_x$, and is determined by the nominal value of the needed finance and the current value of the equity,
$$e^s_x = \frac{\Psi_x I_{fx}}{p_{e,x,-1}}$$
```{r}
esc=(Psic*Ifc)/pce(-1)
esk=ifelse(exitk(-1)!=1&inktot>0,(Psik*Ifk)/pke(-1),0)
esi=ifelse(t>(n+entry),(psii*Ifi)/pie(-1),ifelse(t==(n+entry),100,0))
```
Total equities are then given by a running total,
$$e_x = e_{x,-1} + e^s_x$$
```{r}
ec=ec(-1)+esc
ek=ek(-1)+esk
ei=ifelse(t<=(n+entry)&t>(n+1),ei(-1)+esi,0)+ifelse(t>(n+entry),ei(-1)+esi,0)
```
[*NB:* So, no repos? That's an increasingly common alternative to dividends.]

## Retained profits
Retained profits are calculated as the difference between total profits and dividends as `REk`, `REi`, `REc`,
```{r}
REk=ifelse(exitk(-1)!=1&inktot>0,Fk-FDk,0)
REi=ifelse(t<=(n+entry)&t>(n+1),Fi-FDi,0)+ifelse(t>(n+entry),Fi-FDi,0)
REc=Fc-FDc
```

## Capital stock
The real capital stock in sector $x$ consists of conventional ($k_x$) and innovative ($i_x$) stocks. The change in stocks is given by new real investment $i_{xk}$ and $i_{xi}$, net of depreciation,
$$k_x = k_{x,-1} + i_{xk} - d_{kx}$$
$$i_x = i_{x,-1} + i_{xi} - d_{ix}$$
Taking into account the fact that innovative capital is not used by the conventional capital goods sector, and ensuring that the sector is active, in the model code the corresponding equations are
```{r}
kc=kc(-1)+inck-depkc
ki=ifelse(firstPeriodInov,inik,ki(-1)-depki)
kk=ifelse(exitk(-1)==0,kk(-1)+ink-depkk,0)
ic=ic(-1)+inci-depic
ii=ifelse(firstPeriodInov,0,ii(-1)-depii+inii)
```

### Depreciation
In general, depreciation in sector $x$ of capital type $k$, with a lifetime $n$, can be written
$$d(k_x) = \sum_{\tau = -1}^{-n} \alpha_\tau i_{xk,\tau},\>\text{where}\>\sum_{\tau = -1}^{-n} \alpha_\tau = 1$$
In the present model, $n=19$ and
$$\alpha_{-1} = -e^{-n},$$
$$\alpha_\tau =  e^{-(n+\tau)}\left(1 - \frac{1}{e}\right),\>\tau\in\{-2,\ldots,-n\}$$
In code, this is
```{r}
depkk=ink(-1)*(-5.602796e-09+1.522998e-08)+ink(-2)*(-1.522998e-08+4.139938e-08)+ink(-3)*(-4.139938e-08+1.125352e-07)+ink(-4)*(-1.125352e-07+3.059023e-07)+ink(-5)*(-3.059023e-07+8.315287e-07)+ink(-6)*(-8.315287e-07+2.260329e-06)+ink(-7)*(-2.260329e-06+6.144212e-06)+ink(-8)*(-6.144212e-06+1.67017e-05)+ink(-9)*(-1.67017e-05+4.539993e-05)+ink(-10)*(-4.539993e-05+0.0001234098)+ink(-11)*(-0.0001234098+0.0003354626)+ink(-12)*(-0.0003354626+0.000911882)+ink(-13)*(-0.000911882+0.002478752)+ink(-14)*(-0.002478752+0.006737947)+ink(-15)*(-0.006737947+0.01831564)+ink(-16)*(-0.01831564+0.04978707)+ink(-17)*(-0.04978707+0.1353353)+ink(-18)*(-0.1353353+0.3678794)+ink(-19)*(1-0.3678794)+ink(-1)*5.602796e-09
depki=inik(-1)*(-5.602796e-09+1.522998e-08)+inik(-2)*(-1.522998e-08+4.139938e-08)+inik(-3)*(-4.139938e-08+1.125352e-07)+inik(-4)*(-1.125352e-07+3.059023e-07)+inik(-5)*(-3.059023e-07+8.315287e-07)+inik(-6)*(-8.315287e-07+2.260329e-06)+inik(-7)*(-2.260329e-06+6.144212e-06)+inik(-8)*(-6.144212e-06+1.67017e-05)+inik(-9)*(-1.67017e-05+4.539993e-05)+inik(-10)*(-4.539993e-05+0.0001234098)+inik(-11)*(-0.0001234098+0.0003354626)+inik(-12)*(-0.0003354626+0.000911882)+inik(-13)*(-0.000911882+0.002478752)+inik(-14)*(-0.002478752+0.006737947)+inik(-15)*(-0.006737947+0.01831564)+inik(-16)*(-0.01831564+0.04978707)+inik(-17)*(-0.04978707+0.1353353)+inik(-18)*(-0.1353353+0.3678794)+inik(-19)*(1-0.3678794)+inik(-1)*5.602796e-09
depii=inii(-1)*(-5.602796e-09+1.522998e-08)+inii(-2)*(-1.522998e-08+4.139938e-08)+inii(-3)*(-4.139938e-08+1.125352e-07)+inii(-4)*(-1.125352e-07+3.059023e-07)+inii(-5)*(-3.059023e-07+8.315287e-07)+inii(-6)*(-8.315287e-07+2.260329e-06)+inii(-7)*(-2.260329e-06+6.144212e-06)+inii(-8)*(-6.144212e-06+1.67017e-05)+inii(-9)*(-1.67017e-05+4.539993e-05)+inii(-10)*(-4.539993e-05+0.0001234098)+inii(-11)*(-0.0001234098+0.0003354626)+inii(-12)*(-0.0003354626+0.000911882)+inii(-13)*(-0.000911882+0.002478752)+inii(-14)*(-0.002478752+0.006737947)+inii(-15)*(-0.006737947+0.01831564)+inii(-16)*(-0.01831564+0.04978707)+inii(-17)*(-0.04978707+0.1353353)+inii(-18)*(-0.1353353+0.3678794)+inii(-19)*(1-0.3678794)+inii(-1)*5.602796e-09
depkc=inck(-1)*(-5.602796e-09+1.522998e-08)+inck(-2)*(-1.522998e-08+4.139938e-08)+inck(-3)*(-4.139938e-08+1.125352e-07)+inck(-4)*(-1.125352e-07+3.059023e-07)+inck(-5)*(-3.059023e-07+8.315287e-07)+inck(-6)*(-8.315287e-07+2.260329e-06)+inck(-7)*(-2.260329e-06+6.144212e-06)+inck(-8)*(-6.144212e-06+1.67017e-05)+inck(-9)*(-1.67017e-05+4.539993e-05)+inck(-10)*(-4.539993e-05+0.0001234098)+inck(-11)*(-0.0001234098+0.0003354626)+inck(-12)*(-0.0003354626+0.000911882)+inck(-13)*(-0.000911882+0.002478752)+inck(-14)*(-0.002478752+0.006737947)+inck(-15)*(-0.006737947+0.01831564)+inck(-16)*(-0.01831564+0.04978707)+inck(-17)*(-0.04978707+0.1353353)+inck(-18)*(-0.1353353+0.3678794)+inck(-19)*(1-0.3678794)+inck(-1)*5.602796e-09
depic=inci(-1)*(-5.602796e-09+1.522998e-08)+inci(-2)*(-1.522998e-08+4.139938e-08)+inci(-3)*(-4.139938e-08+1.125352e-07)+inci(-4)*(-1.125352e-07+3.059023e-07)+inci(-5)*(-3.059023e-07+8.315287e-07)+inci(-6)*(-8.315287e-07+2.260329e-06)+inci(-7)*(-2.260329e-06+6.144212e-06)+inci(-8)*(-6.144212e-06+1.67017e-05)+inci(-9)*(-1.67017e-05+4.539993e-05)+inci(-10)*(-4.539993e-05+0.0001234098)+inci(-11)*(-0.0001234098+0.0003354626)+inci(-12)*(-0.0003354626+0.000911882)+inci(-13)*(-0.000911882+0.002478752)+inci(-14)*(-0.002478752+0.006737947)+inci(-15)*(-0.006737947+0.01831564)+inci(-16)*(-0.01831564+0.04978707)+inci(-17)*(-0.04978707+0.1353353)+inci(-18)*(-0.1353353+0.3678794)+inci(-19)*(1-0.3678794)+inci(-1)*5.602796e-09
```
Alternative formulations include:

1. Existing: $\alpha_{-1} = -e^{-n};\>\alpha_\tau =  e^{-(n+\tau)}\left(1 - 1/e\right),\>\tau\in\{-2,\ldots,-n\}$
2. Fixed lifetime: $\alpha_{-n} = 1;\> \alpha_\tau = 0 \text{ for }\tau\in\{-1,\ldots,-n+1\}$
3. Straight-line depreciation: $\alpha_\tau = 1/n$
4. Exponential decay (or perpetual inventory dynamics), $\alpha_\tau=\delta(1-\delta)^{1-\tau},\>n=\infty$

With option #4, it is not necessary to keep track of prior investment, unless the depreciation rate changes.

### Investment
For a sector that is fully established as a going concern, desired investment is the sum of desired capacity expansion plus depreciation. The capacity growth rate in sector $x$ depends on expected capacity utilization $u_x^e$, the real interest rate $\tilde{r}_{lx}$ (deflated by the price of capital goods), leverage $\lambda_x$, and Tobin's _q_, $q_x$,
$$g_x = \eta_{0x} + \eta_1 u_x^e + \eta_2 \tilde{r}_{lx}\lambda_{x,-1} + \eta_3 q_{x,-1}$$
When the innovative capital goods sector first starts, it is not yet established as a going concern, and must set a target capacity expansion rate $\tau$. With checks to make sure the sector is active, the model equations are
```{r}
gk=ifelse(exitk(-1)==0,eta0k+eta1*uke-eta2*rrlk*lambdakprev+eta3*qkprev,0)
gi=ifelse(t>n+1,ifelse(t<=(n+entry),tau,eta0k+eta1*uie-eta2*rrli*lambdaiprev+eta3*qiprev),0)
gc=eta0c+eta1*uce-eta2*rrlc*lambdacprev+eta3*qcprev
eta1 = 0.05
eta2 = 1.25
eta3 = 0.05
eta0c = -0.0358545505516502
eta0k = -0.0364906979595669
```
[*NB:* We could introduce a Minskian element by comparing $\lambda$ to a normal level, which gets looser during a boom.]

*NB: These do not appear in any equations.*
```{r}
eta0i = 0.06
eta3i = 0.01
```

### Consumption goods sector
Investment in the consumption goods sector can come from either innovative or conventional capital. Total real gross investment in terms of equivalent output (`invyc` in the model code) is denoted $i^y_{c,\text{tot}}$. It is given as a multiple of prior period real output plus depreciation of the two types of capital (or zero, if that value is negative),
$$i^y_{c,\text{tot}} = \max\left(g_c y_{c,-1} + \kappa_k d(k_c) + \kappa_i d(i_c),0\right)$$
```{r}
invyc=max(gc*yc(-1)+depkc*prk+depic*pri,0)
```

Investment in either innovative or conventional capital in the consumption goods sector is given by an expression that depends on total desired investment (in terms of productive capacity, $\i^y_{c,\text{tot}}$) and the available supply for sale of innovative ($i_s$) and conventional ($k_s$) capital. Those expressions are
$$i_{c,i} = z_{11}\left[z_{21}i_s + (1 - z_{21})\frac{i^y_{c,\text{tot}}}{\kappa_i}\right] +
(1-z_{11})z_{31}\left[z_{41}i_s + (1 - z_{41})\frac{i^y_{c,\text{tot}} - \kappa_k k_s}{\kappa_i}\right]$$
$$i_{c,k} = z_{11}z_{21}\left[z_{41} k_s + (1-z_{41})\frac{i^y_{c,\text{tot}} - \kappa_i i_s}{\kappa_k}\right] +
(1-z_{11})\left[z_{31}k_s + (1 - z_{31})\frac{i^y_{c,\text{tot}}}{\kappa_k}\right]$$
They only hold if desired investment is positive, which is checked through the logical expression `invyc>0`. This is equal to zero if it is false, and one if it is trye. The model equations are:
```{r}
inci=(invyc>0)*(z11*(z21*is+(1-z21)*invyc/pri)+(1-z11)*z31*(z41*is+(1-z41)*(invyc-ks*prk)/pri))
inck=(invyc>0)*(z11*z21*(z41*ks+(1-z41)*(invyc-is*pri)/prk)+(1-z11)*(z31*ks+(1-z31)*invyc/prk))
```
To see how the factors work it is conventient to multiply the investment expressions above by the corresponding productivities and adding them together. The result is
$$\kappa_i i_{c,i} + \kappa_k i_{c,k} = i^y_{c,\text{tot}} + \left[z_{11}z_{21} + (1-z_{11})z_{31}\right]z_{41}(\kappa_i i_s + \kappa_k k_s - i^y_{c,\text{tot}})$$

The parameters $z_{i1}, i\in \{1,\ldots,4\}$ take on values of either zero or one. They play the following roles:

1. $z_{11}$ is the desired fraction from innovative capital, and is equal to zero if innovative capital is more costsly and one if conventional capital is more costly;
2. $z_{21}$ corrects for $z_{11}$ based on total capital requirements compared to available supply of innovative capital, and is equal to zero if total requirements exceed the available innovative capital and equal to one otherwise;
3. $z_{31}$ corrects for $(1-z_{11})$ based on total capital requirements compared to the available supply of conventional capital, and is equal to zero if total requirements exceed the available conventional capital and equal to one otherswise;
4. $z_{41}$ allows for the possibility that desired capital exceeds the amount available from either innovative or conventional sources.
```{r}
z11=(invyc>0)*(costk>costi)
z21=(invyc>0)*(invyc>is*pri)
z31=(invyc>0)*(invyc>ks*prk)
z41=(invyc>0)*(invyc>is*pri+ks*prk)
```
For $z_{11}$, the cost of buying capital goods is calculated per unit of output; that is, it is the price per unit of capital good divided by capital productivity,
```{r}
costk=pk/prk
costi=pi/pri
```

[*NB:* Consider alternative portfolio choices for `z11`. Also, in principle, cost should be discounted cost over the lifetime of capital. Holding productivity and price fixed, then discounting gives rise to the same factor for each type of capital.]

Next, we show some alternatives.

#### There is sufficient capital of both types ($z_{21} = z_{31} = z_{41} = 0$)
$$i_{c,i} = z_{11}\frac{i^y_{c,\text{tot}}}{\kappa_i}$$
$$i_{c,k} = (1 - z_{11})\frac{i^y_{c,\text{tot}}}{\kappa_k}$$

#### There is sufficient conventional capital but not innovative capital ($z_{21} = 1$, $z_{31} = z_{41} = 0$)
$$i_{c,i} = z_{11}i_s$$
$$i_{c,k} = \frac{i^y_{c,\text{tot}}}{\kappa_k} - z_{11}\frac{\kappa_i}{\kappa_k}i_s$$

#### There is sufficient innovative capital but not conventional capital ($z_{31} = 1$, $z_{21} = z_{41} = 0$)
$$i_{c,i} = \frac{i^y_{c,\text{tot}}}{\kappa_i} - (1-z_{11})\frac{\kappa_k}{\kappa_i}k_s$$
$$i_{c,k} = (1-z_{11})k_s$$

#### There is insufficient capital of either kind ($z_{21} = z_{31} = z_{41} = 1$)
$$i_{c,i} = i_s$$
$$i_{c,k} = k_s$$

### Capital goods sectors
For the capital goods sectors, expected output expansion reflects sales, but the sector must also produce the capital goods it needs for itself in order to produce the capital goods for sale. So, for capital goods sector $x$,
$$\Delta y_{x,\text{self}} = \frac{1}{\kappa_x}g_x y_x \equiv g_{x,x} y_x$$
The relevant model equations are
```{r}
gkk=ifelse(exitk(-1)==0,gk/prk,0)
gii=ifelse(firstPeriodInov,0,gi/pri)
```
*NB: gii does not appear in any equations.*

#### Conventional capital goods sector
Regardless of its plans, the conventional capital goods sector cannot produce more than it is able to with its existing stock of capital. So, $\kappa_k k_{k,-1}$ sets a floor on its own purchases of conventional capital goods. But it will also not invest more than planned, so (as long as it is positive), $g_{k,k} k_{k,-1} + d(k_k)$ also sets a floor on its own purchases of conventional capital goods. This gives the model expression
```{r}
ink=ifelse(exitk(-1)==0,min(kk(-1)*prk,max(0,gkk*kk(-1) + depkk)),0)
```
Of the total amount produced by the conventional capital goods sector, some is used for its own investment needs, while a remainder $k_s$ is sold,
```{r}
ks=ifelse(exitk(-1)==0,kk(-1)*prk-ink,0)
```

Total investment demand for conventional capital goods is given by the sum across sectors,
```{r}
inktot=ink+inck+inik
```

#### Innovative capital goods sector
However, there are constraints on the total available innovative capital during and immediately after the first period in which the innovative capital goods sector enters the market, because they must produce for their own needs as well as for the market. To determine how much of its own ouptut to use for next-period investment ($i_{i,i}$) and how much to sell ($s_i$), the innovative sector identifies a desired market share, $\rho$,
```{r}
rho = 0.03
```
and a productive capacity growth $\tau$,
```{r}
tau = 0.01 
```
Initial-period production is determined by the productivity of conventional capital, and is split between the amount needed for investment goods in the sector and the amount sold. Because the amount of conventional capital in the sector in the first period is the first-period investment, $i_{i,k} = k_i$, this is
$$y_i = \kappa_k i_{i,k} = i_{i,i,+1} + s_i$$
The value of the amount sold is equal to the desired market share multiplied by the expected size of the market, which is calculated as the previous-period value of production of conventional capital goods plus the amount the innovative sector expects to sell, or
$$p_i s_i = \rho\left(p_i s_i + Y_{k,-1}\right)\implies s_i = \frac{1}{p_i}\frac{\rho Y_{k,-1}}{1-\rho}$$
The expression for the price is discussed elsewhere. Production of innovative capital for next-period investment is given by the amount of depreciated conventional capital plus the amount for desired expansion. Using the notation above for the general expression for depreciation,
$$i_{i,i,+1} = \alpha_{-1}i_{i,k} + \frac{\tau y_i}{\kappa_i}$$
Substituting this expression into the one for $y_i$, above and solving for first-period investment in conventional capital gives
$$i_{i,k} = \frac{\kappa_i}{\kappa_k}\frac{s_i}{1 - \tau - \alpha_{-1}(\kappa_i/\kappa_k)} = \frac{\kappa_i}{\kappa_k}\frac{1}{1 - \tau - \alpha_{-1}(\kappa_i/\kappa_k)}\frac{1}{p_i}\frac{\rho Y_{k,-1}}{1-\rho}$$
*NB: This differs from the equation as currently implemented, but I think the units work out.* Here is the current implementation:
$$i_{i,i} = 0,\>i_{i,k} = \frac{\rho \kappa_i Y_{k,-1}}{(1-\rho)p_i\kappa_k(\kappa_i - e^{1-n} - \tau)},\text{ first period}$$
After the initial period, all investment is in innovative capital. The investment function, which says how much the firm wishes to invest, is similar to that for the consumption goods sector, but the sector is constrained by its own production in the previous period, which is $\kappa_i i_{i,-1} + \kappa_k k_{i,-1}$,
$$i_{i,i} = \min\left[\kappa_i i_{i,-1} + \kappa_k k_{i,-1},\frac{1}{\kappa_i}\max\left(g_i y_{i,-1} + \kappa_k d(k_i) + \kappa_i d(i_i),0\right)\right],\>i_{i,k} = 0,\text{ after first period}$$
The sector produces capital goods for itself as well as for sale. The sold component is $i_s$, which is calculated as the difference between total production and the amount needed for own investment.
```{r}
inii=ifelse(firstPeriodInov,0,min(ii(-1)*pri+ki(-1)*prk,max(((gi*yi(-1)+depii*pri+depki*prk)/pri),0)))
inik=ifelse(firstPeriodInov,rho*Yk(-1)*pri/((1-rho)*pi*prk*(pri-exp(1-n)-tau)),0)
is=ifelse(firstPeriodInov,0,ii(-1)*pri+ki(-1)*prk-inii)
```

# Production and pricing
Upper case is nominal, lower case is real.

## Output
```{r}
yk=ifelse(exitk(-1)!=1&inktot>0,ink+inck+inik,0)
Yk=ifelse(exitk(-1)!=1&inktot>0,yk*pk,0)
yi=ifelse(firstPeriodInov,inik*prk,ifelse(t<=(n+entry)&t>(n+1),inii+inci,0)+ifelse(t>(n+entry),inii+inci,0))
Yi=ifelse(t<=(n+entry)&t>(n+1),yi*pi,0)+ifelse(t>(n+entry),yi*pi,0)
yc=cc+cw
Yc=yc*pc
```

## Utilization
```{r}
uc=yc/(kc(-1)*prk +ic(-1)*pri)
uce=yce/(kc(-1)*prk+ic(-1)*pri)
```

```{r}
ui=ifelse(t<=(n+entry)&t>(n+1),yi/(ki(-1)*prk+ii(-1)*pri),0)+ifelse(t>(n+entry),yi/(ki(-1)*prk+ii(-1)*pri),0)
uic1=ifelse(ic(-1)==0,1,0)+ifelse(ic(-1)>0,max(0,min(yc/(pri*ic(-1)),1)),0)
uic=uic1
uice=min(yce/(pri*ic(-1)),1)
uie=ifelse(!firstPeriodInov,ifelse(ii(-1)==0,0,(yie/(ii(-1)*pri+ki(-1)*prk))),0)
uii1=ifelse(t<=(n+entry)&t>(n+1),ifelse(ii(-1)!=0,max(0,min(1,yi/(pri*ii(-1)))),1),ifelse(t>(n+entry),max(0,min(1,yi/(pri*ii(-1)))),0))
uii=ifelse(t<=(n+entry)&t>(n+1),ifelse((inii+inci)!=0,ifelse(ii(-1)==0,1,uii1),0),0)+ifelse(t>(n+entry),ifelse((inii+inci)!=0,uii1,0),0)
uiie=ifelse(!firstPeriodInov,ifelse(ii(-1)==0,1,min(yie/(pri*ii(-1)),1)),0)

```

```{r}
uk=ifelse(exitk(-1)!=1&inktot>0,yk/(kk(-1)*prk),0)
uke=ifelse(exitk(-1)==0,yke/(kk(-1)*prk),0)
ukc=ifelse(kc(-1)==0,1,0)+ifelse(kc(-1)>0,max(0,(yc-uic*pri*ic(-1))/(prk*kc(-1))),0)
ukce=min((yce-uice*pri*ic(-1))/(prk*kc(-1)),1)
uki=ifelse(t>(n+1),ifelse((inii+inci)==0,0,ifelse(ki(-1)==0,0,max(0,(yi-uii*pri*ii(-1))/(prk*ki(-1))))),0)
ukie=ifelse(!firstPeriodInov,ifelse(ki(-1)==0,0,min((yie-uiie*pri*ii(-1))/(prk*ki(-1)),1)),0)
ukk=ifelse(exitk(-1)!=1&inktot>0,yk/(prk*kk(-1)),0)
ukke=ifelse(exitk(-1)==0,yke/(prk*kk(-1)),0)
```

## Labor-capital ratio
```{r}
lambdac=Lc/(kc*pk + ic*pi)
lambdacprev=(lambdac(-4)+lambdac(-3)+lambdac(-2)+lambdac(-1))/4
lambdai=ifelse(ki!=0|ii!=0,Li/(ki*pk + ii*pi),0)
lambdaiprev=(lambdai(-4)+lambdai(-3)+lambdai(-2)+lambdai(-1))/4
lambdak=ifelse(exitk(-1)==0,Lk/(kk*pk),0)
lambdakprev=(lambdak(-4)+lambdak(-3)+lambdak(-2)+lambdak(-1))/4
```

## Goods prices and the markup
Prices are set via a target-return markup. Both prices themselves and expectations play a role.
$$p_c = p_{c,-1} + \zeta*\left[\left(1 + \phi_c\right)*\text{NUCc} - p_{c,-1}\right]$$

### Markup
```{r}
phii=ifelse(firstPeriodInov,riT*pk/(NUCi*prk),ifelse(NUCi==0|yie==0,0,riT*(pk(-1)*ki(-1)+pi(-1)*ii(-1))/(NUCi*yie)))
phic=rcT*(pk(-1)*kc(-1) +pi(-1)*ic(-1))/(NUCc*yce)
phik=ifelse(exitk(-1)==0,rkT*(pk(-1)*kk(-1))/(UCke*yke),0)
```

Target return on capital:
```{r}
rcT = 0.096
riT = 0.096
rkT = 0.096
```


### Prices
```{r}
pc=pc(-1)+zeta*((1+phic)*NUCc-pc(-1))
pi=ifelse(firstPeriodInov,(1+phii)*NUCi,pi(-1)+zeta*((1+phii)*NUCi-pi(-1)))
pk=ifelse(exitk(-1)==0,pk(-1)+zeta*((1+phik)*NUCk-pk(-1)),0)
zeta = 0.1
```

```{r}
UCk=ifelse(exitk(-1)!=1&inktot>0,Wk/(prk*lk),0)
UCke=ifelse(exitk(-1)==0,Wk(-1)/(prk*lk),0)
UCi=ifelse(t<=(n+entry)&t>(n+1),ifelse((inii+inci)!=0,Wi*(uii*ii(-1)*lk+uki*ki(-1)*li)/((uki*prk*ki(-1) +uii*pri*ii(-1))*li*lk),0),0)+ifelse(t>(n+entry),ifelse((inii+inci)!=0,Wi*(uii*ii(-1)*lk+uki*ki(-1)*li)/((uki*prk*ki(-1)+uii*pri*ii(-1))*li*lk),0),0)
UCie=ifelse(firstPeriodInov,Wi/(prk*lk),ifelse(ki(-1)==0&ii(-1)==0,0,Wi(-1)*(uiie*ii(-1)*lk+ukie*ki(-1)*li)/((ukie*prk*ki(-1)+uiie*pri*ii(-1))*li*lk)))
UCc=Wc*(uic*ic(-1)*lk+ukc*kc(-1)*li)/((ukc*prk*kc(-1) +uic*pri*ic(-1))*li*lk)
UCce=Wc(-1)*(uice*ic(-1)*lk+ukce*kc(-1)*li)/((ukce*prk*kc(-1)+uice*pri*ic(-1))*li*lk)
```

```{r}
NUCk = ifelse(exitk(-1)==0,NUCk(-1)+zeta*(UCke-NUCk(-1)),0)
NUCi=ifelse(firstPeriodInov,UCie,NUCi(-1)+zeta*(UCie-NUCi(-1)))
NUCc=NUCc(-1)+zeta*(UCce-NUCc(-1))
```

### Inflation rate
There are conditionals depending on whether we're in the conventional capital-dominated environment or the innovative one, but in general
$$\pi = \frac{p - p_{-1}}{p_{-1}}$$

```{r}
pic=(pc-pc(-1))/pc(-1)
pii=ifelse(pi(-1)==0,0,(pi-pi(-1))/pi(-1))
pik=ifelse(exitk(-1)==0,(pk-pk(-1))/pk(-1),0)
picki=(kc(-1)*pik + ic(-1)*pii)/(kc(-1)+ ic(-1))
```

# Private investment

## Expected real return
Expected real returns on money are denoted by $RR_m$ and on investment in sector $x$ by $RR_x$. Cash does not yield any return, so for initial holdings $M$, the real return is
$$ RR_m = \frac{1}{M}\left(\frac{M}{1+\pi_c} - M\right) = \frac{-\pi_c}{1 + \pi_c}$$
In this expression, $\pi_c$ is the inflation rate for consumption goods. In the model,
```{r}
RRm=-pic/(1+pic)
```
Expected real return rate on equity holdings of sector stock is calculated as a weighted sum of expectations on real capital gains $cg_x^e$, real dividends $r_x^e$ and real profit rate $rg^e$, computed relative to the sector previous period market capitalization,
$$RR_x = \chi_\text{div}\left(\frac{1 + r_x^e}{1 + \pi_c} - 1\right)
			 + \chi_\text{prof}\left(\frac{1 + rg_x^e}{1 + \pi_c} - 1\right)
			 + \chi_\text{gains}\left(\frac{1 + cg_x^e}{1 + \pi_c} - 1\right)$$
The coefficients take the following values
$$(\chi_\text{div},\chi_\text{prof},\chi_\text{gains}) = \left\{\begin{array}{cc}
(\chi_1,\chi_1,\chi_{1b}), & cg_x^e \neq 0 \\
(\chi_{1a},\chi_{1a},0), & cg_x^e = 0
\end{array}\right.$$

[*NB:* Should the condition be $cg_x^e \leq 0$?]

```{r}
RRc=ifelse(round(cgce,digit=6)==0,chi1a*((rce+1)/(1+pic)-1)+chi1a*((1+rcge)/(1+pic)-1),(chi1b*((1+cgce)/(1+pic)-1)+chi1*((1+rce)/(1+pic)-1)+chi1*((1+rcge)/(1+pic)-1)))
RRk=ifelse(yk!=0&Fk>=0,ifelse(round(cgke,digit=6)==0,chi1a*((rke+1)/(1+pic)-1)+chi1a*((1+rkge)/(1+pic)-1),(chi1b*((1+cgke)/(1+pic)-1)+chi1*((1+rke)/(1+pic)-1)+chi1*((1+rkge)/(1+pic)-1))),0)
RRi=ifelse(ei>0,ifelse(round(cgie,digit=6)==0,chi1a*((rie+1)/(1+pic)-1)+chi1a*((1+rige)/(1+pic)-1),(chi1b*((1+cgie)/(1+pic)-1)+chi1*((1+rie)/(1+pic)-1)+chi1*((1+rige)/(1+pic)-1))),0)
chi1a= 0.333333333333333 
chi1= 0.375 
chi1b= 0.25 
```

## Equity prices
```{r}
pce=ifelse(exitk(-1)==1,lambda20*Vece/ec +(lambda21*RRm+lambda22*RRc+lambda23*RRi)*Vece/ec,ifelse(ei==0,lambda20*Vece/ec +(lambda21*RRm+lambda22*RRc+lambda23*RRk)*Vece/ec,lambda20a*Vece/ec+(lambda21a*RRm+lambda22a*RRc+lambda23a*RRk+lambda24a*RRi)*Vece/ec))
pie=ifelse(exitk(-1)==1,lambda30*Vece/ei+(lambda31*RRm+lambda32*RRc+lambda33*RRi)*Vece/ei,ifelse(ei>0,lambda40a*Vece/ei+(lambda41a*RRm+lambda42a*RRc+lambda43a*RRk+lambda44a*RRi)*Vece/ei,0))
pke=ifelse(exitk(-1)==1,0,ifelse(ei==0,lambda30*Vece/ek +(lambda31*RRm+lambda32*RRc+lambda33*RRk)*Vece/ek,lambda30a*Vece/ek+(lambda31a*RRm+lambda32a*RRc+lambda33a*RRk+lambda34a*RRi)*Vece/ek))
```

## Asset allocation
```{r}
lambda20=templambda20*(1-lambda10)
lambda30=1-lambda20-lambda10
lambda20a= ifelse(exitk(-1)==0,ifelse(ei==0,0,ifelse(lambda20a(-1)==0,(kc*prk+ic*pri-irrational2*(kk*prk+kc*prk+ic*pri+ii*pri+ki*prk))*(1-lambda10a-irrational3)/(kc*prk+ic*prk+ki*prk+ii*pri+kk*prk+ii*pri+ki*prk),irrational*lambda20a(-1)+(1-irrational)*(kc*prk+ic*pri-irrational2*(kk*prk+kc*prk+ic*pri))*(1-lambda10a-irrational3)/(kc*prk+ic*prk+ki*prk+ii*pri+kk*prk))),0)
lambda30a= ifelse(exitk(-1)==0,ifelse(ei==0,0,ifelse(lambda30a(-1)==0,(kk*prk+irrational2*(kk*prk+kc*prk+ic*pri+ii*pri+ki*prk))*(1-lambda10a-irrational3)/(kc*prk+ic*prk+ki*prk+ii*pri+kk*prk+ii*pri+ki*prk),irrational*lambda30a(-1)+(1-irrational)*(kk*prk+irrational2*(kk*prk+kc*prk+ic*pri))*(1-lambda10a-irrational3)/(kc*prk+ic*prk+ki*prk+ii*pri+kk*prk))),0)
lambda40a=1-(lambda20a+lambda30a+lambda10a)
irrational = 0
irrational2 = 0
irrational3 = 0.08
```

```{r}
lambda10s= 0.1 
lambda10= 0.1 
lambda11= 0.314447689133754 
lambda12= -0.104815896377918 
lambda13= -0.104815896377918 
lambda21= -0.104815896377918 
lambda22= 0.157223844566877 
lambda23= -0.0524079481889591 
lambda31= -0.104815896377918 
lambda32= -0.0524079481889591 
lambda33= 0.157223844566877 
lambda10a= 0.1 
lambda11a= 0.314447689133754 
lambda12a= -0.104815896377918 
lambda13a= -0.104815896377918 
lambda14a= -0.104815896377918 
lambda21a= -0.104815896377918 
lambda22a= 0.157223844566877 
lambda23a= -0.0262039740944795 
lambda24a= -0.0262039740944795 
lambda31a= -0.104815896377918 
lambda32a= -0.0262039740944795 
lambda33a= 0.0786119222834386 
lambda34a= -0.0262039740944795 
lambda41a= -0.104815896377918 
lambda42a= -0.0262039740944795 
lambda43a= -0.0262039740944795 
lambda44a= 0.157223844566877 
```


```{r}
McDf=ifelse(exitk(-1)==1,lambda10*Vece +(lambda11*RRm+lambda12*RRc+lambda13*RRi)*Vece,ifelse(ei==0,lambda10*Vece +(lambda11*RRm+lambda12*RRc+lambda13*RRk)*Vece,lambda10a*Vece +(lambda11a*RRm+lambda12a*RRc+lambda13a*RRk+lambda14a*RRi)*Vece))
```

## Tobin's _q_
```{r}
qc= (ec*pce)/(pk*kc +pi*ic )
qcprev=(qc(-4)+qc(-3)+qc(-2)+qc(-1))/4
qk=ifelse(yk!=0&Fk>=0,(ek*pke)/(pk*kk),0)
qkprev=(qk(-4)+qk(-3)+qk(-2)+qk(-1))/4
qi=ifelse((ki==0&ii==0)|ei==0,1,(ei*pie)/(pk*ki +pi*ii))
qiprev=(qi(-4)+qi(-3)+qi(-2)+qi(-1))/4
```

## Returns

```{r}
rc=Fc/(kc(-1)*pk(-1)+ic(-1)*pi(-1))
rca=ifelse(sumkc>0,(Fc(-5)+Fc(-4)+Fc(-3)+Fc(-2)+Fc(-1))/sumkc,0)
rcge=Fce/(ec(-1)*pce(-1))
rce=FDce/(ec(-1)*pce(-1))
```

```{r}
ri=ifelse(t<=(n+entry)&t>(n+1),Fi/(ki(-1)*pk(-1)+ii(-1)*pi(-1)),0)+ifelse(t>(n+entry),Fi/(ki(-1)*pk(-1)+ii(-1)*pi(-1)),0)
ria=ifelse(sumki>0,(Fi(-5)+Fi(-4)+Fi(-3)+Fi(-2)+Fi(-1))/sumki,0)
rige=ifelse(t>=(n+entry),ifelse(pie(-1)==0,Fie/(ki(-1)*pk(-1)+ii(-1)*pi(-1)),Fie/(ei(-1)*pie(-1))),0)
rie=ifelse(t>=(n+entry),ifelse(pie(-1)==0,FDie/(ki(-1)*pk(-1)+ii(-1)*pi(-1)),FDie/(ei(-1)*pie(-1))),0)
```

```{r}
rk=ifelse(exitk(-1)!=1&inktot>0,Fk/(kk(-1)*pk(-1)),0)
rka=ifelse(sumkk>0,(Fk(-5)+Fk(-4)+Fk(-3)+Fk(-2)+Fk(-1))/sumkk,0)
rke=ifelse(exitk(-1)!=1,FDke/(ek(-1)*pke(-1)),0)
rkge=ifelse(exitk(-1)!=1,Fke/(ek(-1)*pke(-1)),0)
```

```{r}
rlc=rl*(1+1/(1 +exp(kappa*(rca-rb))))
rlk=ifelse(exitk(-1)==0,rl*(1+1/(1+exp(kappa*(rka-rb)))),0)
rli=rl*(1+1/(1 +exp(kappa*(ria-rb))))
rb = 0.073
rl= 0.03
kappa= 51.282297394055 
```



```{r}
rrlc=(1+rlc)/(1+picki)-1
rrli=ifelse(firstPeriodInov,0,ifelse(pii==0,0,(1+rli)/(1+pii)-1))
rrlk=ifelse(exitk(-1)==0,(1+rlk)/(1+pik(-1))-1,0)
```

# REMAINING
```{r}
back= 4 
cc= 20.7391256748857 
Cc= 2874.05212427902 
CG=0 
cgc=0 
CGc=0 
cgce=0 
CGce=0 
CGcgr=ifelse(CGc(-2)==0,0,(CGc(-1)-CGc(-2))/CGc(-2))
CGcmean=mean(c(CGc(-4),CGc(-3),CGc(-2),CGc(-1)))
cgi=0 
CGi=0 
cgie=0 
CGie=0 
CGigr=ifelse(CGi(-2)==0,0,(CGi(-1)-CGi(-2))/CGi(-2))
CGimean=mean(c(CGi(-4),CGi(-3),CGi(-2),CGi(-1)))
cgk=0 
CGk=0 
CGke=0 
cgke=0 
CGkgr=ifelse(CGk(-2)==0,0,(CGk(-1)-CGk(-2))/CGk(-2))
CGkmean=mean(c(CGk(-4),CGk(-3),CGk(-2),CGk(-1)))
costi=0 
costk= 461.937204961247 
cs= 109.809767734018 
cw= 67.1086885123286 
Cw= 9300 
depic=0 
depii=0 
depkc= 18.8501452246901 
depki=0 
depkk= 5.1498547753099 
ec= 100 
ecss= 100 
ei=0 
ek= 50 
ekss= 50 
esc=0 
esi=0 
esk=0 
exitk= 0 
Fc= 4388.55836892066 
Fce= 4388.55836892066 
Fcgr=ifelse(Fc(-2)==0,0,(Fc(-1)-Fc(-2))/Fc(-2))
Fcmean=mean(c(Fc(-4),Fc(-3),Fc(-2),Fc(-1)))
FDb= 612.488625491348 
FDbe= 612.488625491348 
FDbgr=ifelse(FDb(-2)==0,0,(FDb(-1)-FDb(-2))/FDb(-2))
FDbmean=mean(c(FDb(-4),FDb(-3),FDb(-2),FDb(-1)))
FDc= 1776.28334945858 
FDce= 1776.28334945858 
FDcgr=ifelse(FDc(-2)==0,0,(FDc(-1)-FDc(-2))/FDc(-2))
FDcmean=mean(c(FDc(-4),FDc(-3),FDc(-2),FDc(-1)))
FDi=0 
FDie=0 
FDigr=ifelse(FDi(-2)==0,0,(FDi(-1)-FDi(-2))/FDi(-2))
FDimean=mean(c(FDi(-4),FDi(-3),FDi(-2),FDi(-1)))
FDk= 485.280149329097 
FDke= 485.280149329097 
FDkgr=ifelse(FDk(-2)==0,0,(FDk(-1)-FDk(-2))/FDk(-2))
FDkmean=mean(c(FDk(-4),FDk(-3),FDk(-2),FDk(-1)))
Fi=0 
Fie=0 
Figr=ifelse(Fi(-2)==0,0,(Fi(-1)-Fi(-2))/Fi(-2))
Fimean=mean(c(Fi(-4),Fi(-3),Fi(-2),Fi(-1)))
Fk= 1198.95300558799 
Fke= 1198.95300558799 
Fkgr=ifelse(Fk(-2)==0,0,(Fk(-1)-Fk(-2))/Fk(-2))
Fkmean=mean(c(Fk(-4),Fk(-3),Fk(-2),Fk(-1)))
gc=0 
gi=0 
gii=0 
gk=0 
gkk=0 
Ic= 2612.27501946208 
ic=0 
Ifc=0 
Ifi=0 
Ifk=0 
ii=0 
Ii=0 
Ik= 713.672856258896 
inci=0 
inck= 18.8501452246901 
inii=0 
inik=0 
ink= 5.1498547753099 
is=0 
kc= 366.032559113393 
ki=0 
kk= 100 
ks= 24.8501452246901 
kstock= 100 
lambda20= 0.706880445925879 
lambda20a= 0.706880445925879 
lambda30= 0.193119554074121 
lambda30a= 0.193119554074121 
lambda40a= 0 
lambdac= 0.237092371157942 
lambdai=0 
lambdak= 0.237092371157938 
Lc= 12026.5620197737 
Ld= 15312.2156372837 
Li=0 
Lk= 3285.65361750998 
Mc= 1362.21563728371 
McD= 862.215637283706 
McDf= 500 
McDfss= 500 
Mi=0 
Ms= 15312.2156372837 
Mw= 13950 
Nc= 730.443127456741 
Ni=0 
Nk= 199.556872543259 
Ntot= 930 
NUCc= 83.1486968930244 
NUCi=0 
NUCk= 83.1486968930244 
omegaTc= 0.0721598801207834 
omegaTi= 0 
omegaTk= 0.0721598801207834 
pc= 138.581161488374 
pce= 78.2098554787589 
phic= 0.666666666666667 
phii=0 
phik= 0.666666666666667 
pi=0 
pic=0 
picki=0 
pie=0 
pii=0 
pik=0 
pk= 138.581161488374 
pke= 46.2601462391299 
psic=0 
psii=0 
psik=0 
qc= 0.154183382190946 
qi=0 
qk= 0.166906330349276 
rc= 0.0865163051536825 
rca= 0.0865163051536825 
rce= 0.227117584936722 
REc= 2612.27501946208 
REi=0 
REk= 713.672856258896 
ri=0 
ria=0 
rie=0 
rk= 0.0865163051536825 
rka= 0.0865163051536825 
rke= 0.209804848787363 
rlc= 0.04 
rlcss= 0.04 
rli=0 
rlk= 0.04 
rlkss= 0.04 
RRc= 0.26274786302576 
RRi=0 
RRk= 0.242719099389336 
rrlc= 0.04 
rrli=0 
rrlk= 0.04 
sumkc=pk(-5)*kc(-5)+pi(-5)*ic(-5)+pk(-4)*kc(-4)+pi(-4)*ic(-4)+pk(-3)*kc(-3)+pi(-3)*ic(-3)+pk(-2)*kc(-2)+pi(-2)*ic(-2)+pk(-1)*kc(-1)+pi(-1)*ic(-1)
sumki=pk(-5)*ki(-5)+pi(-5)*ii(-5)+pk(-4)*ki(-4)+pi(-4)*ii(-4)+pk(-3)*ki(-3)+pi(-3)*ii(-3)+pk(-2)*ki(-2)+pi(-2)*ii(-2)+pk(-1)*ki(-1)+pi(-1)*ii(-1)
sumkk=pk(-5)*kk(-5)+pk(-4)*kk(-4)+pk(-3)*kk(-3)+pk(-2)*kk(-2)+pk(-1)*kk(-1)
t=0 
templambda20=ifelse(yk==0|Fk<0,(kc*prk+ic*pri)/(kc*prk+ic*prk+ki*prk+ii*pri),ifelse(ei==0,(kc*prk+ic*pri)/(kc*prk+ic*prk+kk*prk),0))

u= 0.07 
uc= 0.8 
UCc= 83.1486968930244 
UCce= 83.1486968930244 
uce= 0.8 
UCi=0 
UCie=0 
UCk= 83.1486968930244 
UCke= 83.1486968930244 
ui=0 
uic=0 
uice=0 
uie=0 
uii=0 
uiie=0 
uk= 0.8 
ukc= 0.8 
ukce= 0.8 
uke= 0.8 
uki=0 
ukie=0 
ukk= 0.8 
ukke= 0.8 
uTc= 0.8 
uTi= 0.8 
uTk= 0.8 
Vc= 11496.2084971161 
vc= 82.9565026995428 
Vce= 11496.2084971161 
Vec= 10633.9928598324 
Vece= 10633.9928598324 
vw= 100.663032768493 
Vw= 13950 
wage= 10 
Wc= 10 
Wi=0 
Wk= 10 
ws= 0.6 
xiw1= 0.7 
xiw2= 0.2 
Yc= 12174.052124279 
yc= 87.8478141872143 
yce= 87.8478141872143 
yce=yc(-1)+epsilon*(yce(-1)-yc(-1))
ydc= 20.7391256748857 
YDc= 2874.05212427902 
ydce= 20.7391256748857 
YDce= 2874.05212427902 
ydw= 67.1086885123286 
YDw= 9300 
ydw=YDw/pc-pic*Vw(-1)/pc
ydwe= 67.1086885123286 
YDwe= 9300 
YDwgr=ifelse(YDw(-2)==0,0,(YDw(-1)-YDw(-2))/YDw(-2))
YDwmean=mean(c(YDw(-4),YDw(-3),YDw(-2),YDw(-1)))
Yi=0 
yi=0 
yie=0 
yie=ifelse(!firstPeriodInov,yi(-1)+epsilon*(yie(-1)-yi(-1)),0)
yk= 24 
Yk= 3325.94787572098 
yke= 24 
yke=ifelse(exitk(-1)==0,yk(-1)+epsilon*(yke(-1)-yk(-1)),0)
YPc= 2874.05212427902 
YPce= 2874.05212427902 
```
