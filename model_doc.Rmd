---
title: "Stranded Assets Model Documentation"
author: "Green Macro Team"
date: "PUT DATE HERE"
output:
  html_document:
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction
This is a working document that relates the stranded assets formal model ("the model") with its implementation using the R package PK-SFC ("the code"). Note the following generic notation used in the code:

* `varname` + `e`: an expected future value
* `varname` + `mean`: a running average of historical values
* `varname` + `gr`: the prior one-period growth rate
* `varname` + `k`, `i`, `c` or `b`: sector-specific variables:
	+ `k`: conventional capital
	+ `i`: innovative capital
	+ `c`: consumption goods
	+ `b`: banks

In the equations below, the `mean` is indicated by an overbar, where the average is taken over the previous four periods. For an arbitrary variable $x$,
$$\bar{x} \equiv \frac{1}{4}\sum_{t=-4}^{-1} x_t$$
The growth rate `gr` is indicated a "hat". For an abitrary variable $x$,
$$\hat{x} \equiv \frac{x - x_{-1}}{x_{-1}}$$

# Time and transition
Time is tracked by a variable $t$, which increments by one in each time step,
```{r eval=FALSE}
t=t(-1)+1
```

The innovative sector enters after time step $n$,
```{r eval=FALSE}
n = 20
firstPeriodInov=(t==(n+1))
```

Investors exit the conventional capital goods sector as soon as either: a) production goes to zero; b) dividends paid by the sector go to zero,
```{r eval=FALSE}
exitk=ifelse(exitk(-1)==1,1,ifelse(yk==0|Fk<0,1,0))
```

**There is a further time, not clear to me, after which there appears to be a new type of money holding**, $M_i$.
```{r eval=FALSE}
entry = 20
```

The loan period is given by `nLoans`,
```{r eval=FALSE}
nLoans 5
```


# Parameters

Is this labor productivity, $\ell_k$, $\ell_l$?
```{r eval=FALSE}
lk= 0.400888222893241 
li= 0.400888222893241 
```

```{r eval=FALSE}
chi1a= 0.333333333333333 
chi1= 0.375 
chi1b= 0.25 
```


```{r eval=FALSE}
Omega0= 0.3 
Omega1= 0.1 
Omega2= 0.220964898869873 
Omega3= 0.5 
```

If $\eta$ is nonzero then historical growth is taken into account when agents form their expectations:
```{r eval=FALSE}
eta = 0
```


```{r eval=FALSE}
eta = 0
eta0i = 0.06
eta3i = 0.01
eta1 = 0.05
eta2 = 1.25
eta3 = 0.05
eta0c = -0.0358545505516502
eta0k = -0.0364906979595669
```

```{r eval=FALSE}
rb = 0.073
```

```{r eval=FALSE}
rho = 0.03
```

```{r eval=FALSE}
rcT = riT = rkT = 0.096
```


```{r eval=FALSE}
irrational = 0
irrational2 = 0
irrational3 = 0.08
```

```{r eval=FALSE}
kappa= 51.282297394055 
```

```{r eval=FALSE}
lambda10s= 0.1 
lambda10= 0.1 
lambda11= 0.314447689133754 
lambda12= -0.104815896377918 
lambda13= -0.104815896377918 
lambda21= -0.104815896377918 
lambda22= 0.157223844566877 
lambda23= -0.0524079481889591 
lambda31= -0.104815896377918 
lambda32= -0.0524079481889591 
lambda33= 0.157223844566877 
lambda10a= 0.1 
lambda11a= 0.314447689133754 
lambda12a= -0.104815896377918 
lambda13a= -0.104815896377918 
lambda14a= -0.104815896377918 
lambda21a= -0.104815896377918 
lambda22a= 0.157223844566877 
lambda23a= -0.0262039740944795 
lambda24a= -0.0262039740944795 
lambda31a= -0.104815896377918 
lambda32a= -0.0262039740944795 
lambda33a= 0.0786119222834386 
lambda34a= -0.0262039740944795 
lambda41a= -0.104815896377918 
lambda42a= -0.0262039740944795 
lambda43a= -0.0262039740944795 
lambda44a= 0.157223844566877 
```

```{r eval=FALSE}
pri = 0.33
prk = 0.3
```

```{r eval=FALSE}
tau = 0.01 
```

```{r eval=FALSE}
theta = 0.25
```

```{r eval=FALSE}
rl= 0.03
```

```{r eval=FALSE}
xic1 = 0.6
xic2 = 0.1
```

```{r eval=FALSE}
zeta = 0.1
```

# Model equations

## Wealth
```{r eval=FALSE}
Vce=Vc(-1) + YDce - Cc
Vc=Vc(-1) + (YDc-Cc)
vc=Vc/pc
Vw=Vw(-1)+(YDw-Cw)
vw=Vw/pc
Vec=pce*ec+pke*ek +pie*ei +McDf
Vece=Vce-McD
```

## Wages
```{r eval=FALSE}
Wc=Wc(-1) + Omega3*(omegaTc(-1) - Wc(-1)/pc(-1))
Wk=ifelse(exitk(-1)==0,Wk(-1) + Omega3*(omegaTk(-1) - Wk(-1)/pc(-1)),0)
Wi=ifelse(t<=(n+1),Wk(-1),Wi(-1) + Omega3*(omegaTi(-1) - Wi(-1)/pc(-1)))
```

## Profits and dividends
The basic profit equation is the value of output, less the wage bill, less payments on loans held in the previous period. For a sector $s$,
$$F_s = Y_S - W_sN_s - r_{ls}L_{s,-1}$$
In the capital goods sectors this expression is modified in the following ways:

* In the conventional capital goods sectors, if there is investment in the sector and firms have not exited the sector then it pays dividends, else dividends are zero;
* In the innovative sector, there are two conditions, **but they contain the same equations**, so effectively after innovative capital is introduced the sector begins to pay dividends

```{r eval=FALSE}
Fc=Yc-Wc*Nc-rlc*Lc(-1)
Fi=ifelse(t<=(n+entry)&t>(n+1),Yi-Wi*Ni-rli*Li(-1),0)+ifelse(t>(n+entry),Yi-Wi*Ni-rli*Li(-1),0)
Fk=ifelse(exitk(-1)!=1&inktot>0,Yk-Wk*Nk-rlk*Lk(-1),0)
```

The basic equation for expected profits in sector $s$ is given by an adaptive expectations model in which both historical growth and the accuracy of past forecasts influence the result,
$$F_s^e = \left(1 + \eta\hat{F}_s\right)\bar{F}_s + \nu\left(F_{s,-1} - F^e_{s,-1}\right),\>\nu=0.25$$
The exception is for the conventional capital goods sector, where dividends go to zero after "exit"
```{r eval=FALSE}
Fce=Fcmean+Fcmean*Fcgr*eta+nu*(Fc(-1)-Fce(-1))
Fie=Fimean+Fimean*Figr*eta+nu*(Fi(-1)- Fie(-1))
Fke=ifelse(exitk(-1)!=1,Fkmean+Fkmean*Fkgr*eta+nu*(Fk(-1)-Fke(-1)),0)
nu = 0.25 
```

Dividends are distributed to capitalists from productive sectors and the banking sector. For productive sectors, the basic expression for dividends is profits $F_s$ less autonomous investment $I_s$, as long as the result is positive. For an arbitrary sector $s$,
$$FD_s = \max\left(F_s - I_s\right)$$
This is then modified to take into account the introduction of innovative capital, as well as a correction for money holdings after "entry". For that last consideration, if previous period money held by the innovative sector (??), $M_{i,-1}$, plus profits is more than sufficient to pay dividends then they will be paid, otherwise they won't. 
```{r eval=FALSE}
FDi=ifelse(t<=(n+entry)&t>(n+1),max(Fi-Ii,0),0)+ifelse(t>(n+entry),ifelse(Ii-Fi-Mi(-1)<=0,max(Fi-Ii,0),0),0)
FDc=max(Fc-Ic,0)
FDk=ifelse(exitk(-1)!=1&inktot>0,max(Fk-Ik,0),0)
```

Banks have zero net worth, so they pay out their income from loan repayments as dividends. However, if the conventional capital goods sector goes bankrupt then banks must write off the loans, which is a loss that offsets income from loan payments,
```{r eval=FALSE}
FDb= rlc*Lc(-1) +ifelse(yk!=0&Fk>=0,rlk*Lk(-1),-Lk(-1)) + rli*Li(-1)
```

Expectations are set, as for other variables, by an adaptive expectations model,
$$FD_s^e = \left(1 + \eta\widehat{FD}_s\right)\overline{FD}_s + \chi\left(FD_{s,-1} - FD^e_{s,-1}\right),\>\chi=0.25$$
Expected dividends for the conventional capital goods sector are zero after "exit",
```{r eval=FALSE}
FDbe= FDbmean+FDbmean*FDbgr*eta+chi*(FDb(-1)- FDbe(-1))
FDie= FDimean+FDimean*FDigr*eta+chi*(FDi(-1)-FDie(-1))
FDce=FDcmean+FDcmean*FDcgr*eta+chi*(FDc(-1)-FDce(-1))
FDke=ifelse(exitk(-1)!=1,FDkmean+FDkmean*FDkgr*eta+chi*(FDk(-1)-FDke(-1)),0)
chi = 0.25 
```

### Additional variables
Retained profits are calculated as the difference between total profits and dividends as `REk`, `REi`, `REc`,
```{r eval=FALSE}
REk=ifelse(exitk(-1)!=1&inktot>0,Fk-FDk,0)
REi=ifelse(t<=(n+entry)&t>(n+1),Fi-FDi,0)+ifelse(t>(n+entry),Fi-FDi,0)
REc=Fc-FDc
```

The excess of investment over profits, if it is positive, is stored in convenience variables `Ifk`, `Ifi`, `Ifc`.
```{r eval=FALSE}
Ifk=ifelse(exitk(-1)!=1&inktot>0,max(Ik-Fk,0),0)
Ifi=ifelse(t<=(n+entry)&t>(n+1),max(Ii-Fi,0),0)+ifelse(t>(n+entry),max(Ii-Fi-Mi(-1),0),0)+ifelse(t==(n+1),Ii,0)
Ifc=max(Ic-Fc,0)
```


## Consumption
There are two consumer classes in the model, wage and profit earners. Real consumption by wage earners is $c_w$ and by capitalists is $c_c$. These are calculated in stages. First, _planned_ consumption is calculated for both classes as a function of disposable income and previous-period wealth,
$$c_{w1} = \xi_{w1}y_{dw}^e + \xi_{w2}v_{w,-1}$$
$$c_{c0} = \xi_{c1}y_{dc}^e + \xi_{c2}v_{c,-1}$$
```{r eval=FALSE}
cw1= xiw1*ydwe + xiw2*vw(-1)
cc0=xic1*ydce+xic2*vc(-1)
```
Next, because capitalists' income can be negative, planned consumption is set to zero in case the calculation above gives a negative result,
$$c_{c1} = \frac{1}{2}\left(c_{c0} + |c_{c0}|\right) = \max\left(0,c_{c0}\right)$$
```{r eval=FALSE}
cc1=(cc0+abs(cc0))/2
```
(**Does that make sense? They must have some minimal level of consumption, and if this is their only source of income then they have to go further into debt to pay for it**)

It is possible that planned consumption exceeds the capacity of the economy to produce consumption goods. Denote capital productivity of conventional capital goods by $\kappa_k$ (in the code it is `prk`) and innovative capital goods by $\kappa_i$ (`pri` in the code). Then, denoting real capital stocks $k_c$ and $i_c$ in the consumption goods sector, real output of consumption goods $c_s$ from the previous period is
$$c_s = k_{c,-1}\kappa_k + i_{c,-1}\kappa_i$$
Excess production of consumption goods over planned consumption is $x_1$ (`exc1` in the code),
$$x_1 = c_s - c_{w1} - c_{c1}$$
This might be negative, in which case actual consumption must be less than planned. The deficit (a negative number, if it is exists) is given by a variable $x_2$ (`exc2` in the code),
$$x_2 = \frac{1}{2}\left(x_1 - |x_1|\right)$$
```{r eval=FALSE}
cs=kc(-1)*prk+ic(-1)*pri
exc1=cs-cw1-cc1
exc2=(exc1-abs(exc1))/2
```
The deficit is then shared by wage earners and capitalists in proportion to their income,
$$c_w = c_{w1}+\frac{c_{w1}}{c_{w1} + c_{c1}}x_2$$
$$c_c = c_{c1}+\frac{c_{c1}}{c_{w1} + c_{c1}}x_2$$
```{r eval=FALSE}
cw=cw1+cw1/(cw1+cc1)*exc2
cc=cc1+cc1/(cw1+cc1)*exc2
```

Once real consumption has been calculated, it is converted to nominal values using the price of consumption goods:
```{r eval=FALSE}
Cw=cw*pc
Cc=cc*pc
```

### Wage earners' disposable income
Nominal disposable income for wage earners is given by the sum of wages from all three sectors:
$$YD_w = W_cN_c + W_kN_k + W_iN_i$$
```{r eval=FALSE}
YDw=Wc*Nc+Wk*Nk+Wi*Ni
```
Expected nominal income in the next period is given by an adaptive expectations model in which wage-earners' base expectation incorporates some proportion of growth during the previous period, adjusted by a term proportional to the previous-period error. Using a bar for an average, and a hat to indicate to a growth rate,
$$YD_w^e = \left(1 + \eta\widehat{YD}_w\right)\overline{YD}_w + \epsilon \left(YD_{w,-1}-YD_{w,-1}^e\right),\>\epsilon=0.25$$
Then the expected change in real income is given by two terms, one a deflated version of their nominal income expectations, the second a correction of nominal wealth for price inflation of consumption goods,
$$yd_w^e = \frac{1}{p_c}\left(YD_w^e - \pi_c V_{w,-1}\right)$$
```{r eval=FALSE}
YDwe= YDwmean+YDwmean*YDwgr*eta+epsilon*(YDw(-1)-YDwe(-1))
ydwe= YDwe/pc-(pic*Vw(-1))/pc
epsilon = 0.25
```

### Capitalists' disposable income
Disposable income for capitalists is given by the sum of profit income and capital gains,
$$YD_c = YP_c + CG$$
```{r eval=FALSE}
YDc=YPc + CG
```
As for wage income, the purchasing power of capitalists' nominal wealth is corrected for inflation in the price of consumption goods,
```{r eval=FALSE}
ydc=YDc/pc - pic*Vc(-1)/pc
```

Also, expected real and nominal income is calculated similar to that for wage-earners, except that expectations are in terms of dividends and capital gains,
```{r eval=FALSE}
YDce1=YPce + CGce+CGke+CGie
YDce=(YDce1+abs(YDce1))/2
ydce=YDce/pc-(pic*Vc(-1))/pc
```

Profit income is given by dividends $FD_s$ from different sectors $s=\{c,k,b,i\}$,
$$YP_c = FD_c + FD_k + FD_b + FD_i$$
An equivalent sum applies to expected values of these variables,
```{r eval=FALSE}
YPc=FDc+FDk+FDb+FDi
YPce=FDce+FDke+FDie+FDbe
```

Capital gains are determined by the change in the expected price per share in different sectors multiplied by the number of shares $e_j$ held in the previous period,
$$CG = \sum_{j\in \{c,k,i\}} e_{j,-1}\Delta p_j^e$$
There is a special consideration in the first period in which shares are held in the innovative sector,
```{r eval=FALSE}
CG = ifelse(ei(-1)==0&ei>0,ec(-1)*(pce-pce(-1))+ek(-1)*(pke-pke(-1)),ec(-1)*(pce-pce(-1))+ek(-1)*(pke-pke(-1))+ ei(-1)*(pie-pie(-1)))
```
In terms of individual sectors, capital gains are given by the terms in the sum above, but with some conditions. For the conventional capital sector, capital gains are zero if real output has gone to zero, while for the innovative sector it is necessary to catch discontinuities when it is first introduced.

**Isn't this a bit contradictary? E.g., shouldn't CG be the sum of CGc, CGk, and CGi?**

```{r eval=FALSE}
CGc=ec(-1)*(pce-pce(-1))
CGk=ifelse(yk!=0,ek(-1)*(pke-pke(-1)),0)
CGi=ifelse(ei(-1)!=0&pie(-1)!=0,ei(-1)*(pie-pie(-1)),0)
```
Real capital gains are given by the price of holdings, which is the product of price per share and the number of shares held, with some checks for whether innovative capital has been introduced or not,
```{r eval=FALSE}
cgc=CGc/(pce(-1)*ec(-1))
cgk=ifelse(yk!=0&Fk>=0,CGk/(pke(-1)*ek(-1)),0)
cgi=ifelse(ei(-1)!=0&pie(-1)!=0,CGi/(pie(-1)*ei(-1)),0)
```

Expected capital gains is given by an adaptive expectations model as used elsewhere. For sector $s$,
$$CG_s^e = \left(1 + \eta\widehat{CG}_s\right)\overline{CG}_s + \theta \left(CG_{s,-1}-CG_{s,-1}^e\right),\>\theta=0.25$$
```{r eval=FALSE}
CGce= CGcmean+CGcmean*CGcgr*eta+theta*(CGc(-1)-CGce(-1))
CGke=ifelse(exitk(-1)!=1,CGkmean+CGkmean*CGkgr*eta+theta*(CGk(-1)-CGke(-1)),0)
CGie =CGimean+CGimean*CGigr*eta+theta*(CGi(-1)-CGie(-1))
```
Real expected capital gains are deflated by the same price as for observed capital gains,
```{r eval=FALSE}
cgce = CGce/(ec(-1)*pce(-1))
cgke=ifelse(exitk(-1)!=1,CGke/(ek(-1)*pke(-1)),0)
cgie=ifelse(t<(n+1),ifelse(ei(-1)==0|pie(-1)==0,0,(CGie/(ei(-1)*pie(-1)))),0)
```

## Money and banking
Total money in the system is $M_s$, the sum of money held by wage-earners, $M_w$, capitalists, $M_c$, **and an additional term after "entry"** $M_i$.
```{r eval=FALSE}
Ms=Mw+Mc+Mi
```
For wage earners, their money holdings constitute their wealth (their money in the bank) (**what about pensions?**),
```{r eval=FALSE}
Mw=Vw
```
Capitalists wish to hold money both for transactions (money for consumption, $M_c^D$) and as a store of wealth (money for finance, $M_c^{D,f}$). For transactions purposes, capitalists' desired money holdings are given as a fraction $\beta$ of nominal consumption,
$$M_c^D = \beta C_c,\>\beta=0.3$$
```{r eval=FALSE}
McD=beta*Cc
beta = 0.3
```
Actual holdings of cash are given by the difference between nominal wealth $V_c$ and wealth held as equities $V_{ec}$,
$$M_c = V_c - V_{ec} \left(+ M_c^{D,f}\right)$$
**Is this equation correct? Why is `McDf` there? It seems like double-counting**
```{r eval=FALSE}
Mc=McDf+Vc -Vec
```

# I GOT THIS FAR
```{r eval=FALSE}
McDf=ifelse(exitk(-1)==1,lambda10*Vece +(lambda11*RRm+lambda12*RRc+lambda13*RRi)*Vece,ifelse(ei==0,lambda10*Vece +(lambda11*RRm+lambda12*RRc+lambda13*RRk)*Vece,lambda10a*Vece +(lambda11a*RRm+lambda12a*RRc+lambda13a*RRk+lambda14a*RRi)*Vece))
Mileft=Mi(-1)+Fi+esi*pie-Ii-FDi
Mi=max(Mileft-Li(-1)/nLoans,0)

Vece=Vce-McD
```

### Loans
```{r eval=FALSE}
Lc=Lc(-1)+Ifc-esc*pce
Lk=ifelse(yk!=0&Fk>=0,Lk(-1)+Ifk-esk*pke,0)
Ld=Lc+Lk+Li
Li=Li(-1)-min(Li(-1)/nLoans,Mileft)
```
---

---
## Labor
$$N_c\,,N_i\,,N_k$$
$$N_\text{tot} = N_c + N_i + N_k$$
```{r eval=FALSE}
Nc=uic*ic(-1)/li + ukc*kc(-1)/lk
Ni=ifelse(t<=(n+entry)&t>(n+1),ifelse((inii+inci)!=0,uii*ii(-1)/li + uki*ki(-1)/lk,0),0)+ifelse(t>(n+entry),ifelse((inii+inci)!=0,uii*ii(-1)/li+uki*ki(-1)/lk,0),0)
Nk=ifelse(exitk(-1)!=1&inktot>0,ukk*kk(-1)/lk,0)
Ntot=Nc+Nk+Ni
```
---

## $\Omega$ and related
```{r eval=FALSE}
omegaTc=Omega0+Omega1*log(Aprc)+ Omega2*log(Ntot/LF)
omegaTk=ifelse(exitk(-1)!=1&Nk>0,Omega0+Omega1*log(Aprk)+Omega2*log(Ntot/LF),0)
omegaTi=Omega0+Omega1*log(Apri)+Omega2*log(Ntot/LF)
```

```{r eval=FALSE}
Aprc=yc/Nc
Apri=ifelse(Ni>0,yi/Ni,0.001)
Aprk=ifelse(exitk(-1)!=1&Nk>0,yk/Nk,0)
```

```{r eval=FALSE}
LF = 1000
```

## $\Psi$ and related
```{r eval=FALSE}
Psik=ifelse(exitk(-1)!=1&inktot>0,1/(1+exp(psik*(rkT-cgk(-1)-rlk))),0)
Psii=0+(t>(n+entry))*(1/(1+exp(psii*(riT-cgi(-1)-rli))))
Psic=1/(1+exp(psic*(rcT-cgc(-1)-rlc)))
```

## RR and related
```{r eval=FALSE}
RRm=-pic/(1+pic)
RRc=ifelse(round(cgce,digit=6)==0,chi1a*((rce+1)/(1+pic)-1)+chi1a*((1+rcge)/(1+pic)-1),(chi1b*((1+cgce)/(1+pic)-1)+chi1*((1+rce)/(1+pic)-1)+chi1*((1+rcge)/(1+pic)-1)))
RRk=ifelse(yk!=0&Fk>=0,ifelse(round(cgke,digit=6)==0,chi1a*((rke+1)/(1+pic)-1)+chi1a*((1+rkge)/(1+pic)-1),(chi1b*((1+cgke)/(1+pic)-1)+chi1*((1+rke)/(1+pic)-1)+chi1*((1+rkge)/(1+pic)-1))),0)
RRi=ifelse(ei>0,ifelse(round(cgie,digit=6)==0,chi1a*((rie+1)/(1+pic)-1)+chi1a*((1+rige)/(1+pic)-1),(chi1b*((1+cgie)/(1+pic)-1)+chi1*((1+rie)/(1+pic)-1)+chi1*((1+rige)/(1+pic)-1))),0)
```

## Utilization
```{r eval=FALSE}
UCk=ifelse(exitk(-1)!=1&inktot>0,Wk/(prk*lk),0)
UCke=ifelse(exitk(-1)==0,Wk(-1)/(prk*lk),0)
UCi=ifelse(t<=(n+entry)&t>(n+1),ifelse((inii+inci)!=0,Wi*(uii*ii(-1)*lk+uki*ki(-1)*li)/((uki*prk*ki(-1) +uii*pri*ii(-1))*li*lk),0),0)+ifelse(t>(n+entry),ifelse((inii+inci)!=0,Wi*(uii*ii(-1)*lk+uki*ki(-1)*li)/((uki*prk*ki(-1)+uii*pri*ii(-1))*li*lk),0),0)
UCie=ifelse(firstPeriodInov,Wi/(prk*lk),ifelse(ki(-1)==0&ii(-1)==0,0,Wi(-1)*(uiie*ii(-1)*lk+ukie*ki(-1)*li)/((ukie*prk*ki(-1)+uiie*pri*ii(-1))*li*lk)))
UCc=Wc*(uic*ic(-1)*lk+ukc*kc(-1)*li)/((ukc*prk*kc(-1) +uic*pri*ic(-1))*li*lk)
UCce=Wc(-1)*(uice*ic(-1)*lk+ukce*kc(-1)*li)/((ukce*prk*kc(-1)+uice*pri*ic(-1))*li*lk)
```

```{r eval=FALSE}
NUCk = ifelse(exitk(-1)==0,NUCk(-1)+zeta*(UCke-NUCk(-1)),0)
NUCi=ifelse(firstPeriodInov,UCie,NUCi(-1)+zeta*(UCie-NUCi(-1)))
NUCc=NUCc(-1)+zeta*(UCce-NUCc(-1))
```

## Output and income
Upper case is nominal, lower case is real.

### Output
```{r eval=FALSE}
yk=ifelse(exitk(-1)!=1&inktot>0,ink+inck+inik,0)
Yk=ifelse(exitk(-1)!=1&inktot>0,yk*pk,0)
yi=ifelse(firstPeriodInov,inik*prk,ifelse(t<=(n+entry)&t>(n+1),inii+inci,0)+ifelse(t>(n+entry),inii+inci,0))
Yi=ifelse(t<=(n+entry)&t>(n+1),yi*pi,0)+ifelse(t>(n+entry),yi*pi,0)
yc=cc+cw
Yc=yc*pc
```

## Cost and related
```{r eval=FALSE}
costk=pk/prk
costi=pi/pri
```

## ec, esc and related
```{r eval=FALSE}
esc=(Psic*Ifc)/pce(-1)
ec=ec(-1)+esc
esk=ifelse(exitk(-1)!=1&inktot>0,(Psik*Ifk)/pke(-1),0)
ek=ek(-1)+esk
esi=ifelse(t>(n+entry),(psii*Ifi)/pie(-1),ifelse(t==(n+entry),100,0))
ei=ifelse(t<=(n+entry)&t>(n+1),ei(-1)+esi,0)+ifelse(t>(n+entry),ei(-1)+esi,0)
```

## gk, gi, etc.
```{r eval=FALSE}
gk=ifelse(exitk(-1)==0,eta0k+eta1*uke-eta2*rrlk*lambdakprev+eta3*qkprev,0)
gkk=ifelse(exitk(-1)==0,gk/prk,0)
gi=ifelse(t>n+1,ifelse(t<=(n+entry),tau,eta0k+eta1*uie-eta2*rrli*lambdaiprev+eta3*qiprev),0)
gii=ifelse(firstPeriodInov,0,gi/pri)
gc=eta0c+eta1*uce-eta2*rrlc*lambdacprev+eta3*qcprev
```

## Capital and investment

### Capital stock dynamics
```{r eval=FALSE}
kc=kc(-1)+inck-depkc
ki=ifelse(firstPeriodInov,inik,ki(-1)-depki)
kk=ifelse(exitk(-1)==0,kk(-1)+ink-depkk,0)
ks=ifelse(exitk(-1)==0,kk(-1)*prk-ink,0)
```

### Investment
```{r eval=FALSE}
inci=(invyc>0)*(z11*(z21*is+(1-z21)*invyc/pri)+(1-z11)*z31*(z41*is+(1-z41)*(invyc-ks*prk)/pri))
inck=(invyc>0)*(z11*z21*(z41*ks+(1-z41)*(invyc-is*pri)/prk)+(1-z11)*(z31*ks+(1-z31)*invyc/prk))
Ic=inck*pk+inci*pi
ic=ic(-1)+inci-depic
inii=ifelse(firstPeriodInov,0,min(ii(-1)*pri+ki(-1)*prk,max(((gi*yi(-1)+depii*pri+depki*prk)/pri),0)))
inik=ifelse(firstPeriodInov,rho*Yk(-1)*pri/((1-rho)*pi*prk*(pri-exp(1-n)-tau)),0)
Ii=ifelse(firstPeriodInov,inik*pk,inii*pi)
is=ifelse(firstPeriodInov,0,ii(-1)*pri+ki(-1)*prk-inii)
ii=ifelse(firstPeriodInov,0,ii(-1)-depii+inii)
ink=ifelse(exitk(-1)==0,min(kk(-1)*prk,max(0,gkk*kk(-1) + depkk)),0)
Ik=ifelse(exitk(-1)==0, ink*pk,0)
inktot=ink+inck+inik
```

```{r eval=FALSE}
invyc=max(gc*yc(-1)+depkc*prk+depic*pri,0)
```

### Depreciation
```{r eval=FALSE}
depkk=ink(-1)*(-5.602796e-09+1.522998e-08)+ink(-2)*(-1.522998e-08+4.139938e-08)+ink(-3)*(-4.139938e-08+1.125352e-07)+ink(-4)*(-1.125352e-07+3.059023e-07)+ink(-5)*(-3.059023e-07+8.315287e-07)+ink(-6)*(-8.315287e-07+2.260329e-06)+ink(-7)*(-2.260329e-06+6.144212e-06)+ink(-8)*(-6.144212e-06+1.67017e-05)+ink(-9)*(-1.67017e-05+4.539993e-05)+ink(-10)*(-4.539993e-05+0.0001234098)+ink(-11)*(-0.0001234098+0.0003354626)+ink(-12)*(-0.0003354626+0.000911882)+ink(-13)*(-0.000911882+0.002478752)+ink(-14)*(-0.002478752+0.006737947)+ink(-15)*(-0.006737947+0.01831564)+ink(-16)*(-0.01831564+0.04978707)+ink(-17)*(-0.04978707+0.1353353)+ink(-18)*(-0.1353353+0.3678794)+ink(-19)*(1-0.3678794)+ink(-1)*5.602796e-09
depki=inik(-1)*(-5.602796e-09+1.522998e-08)+inik(-2)*(-1.522998e-08+4.139938e-08)+inik(-3)*(-4.139938e-08+1.125352e-07)+inik(-4)*(-1.125352e-07+3.059023e-07)+inik(-5)*(-3.059023e-07+8.315287e-07)+inik(-6)*(-8.315287e-07+2.260329e-06)+inik(-7)*(-2.260329e-06+6.144212e-06)+inik(-8)*(-6.144212e-06+1.67017e-05)+inik(-9)*(-1.67017e-05+4.539993e-05)+inik(-10)*(-4.539993e-05+0.0001234098)+inik(-11)*(-0.0001234098+0.0003354626)+inik(-12)*(-0.0003354626+0.000911882)+inik(-13)*(-0.000911882+0.002478752)+inik(-14)*(-0.002478752+0.006737947)+inik(-15)*(-0.006737947+0.01831564)+inik(-16)*(-0.01831564+0.04978707)+inik(-17)*(-0.04978707+0.1353353)+inik(-18)*(-0.1353353+0.3678794)+inik(-19)*(1-0.3678794)+inik(-1)*5.602796e-09
depii=inii(-1)*(-5.602796e-09+1.522998e-08)+inii(-2)*(-1.522998e-08+4.139938e-08)+inii(-3)*(-4.139938e-08+1.125352e-07)+inii(-4)*(-1.125352e-07+3.059023e-07)+inii(-5)*(-3.059023e-07+8.315287e-07)+inii(-6)*(-8.315287e-07+2.260329e-06)+inii(-7)*(-2.260329e-06+6.144212e-06)+inii(-8)*(-6.144212e-06+1.67017e-05)+inii(-9)*(-1.67017e-05+4.539993e-05)+inii(-10)*(-4.539993e-05+0.0001234098)+inii(-11)*(-0.0001234098+0.0003354626)+inii(-12)*(-0.0003354626+0.000911882)+inii(-13)*(-0.000911882+0.002478752)+inii(-14)*(-0.002478752+0.006737947)+inii(-15)*(-0.006737947+0.01831564)+inii(-16)*(-0.01831564+0.04978707)+inii(-17)*(-0.04978707+0.1353353)+inii(-18)*(-0.1353353+0.3678794)+inii(-19)*(1-0.3678794)+inii(-1)*5.602796e-09
depkc=inck(-1)*(-5.602796e-09+1.522998e-08)+inck(-2)*(-1.522998e-08+4.139938e-08)+inck(-3)*(-4.139938e-08+1.125352e-07)+inck(-4)*(-1.125352e-07+3.059023e-07)+inck(-5)*(-3.059023e-07+8.315287e-07)+inck(-6)*(-8.315287e-07+2.260329e-06)+inck(-7)*(-2.260329e-06+6.144212e-06)+inck(-8)*(-6.144212e-06+1.67017e-05)+inck(-9)*(-1.67017e-05+4.539993e-05)+inck(-10)*(-4.539993e-05+0.0001234098)+inck(-11)*(-0.0001234098+0.0003354626)+inck(-12)*(-0.0003354626+0.000911882)+inck(-13)*(-0.000911882+0.002478752)+inck(-14)*(-0.002478752+0.006737947)+inck(-15)*(-0.006737947+0.01831564)+inck(-16)*(-0.01831564+0.04978707)+inck(-17)*(-0.04978707+0.1353353)+inck(-18)*(-0.1353353+0.3678794)+inck(-19)*(1-0.3678794)+inck(-1)*5.602796e-09
depic=inci(-1)*(-5.602796e-09+1.522998e-08)+inci(-2)*(-1.522998e-08+4.139938e-08)+inci(-3)*(-4.139938e-08+1.125352e-07)+inci(-4)*(-1.125352e-07+3.059023e-07)+inci(-5)*(-3.059023e-07+8.315287e-07)+inci(-6)*(-8.315287e-07+2.260329e-06)+inci(-7)*(-2.260329e-06+6.144212e-06)+inci(-8)*(-6.144212e-06+1.67017e-05)+inci(-9)*(-1.67017e-05+4.539993e-05)+inci(-10)*(-4.539993e-05+0.0001234098)+inci(-11)*(-0.0001234098+0.0003354626)+inci(-12)*(-0.0003354626+0.000911882)+inci(-13)*(-0.000911882+0.002478752)+inci(-14)*(-0.002478752+0.006737947)+inci(-15)*(-0.006737947+0.01831564)+inci(-16)*(-0.01831564+0.04978707)+inci(-17)*(-0.04978707+0.1353353)+inci(-18)*(-0.1353353+0.3678794)+inci(-19)*(1-0.3678794)+inci(-1)*5.602796e-09

```

## Asset allocation
```{r eval=FALSE}
lambda20=templambda20*(1-lambda10)
lambda30=1-lambda20-lambda10
lambda20a= ifelse(exitk(-1)==0,ifelse(ei==0,0,ifelse(lambda20a(-1)==0,(kc*prk+ic*pri-irrational2*(kk*prk+kc*prk+ic*pri+ii*pri+ki*prk))*(1-lambda10a-irrational3)/(kc*prk+ic*prk+ki*prk+ii*pri+kk*prk+ii*pri+ki*prk),irrational*lambda20a(-1)+(1-irrational)*(kc*prk+ic*pri-irrational2*(kk*prk+kc*prk+ic*pri))*(1-lambda10a-irrational3)/(kc*prk+ic*prk+ki*prk+ii*pri+kk*prk))),0)
lambda30a= ifelse(exitk(-1)==0,ifelse(ei==0,0,ifelse(lambda30a(-1)==0,(kk*prk+irrational2*(kk*prk+kc*prk+ic*pri+ii*pri+ki*prk))*(1-lambda10a-irrational3)/(kc*prk+ic*prk+ki*prk+ii*pri+kk*prk+ii*pri+ki*prk),irrational*lambda30a(-1)+(1-irrational)*(kk*prk+irrational2*(kk*prk+kc*prk+ic*pri))*(1-lambda10a-irrational3)/(kc*prk+ic*prk+ki*prk+ii*pri+kk*prk))),0)
lambda40a=1-(lambda20a+lambda30a+lambda10a)
```

## Labor-capital ratio
```{r eval=FALSE}
lambdac=Lc/(kc*pk + ic*pi)
lambdacprev=(lambdac(-4)+lambdac(-3)+lambdac(-2)+lambdac(-1))/4
lambdai=ifelse(ki!=0|ii!=0,Li/(ki*pk + ii*pi),0)
lambdaiprev=(lambdai(-4)+lambdai(-3)+lambdai(-2)+lambdai(-1))/4
lambdak=ifelse(exitk(-1)==0,Lk/(kk*pk),0)
lambdakprev=(lambdak(-4)+lambdak(-3)+lambdak(-2)+lambdak(-1))/4
```

## Prices
Prices are set via a target-return markup. Both prices themselves and expectations play a role.
$$p_c = p_{c,-1} + \zeta*\left[\left(1 + \phi_c\right)*\text{NUCc} - p_{c,-1}\right]$$

```{r eval=FALSE}
pc=pc(-1)+zeta*((1+phic)*NUCc-pc(-1))
pce=ifelse(exitk(-1)==1,lambda20*Vece/ec +(lambda21*RRm+lambda22*RRc+lambda23*RRi)*Vece/ec,ifelse(ei==0,lambda20*Vece/ec +(lambda21*RRm+lambda22*RRc+lambda23*RRk)*Vece/ec,lambda20a*Vece/ec+(lambda21a*RRm+lambda22a*RRc+lambda23a*RRk+lambda24a*RRi)*Vece/ec))
pi=ifelse(firstPeriodInov,(1+phii)*NUCi,pi(-1)+zeta*((1+phii)*NUCi-pi(-1)))
pie=ifelse(exitk(-1)==1,lambda30*Vece/ei+(lambda31*RRm+lambda32*RRc+lambda33*RRi)*Vece/ei,ifelse(ei>0,lambda40a*Vece/ei+(lambda41a*RRm+lambda42a*RRc+lambda43a*RRk+lambda44a*RRi)*Vece/ei,0))
pk=ifelse(exitk(-1)==0,pk(-1)+zeta*((1+phik)*NUCk-pk(-1)),0)
pke=ifelse(exitk(-1)==1,0,ifelse(ei==0,lambda30*Vece/ek +(lambda31*RRm+lambda32*RRc+lambda33*RRk)*Vece/ek,lambda30a*Vece/ek+(lambda31a*RRm+lambda32a*RRc+lambda33a*RRk+lambda34a*RRi)*Vece/ek))
```

## Inflation rate
There are conditionals depending on whether we're in the conventional capital-dominated environment or the innovative one, but in general
$$\pi = \frac{p - p_{-1}}{p_{-1}}$$

```{r eval=FALSE}
pic=(pc-pc(-1))/pc(-1)
pii=ifelse(pi(-1)==0,0,(pi-pi(-1))/pi(-1))
pik=ifelse(exitk(-1)==0,(pk-pk(-1))/pk(-1),0)
picki=(kc(-1)*pik + ic(-1)*pii)/(kc(-1)+ ic(-1))
```

### Markup
```{r eval=FALSE}
phii=ifelse(firstPeriodInov,riT*pk/(NUCi*prk),ifelse(NUCi==0|yie==0,0,riT*(pk(-1)*ki(-1)+pi(-1)*ii(-1))/(NUCi*yie)))
phic=rcT*(pk(-1)*kc(-1) +pi(-1)*ic(-1))/(NUCc*yce)
phik=ifelse(exitk(-1)==0,rkT*(pk(-1)*kk(-1))/(UCke*yke),0)
```

## psi's
```{r eval=FALSE}
psic = psii = psik = 0

```

## q's
```{r eval=FALSE}
qc= (ec*pce)/(pk*kc +pi*ic )
qcprev=(qc(-4)+qc(-3)+qc(-2)+qc(-1))/4
qk=ifelse(yk!=0&Fk>=0,(ek*pke)/(pk*kk),0)
qkprev=(qk(-4)+qk(-3)+qk(-2)+qk(-1))/4
qi=ifelse((ki==0&ii==0)|ei==0,1,(ei*pie)/(pk*ki +pi*ii))
qiprev=(qi(-4)+qi(-3)+qi(-2)+qi(-1))/4
```

## Returns

```{r eval=FALSE}
rc=Fc/(kc(-1)*pk(-1)+ic(-1)*pi(-1))
rca=ifelse(sumkc>0,(Fc(-5)+Fc(-4)+Fc(-3)+Fc(-2)+Fc(-1))/sumkc,0)
rcge=Fce/(ec(-1)*pce(-1))
rce=FDce/(ec(-1)*pce(-1))
```

```{r eval=FALSE}
ri=ifelse(t<=(n+entry)&t>(n+1),Fi/(ki(-1)*pk(-1)+ii(-1)*pi(-1)),0)+ifelse(t>(n+entry),Fi/(ki(-1)*pk(-1)+ii(-1)*pi(-1)),0)
ria=ifelse(sumki>0,(Fi(-5)+Fi(-4)+Fi(-3)+Fi(-2)+Fi(-1))/sumki,0)
rige=ifelse(t>=(n+entry),ifelse(pie(-1)==0,Fie/(ki(-1)*pk(-1)+ii(-1)*pi(-1)),Fie/(ei(-1)*pie(-1))),0)
rie=ifelse(t>=(n+entry),ifelse(pie(-1)==0,FDie/(ki(-1)*pk(-1)+ii(-1)*pi(-1)),FDie/(ei(-1)*pie(-1))),0)
```

```{r eval=FALSE}
rk=ifelse(exitk(-1)!=1&inktot>0,Fk/(kk(-1)*pk(-1)),0)
rka=ifelse(sumkk>0,(Fk(-5)+Fk(-4)+Fk(-3)+Fk(-2)+Fk(-1))/sumkk,0)
rke=ifelse(exitk(-1)!=1,FDke/(ek(-1)*pke(-1)),0)
rkge=ifelse(exitk(-1)!=1,Fke/(ek(-1)*pke(-1)),0)
```

```{r eval=FALSE}
rlc=rl*(1+1/(1 +exp(kappa*(rca-rb))))
rlk=ifelse(exitk(-1)==0,rl*(1+1/(1+exp(kappa*(rka-rb)))),0)
rli=rl*(1+1/(1 +exp(kappa*(ria-rb))))
```

```{r eval=FALSE}
rrlc=(1+rlc)/(1+picki)-1
rrli=ifelse(firstPeriodInov,0,ifelse(pii==0,0,(1+rli)/(1+pii)-1))
rrlk=ifelse(exitk(-1)==0,(1+rlk)/(1+pik(-1))-1,0)
```

## u's
```{r eval=FALSE}
uc=yc/(kc(-1)*prk +ic(-1)*pri)
uce=yce/(kc(-1)*prk+ic(-1)*pri)
```

```{r eval=FALSE}
ui=ifelse(t<=(n+entry)&t>(n+1),yi/(ki(-1)*prk+ii(-1)*pri),0)+ifelse(t>(n+entry),yi/(ki(-1)*prk+ii(-1)*pri),0)
uic1=ifelse(ic(-1)==0,1,0)+ifelse(ic(-1)>0,max(0,min(yc/(pri*ic(-1)),1)),0)
uic=uic1
uice=min(yce/(pri*ic(-1)),1)
uie=ifelse(!firstPeriodInov,ifelse(ii(-1)==0,0,(yie/(ii(-1)*pri+ki(-1)*prk))),0)
uii1=ifelse(t<=(n+entry)&t>(n+1),ifelse(ii(-1)!=0,max(0,min(1,yi/(pri*ii(-1)))),1),ifelse(t>(n+entry),max(0,min(1,yi/(pri*ii(-1)))),0))
uii=ifelse(t<=(n+entry)&t>(n+1),ifelse((inii+inci)!=0,ifelse(ii(-1)==0,1,uii1),0),0)+ifelse(t>(n+entry),ifelse((inii+inci)!=0,uii1,0),0)
uiie=ifelse(!firstPeriodInov,ifelse(ii(-1)==0,1,min(yie/(pri*ii(-1)),1)),0)

```

```{r eval=FALSE}
uk=ifelse(exitk(-1)!=1&inktot>0,yk/(kk(-1)*prk),0)
uke=ifelse(exitk(-1)==0,yke/(kk(-1)*prk),0)
ukc=ifelse(kc(-1)==0,1,0)+ifelse(kc(-1)>0,max(0,(yc-uic*pri*ic(-1))/(prk*kc(-1))),0)
ukce=min((yce-uice*pri*ic(-1))/(prk*kc(-1)),1)
uki=ifelse(t>(n+1),ifelse((inii+inci)==0,0,ifelse(ki(-1)==0,0,max(0,(yi-uii*pri*ii(-1))/(prk*ki(-1))))),0)
ukie=ifelse(!firstPeriodInov,ifelse(ki(-1)==0,0,min((yie-uiie*pri*ii(-1))/(prk*ki(-1)),1)),0)
ukk=ifelse(exitk(-1)!=1&inktot>0,yk/(prk*kk(-1)),0)
ukke=ifelse(exitk(-1)==0,yke/(prk*kk(-1)),0)
```

## z's
```{r eval=FALSE}
z11=(invyc>0)*(costk>costi)
z21=(invyc>0)*(invyc>is*pri)
z31=(invyc>0)*(invyc>ks*prk)
z41=(invyc>0)*(invyc>is*pri+ks*prk)
```
